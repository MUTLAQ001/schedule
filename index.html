<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <!-- ... (نفس محتوى الـ head) ... -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>استوديو الجداول الذكي</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        /* ... (نفس محتوى الـ style) ... */
    </style>
</head>
<body class="dark">
    <!-- ... (نفس محتوى الـ body HTML) ... -->

    <script>
    // ... (نفس مكتبة LZString وبداية الكود) ...

    document.addEventListener('DOMContentLoaded', function() {
        // ... (نفس تعريفات المتغيرات) ...

        // =================================================================
        // معالجة وعرض بيانات المقررات
        // =================================================================

        function processAndDisplayData(courses) {
            allCoursesData = courses.map((section, index) => ({
                ...section,
                uniqueId: `${section.code}-${section.section}-${index}`,
                timeSlots: parseTimeEntries(section.time),
                // examPeriod سيتم إضافته تلقائيًا من البيانات الجديدة
                examSlot: section.finalExam ? parseFinalExam(section.finalExam) : null
            }));
            groupedCourses = allCoursesData.reduce((acc, course) => {
                if (!acc[course.code]) {
                    acc[course.code] = { name: course.name, code: course.code, sections: [] };
                }
                acc[course.code].sections.push(course);
                return acc;
            }, {});
            renderCoursesList();
            populateSettingsModal();
        }
        
        // ... (نفس دالة renderCoursesList) ...

        // =================================================================
        // منطق اختيار الشعب والتعارضات - مع التحديث
        // =================================================================

        function handleSectionClick(btnElement) {
            const uniqueId = btnElement.dataset.uniqueId;
            if (selectedSections.has(uniqueId)) {
                deselectSection(uniqueId);
            } else if (!btnElement.classList.contains('conflicted')) {
                selectSection(uniqueId);
            }
            updateCalendarAndConflicts();
        }

        function selectSection(uniqueId) {
            selectedSections.add(uniqueId);
            document.querySelector(`.section-btn[data-unique-id='${uniqueId}']`)?.classList.add('selected');
        }
        
        function deselectSection(uniqueId) {
            selectedSections.delete(uniqueId);
            document.querySelector(`.section-btn[data-unique-id='${uniqueId}']`)?.classList.remove('selected');
        }
        
        // --- START: التحسين - تحديث شامل لدالة التعارضات ---
        function updateCalendarAndConflicts() {
            // 1. جمع أوقات المحاضرات وفترات الاختبارات للمواد المختارة
            const currentScheduleSlots = [];
            const selectedExamPeriods = new Set();
            
            selectedSections.forEach(id => {
                const section = allCoursesData.find(c => c.uniqueId === id);
                if (section) {
                    currentScheduleSlots.push(...section.timeSlots);
                    // أضف فترة الاختبار إذا كانت موجودة ولها قيمة
                    if (section.examPeriod && section.examPeriod !== "0" && section.examPeriod !== null) {
                        selectedExamPeriods.add(section.examPeriod);
                    }
                }
            });

            // 2. التحقق من التعارضات لكل شعبة غير مختارة
            allCoursesData.forEach(section => {
                const btn = document.querySelector(`.section-btn[data-unique-id='${section.uniqueId}']`);
                if (!btn || selectedSections.has(section.uniqueId)) return;

                // التحقق من تعارض الوقت
                const isTimeConflicted = section.timeSlots.length > 0 && section.timeSlots.some(slot => 
                    currentScheduleSlots.some(scheduleSlot => 
                        slot.day === scheduleSlot.day && slot.start < scheduleSlot.end && slot.end > scheduleSlot.start
                    )
                );

                // التحقق من تعارض فترة الاختبار
                const isExamConflicted = section.examPeriod && section.examPeriod !== "0" && selectedExamPeriods.has(section.examPeriod);

                const isConflicted = isTimeConflicted || isExamConflicted;

                // تحديث واجهة المستخدم (الزر)
                btn.classList.toggle('conflicted', isConflicted);
                btn.title = ''; // مسح العنوان القديم
                btn.querySelector('.conflict-icon')?.remove();

                if (isConflicted) {
                    const icon = document.createElement('i');
                    icon.className = 'ri-error-warning-fill conflict-icon';
                    btn.appendChild(icon);
                    // تحديد سبب التعارض في العنوان
                    if (isTimeConflicted && isExamConflicted) {
                        btn.title = 'تعارض في وقت المحاضرة والاختبار النهائي';
                    } else if (isTimeConflicted) {
                        btn.title = 'تعارض في وقت المحاضرة';
                    } else if (isExamConflicted) {
                        btn.title = 'تعارض في فترة الاختبار النهائي';
                    }
                }
            });

            // 3. تحديث التقويم بالأحداث المختارة
            calendar.removeAllEvents();
            const allEvents = [];
            selectedSections.forEach(id => {
                const section = allCoursesData.find(c => c.uniqueId === id);
                if (section) {
                    const group = groupedCourses[section.code];
                    allEvents.push(...createEventsForSection(section, group.color));
                    if (section.examSlot) {
                        allEvents.push(createExamEventForSection(section));
                    }
                }
            });
            calendar.addEventSource(allEvents);
        }
        // --- END: التحسين ---
        
        // ... (بقية الدوال تبقى كما هي بدون تغيير) ...
    });
    </script>
</body>
</html>
