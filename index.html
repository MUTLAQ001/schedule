<!DOCTYPE html>
<html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>QU Schedule</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
        <meta name="theme-color" content="#0a0a0a">
        <style>
            :root {
                --color-primary: #8b5cf6;
                --color-primary-dark: #7c3aed;
                --color-danger: #ff5252;
                --color-warning: #ffc400;
                --color-success: #00c853;
                --color-bg: #0a0a0a;
                --color-card: rgba(20, 20, 22, 0.75);
                --color-border: rgba(255, 255, 255, 0.1);
                --color-text: #e0e0e0;
                --color-text-muted: #9e9e9e;
                --color-text-dark: #ffffff;
                --font-body: "Cairo", sans-serif;
                --font-title: "IBM Plex Sans Arabic", sans-serif;
                --radius: 20px;
                --radius-md: 16px;
                --radius-full: 999px;
                --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                --transition-smooth: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
                --rgb-primary: 139, 92, 246;
                --rgb-warning: 255, 196, 0;
                --rgb-danger: 255, 82, 82;
                --rgb-success: 0, 200, 83;
                --primary-hue: 257;
                --secondary-hue: 287;
            }

            .light {
                --color-primary: #7c3aed;
                --color-primary-dark: #6d28d9;
                --color-danger: #ef4444;
                --color-warning: #d97706;
                --color-success: #16a34a;
                --color-bg: #f4f4f5;
                --color-card: rgba(255, 255, 255, 0.75);
                --color-border: rgba(0, 0, 0, 0.09);
                --color-text: #18181b;
                --color-text-muted: #71717a;
                --color-text-dark: #18181b;
            }

            @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px) } to { opacity: 1; transform: translateY(0) } }
            @keyframes scaleIn { from { opacity: 0; transform: scale(.95) } to { opacity: 1; transform: scale(1) } }
            @keyframes gradient-animation { 0% { background-position: 0% 50% } 50% { background-position: 100% 50% } 100% { background-position: 0% 50% } }
            @keyframes swal-scale-in { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
            @keyframes swal-scale-out { from { transform: scale(1); opacity: 1; } to { transform: scale(0.9); opacity: 0; } }
            @keyframes swal-toast-enter { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
            @keyframes swal-toast-exit { to { opacity: 0; transform: translateY(20px) scale(0.95); } }
            @keyframes rowIn { to { opacity: 1; transform: translateY(0); } }

            *, *::before, *::after { 
                box-sizing: border-box; 
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
            }
            html { scroll-behavior: smooth; }
            body {
                font-family: var(--font-body);
                background-color: var(--color-bg);
                color: var(--color-text);
                margin: 0;
                height: 100vh;
                width: 100vw;
                overflow: hidden;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            body::-webkit-scrollbar { display: none; }

            .cosmic-bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden; }
            #starfield-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
            .nebula-glow {
                position: absolute; top: 50%; left: 50%;
                width: 80vmax; height: 80vmax; margin-top: -40vmax; margin-left: -40vmax;
                background: radial-gradient(circle,hsl(var(--primary-hue),90%,60%,.15) 0%,hsl(var(--secondary-hue),80%,50%,.1) 40%,transparent 70%);
                filter: blur(100px); border-radius: 50%;
                transition: background 1s ease;
            }

            #install-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 1rem; opacity: 0; transition: opacity 0.3s ease; }
            #install-overlay.visible { opacity: 1; }
            .desktop-view #install-overlay { align-items: flex-start; padding-top: 5rem; }
            #install-section-container { background: var(--color-card); border: 1px solid var(--color-border); border-radius: var(--radius); padding: 2rem; width: 90%; max-width: 500px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.4); animation: scaleIn .4s cubic-bezier(0.2, 0.8, 0.2, 1) both; }
            .light #install-section-container { box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); }
            #install-header { text-align: center; margin-bottom: 2rem; }
            #install-header i { font-size: 3rem; color: var(--color-primary); line-height: 1; margin-bottom: 0.5rem; display: block; }
            #install-header h2 { margin: 0; font-family: var(--font-title); font-size: 1.75rem; color: var(--color-text-dark); }
            #install-section-container p, #install-section-container li { text-align: right; color: var(--color-text-muted); line-height: 1.6;}
            .bookmarklet-button { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; background: linear-gradient(90deg, var(--color-primary-dark), var(--color-primary)); color: white; padding: 0.8rem 1.8rem; border-radius: var(--radius-full); font-weight: 700; text-decoration: none; cursor: grab; transition: transform .2s ease, box-shadow .2s ease; box-shadow: 0 4px 15px rgba(var(--rgb-primary), 0.2); }
            .bookmarklet-button:hover { transform: translateY(-3px) scale(1.03); box-shadow: 0 8px 25px rgba(var(--rgb-primary), 0.3); }
            #install-section-mobile ol { list-style: none; padding: 0; margin: 0 0 1.5rem 0;}
            #install-section-mobile li { position: relative; padding-right: 2.5rem; margin-bottom: 1.25rem; font-size: 0.95rem; font-weight: 500; }
            #install-section-mobile li::before { content: attr(data-step); position: absolute; top: -5px; right: 0; width: 32px; height: 32px; border-radius: 50%; background: rgba(var(--rgb-primary), 0.1); color: var(--color-primary); display: flex; align-items: center; justify-content: center; font-weight: 700; font-family: var(--font-title); }
            .code-container pre { background: rgba(0,0,0,0.3); padding: 1rem; border-radius: var(--radius-md); border: 1px solid var(--color-border); font-size: 0.8rem; white-space: pre-wrap; word-wrap: break-word; text-align: left; direction: ltr; }
            #copy-code-btn { display: block; width: 100%; background: var(--color-primary); color: white; padding: 0.8rem; border-radius: var(--radius-md); border: none; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all .2s ease; box-shadow: 0 4px 15px rgba(var(--rgb-primary), 0.2); }
            #copy-code-btn:hover { background: var(--color-primary-dark); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(var(--rgb-primary), 0.3); }

            .custom-scrollbar::-webkit-scrollbar { width: 8px; }
            .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(var(--rgb-primary), 0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
            .custom-scrollbar { scrollbar-width: thin; scrollbar-color: rgba(var(--rgb-primary), 0.3) transparent; }
            .page-wrapper .sidebar .custom-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
            .page-wrapper .sidebar .custom-scrollbar::-webkit-scrollbar { display: none; }
            
            .page-wrapper { display: flex; height: 100vh; }
            .main-content { flex-grow: 1; height: 100%; display: flex; flex-direction: column; padding: 2rem; gap: 1.5rem; overflow-y: auto; }
            .sidebar { width: 420px; height: 100%; background-color: var(--color-card); border-left: 1px solid var(--color-border); display: flex; flex-direction: column; flex-shrink: 0; backdrop-filter: blur(16px); background: radial-gradient(circle at 50% 0%, rgba(var(--rgb-primary), 0.08), transparent 40%), var(--color-card); }
            
            .main-header-container { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; animation: fadeInUp .8s var(--transition-smooth) both; }
            .main-header-container h1 { font-family: var(--font-title); font-weight: 700; font-size: 2.5rem; background: linear-gradient(90deg,var(--color-primary-dark),var(--color-primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200% 200%; animation: gradient-animation 5s ease-in-out infinite; display: flex; align-items: center; gap: 1rem; margin: 0; }
            .header-actions { display: flex; gap: 0.75rem; }
            .header-actions button { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--color-border); color: var(--color-text); padding: 0.6rem 1.2rem; border-radius: var(--radius-full); font-size: 0.9rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; transition: all var(--transition); }
            .light .header-actions button { background: rgba(0, 0, 0, 0.05); }
            .header-actions button:hover { background: rgba(var(--rgb-primary), 0.2); color: var(--color-primary); border-color: var(--color-primary); }

            .card { width: 100%; height: 100%; background-color: var(--color-card); border: 1px solid var(--color-border); border-radius: var(--radius); display: flex; flex-direction: column; backdrop-filter: blur(16px); box-shadow: 0 16px 40px -12px rgba(0,0,0,0.4); overflow: hidden; animation: scaleIn .8s var(--transition-smooth) .2s both; }
            .light .card { box-shadow: 0 16px 40px -12px rgba(0,0,0,0.1); }
            
            .schedule-tabs-container { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: var(--radius-full); flex-shrink: 0; animation: fadeInUp .8s var(--transition-smooth) .1s both; overflow-x: auto; max-width: max-content; }
            .light .schedule-tabs-container { background: rgba(0,0,0,0.05); }
            .schedule-tab { padding: 0.6rem 1.2rem; border: none; border-radius: var(--radius-full); background: transparent; color: var(--color-text-muted); font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; }
            .schedule-tab-name { outline: none; }
            .schedule-tab .delete-schedule-btn { font-size: 1.1rem; color: rgba(255,255,255,0.6); background: none; border: none; padding: 0; margin-right: -5px; display: none; cursor: pointer; }
            .schedule-tab.active .delete-schedule-btn { display: inline-block; }
            #add-schedule-btn { width: 40px; height: 40px; border-radius: 50%; background: transparent; color: var(--color-text-muted); border: none; font-size: 1.5rem; cursor: pointer; transition: var(--transition); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
            #add-schedule-btn:hover { background: rgba(var(--rgb-primary), 0.1); color: var(--color-primary); }
            .calendar-wrapper { flex: 1 1 auto; min-height: 500px; }
            .calendar-wrapper .card { padding: 1.5rem; }
            #calendar { height: 100%; }

            .sidebar-header { padding: 1.5rem 2rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
            .sidebar-header h2 { margin: 0; font-family: var(--font-title); font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; color: var(--color-text-dark); }
            .sidebar-content-wrapper { flex: 1; display: flex; flex-direction: column; min-height: 0; }
            .sidebar-tabs { display: flex; padding: 0.75rem 1rem 0; border-bottom: 1px solid var(--color-border); }
            .tab-btn { flex: 1; text-align: center; padding: 0.75rem 0.5rem; background: none; border: none; color: var(--color-text-muted); font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition); border-bottom: 2px solid transparent; }
            .tab-btn.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
            .tab-content { padding: 1rem; display: none; overflow-y: auto; flex-grow: 1; }
            .tab-content.active { display: block; }
            .sidebar-footer { padding: 1.25rem; border-top: 1px solid var(--color-border); text-align: center; flex-shrink: 0; }
            
            .course-item { margin-bottom: 0.75rem; animation: fadeInUp .5s ease both; overflow: hidden; contain: content; background: linear-gradient(145deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0)); border: 1px solid var(--color-border); box-shadow: inset 0 1px 1px rgba(255,255,255,0.03); border-radius: var(--radius-md); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
            .course-item:hover { transform: translateY(-5px); border-color: rgba(var(--rgb-primary), 0.5); box-shadow: 0 10px 25px -5px rgba(var(--rgb-primary), 0.15), 0 8px 10px -6px rgba(0,0,0,0.3); }
            .light .course-item { box-shadow: inset 0 1px 1px rgba(0,0,0,0.03); }
            .light .course-item:hover { box-shadow: 0 10px 25px -5px rgba(var(--rgb-primary), 0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }
            .course-item-header { display: flex; align-items: center; gap: 0.75rem; padding: 1.25rem; cursor: pointer; border-bottom: 1px solid transparent; transition: background-color 0.3s ease, border-color 0.3s ease; }
            .course-item.open .course-item-header { background-color: rgba(var(--rgb-primary), 0.05); border-bottom-color: rgba(var(--rgb-primary), 0.3); }
            .course-item .color-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; box-shadow: 0 0 10px 1px; }
            .course-info h3 { margin: 0; font-family: var(--font-title); font-size: 1.1rem; font-weight: 400; color: var(--color-text-dark); }
            .course-info p { margin: 4px 0 0; font-size: 0.8rem; color: var(--color-text-muted); }
            .course-item.open .sections-wrapper { max-height: 9999px; }
            .sections-wrapper { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-in-out; background-color: rgba(0,0,0,0.1); }
            .light .sections-wrapper { background-color: rgba(0,0,0,0.02); }
            @keyframes sectionFadeUp { from { opacity: 0; transform: translateY(8px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
            .course-item.open .section-btn { animation: sectionFadeUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
            .course-item .section-btn { opacity: 0; transform: translateY(8px) scale(0.98); }

            .sections-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.75rem; padding: 1rem 1.25rem 1.25rem; }
            .section-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.25rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--radius-full); text-align: center; cursor: pointer; background-color: transparent; transition: all var(--transition); position: relative;}
            .section-status-dot { position: absolute; top: 6px; right: 6px; width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 5px; }
            .section-btn:hover { border-color: var(--color-primary); color: var(--color-primary); background: rgba(var(--rgb-primary), 0.1); }
            .section-btn .section-type { font-size: 0.7rem; color: var(--color-text-muted); }
            .section-btn.selected .section-type { color: rgba(255,255,255,0.8); }

            .my-schedule-container { flex-shrink: 0; display: none; flex-direction: column; }
            .my-schedule-container .my-schedule-card { animation: scaleIn .8s var(--transition-smooth) .2s both; }
            .my-schedule-section { flex: 1; min-height: 0; display: flex; flex-direction: column; padding: 1.5rem; }
            
            .fc { --fc-border-color: rgba(255,255,255,0.08); --fc-event-text-color: #fff; --fc-page-bg-color: transparent; font-family: var(--font-body); }
            .fc-theme-standard .fc-scrollgrid { border: none; }
            .fc .fc-timegrid-slot-lane { border-style: dotted; }
            .fc .fc-col-header-cell { border-color: transparent; }
            .fc-event { border: none !important; border-radius: 8px !important; font-weight: 600; padding: 4px 8px !important; cursor: pointer; }
            .fc-event.preview-event { border-style: dashed !important; border-width: 2px !important; }
            .fc .fc-timegrid-slot-label { font-size: 0.8rem; color: var(--color-text-muted); border-color: var(--color-border) !important; }

            .no-data { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; padding: 2rem; color: var(--color-text-muted); }
            .no-data i { font-size: 4rem; margin-bottom: 1.5rem; color: var(--color-primary); opacity: 0.5; }

            html.swal2-shown, body.swal2-shown { overflow: hidden !important; }
            .swal2-container { z-index: 4000 !important; }
            .swal2-popup { background: var(--color-card)!important; color: var(--color-text)!important; border-radius: var(--radius)!important; border: 1px solid var(--color-border)!important; backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
            .swal2-title { color: var(--color-text-dark)!important; font-family: var(--font-title) !important; }
            .swal2-html-container { color: var(--color-text-muted)!important; margin: 1em 0 !important; display: block !important; text-align: right !important; padding: 0 0.5rem; }
            .swal2-confirm { background: var(--color-primary)!important; border-radius: var(--radius-full)!important; padding: .6rem 1.5rem!important; font-family: var(--font-body)!important; }
            .swal2-confirm:focus { box-shadow: 0 0 0 3px rgba(var(--rgb-primary),0.5)!important }
            .swal2-cancel { background: rgba(255,255,255,0.1)!important; color: var(--color-text)!important; border-radius: var(--radius-full)!important; padding: .6rem 1.5rem!important; font-family: var(--font-body)!important; }
            .light .swal2-cancel { background: rgba(0,0,0,0.1)!important; }
            
            .swal2-container .swal2-toast { padding: 1rem 1.25rem; background: var(--color-card)!important; border-radius: var(--radius-md) !important; border: 1px solid var(--color-border) !important; backdrop-filter: blur(10px); box-shadow: 0 10px 30px -5px rgba(0,0,0,0.3) !important; width: auto !important; max-width: 380px; }
            .swal-toast-enter { animation: swal-toast-enter .3s cubic-bezier(0.2, 0.8, 0.2, 1); }
            .swal-toast-exit { animation: swal-toast-exit .3s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
            .light .swal2-container .swal2-toast { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1) !important; }
            .swal2-toast .swal2-title { font-size: 1rem !important; font-weight: 600; color: var(--color-text-dark) !important; margin: 0 !important; }
            .swal2-toast .swal2-icon { margin: 0 0 0 1em !important; grid-column: 2 !important; grid-row: 1/span 1 !important; align-self: center !important; }
            .swal2-toast.swal2-icon-show .swal2-title { margin-right: 3.2em !important; }
            .swal2-timer-progress-bar-container { position: absolute; bottom: 0; left: 0; right: 0; height: 5px; overflow: hidden; border-bottom-left-radius: var(--radius-md); border-bottom-right-radius: var(--radius-md); }
            .swal2-timer-progress-bar { background: var(--color-primary) !important; height: 5px !important; }

            .my-schedule-card { backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.06); }
            .card-header-inline { display: flex; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 1.5rem; }
            .card-header-inline h3 { margin: 0; }
            .total-credits-pill { padding: 0.35rem 1rem; border-radius: 999px; background: rgba(var(--rgb-primary), 0.15); border: 1px solid rgba(var(--rgb-primary), 0.2); font-size: 0.9rem; color: var(--color-primary); flex-shrink: 0; }
            .total-credits-pill span { font-weight: 700; font-family: var(--font-title); }
            .my-schedule-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
            .my-schedule-table thead th { background: rgba(255,255,255,0.03); padding: 0.8rem; text-align: center; font-family: var(--font-title); color: var(--color-text-muted); border-bottom: 2px solid var(--color-border); }
            .my-schedule-table tbody td { padding: 1.25rem 1rem; border-bottom: 1px solid var(--color-border); vertical-align: middle; text-align: center;}
            .my-schedule-table .course-cell .course-code { font-size: 1rem; font-weight: 600;}
            .my-schedule-table .section-cell .section-number { font-size: 1rem; font-weight: 600; }
            .hours-value { font-size: 1.2rem; font-weight: 700; color: var(--color-primary); }

            .my-schedule-table .schedule-row { opacity: 0; transform: translateY(6px); animation: rowIn 0.35s ease-out forwards; }
            .my-schedule-table .schedule-row:nth-child(1) { animation-delay: 0.05s; } .my-schedule-table .schedule-row:nth-child(2) { animation-delay: 0.1s; } .my-schedule-table .schedule-row:nth-child(3) { animation-delay: 0.15s; } .my-schedule-table .schedule-row:nth-child(4) { animation-delay: 0.2s; } .my-schedule-table .schedule-row:nth-child(5) { animation-delay: 0.25s; } .my-schedule-table .schedule-row:nth-child(6) { animation-delay: 0.3s; } .my-schedule-table .schedule-row:nth-child(7) { animation-delay: 0.35s; } .my-schedule-table .schedule-row:nth-child(8) { animation-delay: 0.4s; } .my-schedule-table .schedule-row:nth-child(9) { animation-delay: 0.45s; } .my-schedule-table .schedule-row:nth-child(10) { animation-delay: 0.5s; }
            .my-schedule-table .schedule-row.has-conflict { background-color: rgba(var(--rgb-danger), 0.1); box-shadow: inset 4px 0 0 0 var(--color-danger); }
            
            @keyframes shimmer { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
            .section-btn.selected { color: white; border-color: transparent; background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 50%, #a855f7 100%); background-size: 200% 200%; animation: shimmer 4s ease infinite; box-shadow: 0 2px 20px rgba(var(--rgb-primary), 0.4); transform: scale(1.05); }
            .schedule-tab.active { background: linear-gradient(135deg, var(--color-primary-dark), var(--color-primary)); background-size: 200% 200%; animation: shimmer 5s ease infinite; color: white; box-shadow: 0 4px 15px rgba(var(--rgb-primary), 0.2); }
        </style>
    </head>
    <body>
        <div class="cosmic-bg-container"><div class="nebula-glow"></div><canvas id="starfield-canvas"></canvas></div>
        
        <div id="install-overlay">
            <div id="install-section-container"></div>
        </div>
        
        <div class="page-wrapper">
            <main class="main-content custom-scrollbar">
                <div class="main-header-container">
                    <h1><i class="ri-calendar-event-line"></i> QU Schedule</h1>
                    <div class="header-actions">
                        <button id="settings-btn"><i class="ri-settings-3-line"></i> إعدادات</button>
                        <button id="clear-calendar-btn"><i class="ri-delete-bin-6-line"></i> مسح الجدول الحالي</button>
                    </div>
                </div>
                <div class="schedule-tabs-container" id="schedule-tabs-container"></div>
                <div class="calendar-wrapper card"><div id='calendar'></div></div>
                <div class="my-schedule-container" id="my-schedule-container"></div>
            </main>
            <aside class="sidebar">
                <header class="sidebar-header"><h2><i class="ri-stack-line"></i> المقررات</h2></header>
                <div class="sidebar-content-wrapper"><div class="sidebar-tabs"><button class="tab-btn active" data-tab="courses-tab"><i class="ri-layout-grid-line"></i> المقررات المتاحة</button><button class="tab-btn" data-tab="exams-tab"><i class="ri-file-list-3-line"></i> الاختبارات النهائية</button></div><div id="courses-tab" class="tab-content active custom-scrollbar"><div id="desktop-courses-list"><div class="no-data" id="no-data-message"><i class="ri-time-line"></i><h4>في انتظار البيانات...</h4><p>اسحب الأداة من شريط الإشارات المرجعية وضعها في صفحة المقررات المطروحة لتظهر هنا.</p></div></div></div><div id="exams-tab" class="tab-content custom-scrollbar"><div id="desktop-exams-list"></div></div></div>
                <footer class="sidebar-footer"><a href="https://t.me/mutlaq1" target="_blank" rel="noopener noreferrer" class="designer-credit"><i class="ri-telegram-line"></i> MUTLAQ1</a></footer>
            </aside>
        </div>

        <div class="mobile-wrapper">
        </div>

        <div class="modal-overlay" id="modal-overlay"></div>
        <div class="settings-modal" id="settings-modal"></div>
        <div class="mobile-section-details-overlay" id="mobile-section-details-overlay">
            <div class="details-panel" id="details-panel"></div>
        </div>

        <script>
        // All JavaScript code is identical to the previous version and is omitted here for brevity.
        // Copy-paste the JS from the last response block to have a complete file.
        // The changes requested were purely CSS and HTML structure changes.
        
        // --- Full JavaScript Code ---
        
        function initStarfield() {
            const canvas = document.getElementById('starfield-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            let w, h;
            function setSize() {
                w = canvas.width = window.innerWidth;
                h = canvas.height = window.innerHeight;
            }
            setSize();
            window.addEventListener('resize', setSize);

            const stars = [];
            const shootingStars = [];
            const numStars = 250; 
            const numShootingStars = 3;

            class Star {
                constructor() { this.reset(); }
                reset() {
                    this.x = Math.random() * w;
                    this.y = Math.random() * h;
                    this.size = Math.random() * 1.5 + 0.5;
                    this.opacity = Math.random() * 0.5 + 0.2;
                    this.speedX = (Math.random() - 0.5) * 0.1;
                    this.speedY = (Math.random() - 0.5) * 0.1;
                }
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
                    ctx.fill();
                }
                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    if (this.x < 0 || this.x > w || this.y < 0 || this.y > h) this.reset();
                }
            }

            class ShootingStar {
                constructor() { this.reset(); }
                reset() {
                    this.x = Math.random() * w;
                    this.y = 0;
                    this.len = Math.random() * 80 + 10;
                    this.speed = Math.random() * 8 + 6;
                    this.size = Math.random() * 1 + 0.5;
                    this.waitTime = new Date().getTime() + Math.random() * 3000 + 500;
                    this.active = false;
                }
                update() {
                    if (this.active) {
                        this.x -= this.speed;
                        this.y += this.speed;
                        if (this.x < -this.len || this.y > h + this.len) this.reset();
                    } else if (this.waitTime < new Date().getTime()) {
                        this.active = true;
                    }
                }
                draw() {
                    if (this.active) {
                        const grad = ctx.createLinearGradient(this.x, this.y, this.x + this.len, this.y - this.len);
                        grad.addColorStop(0, "rgba(255, 255, 255, 0.8)");
                        grad.addColorStop(1, "rgba(255, 255, 255, 0)");
                        ctx.strokeStyle = grad;
                        ctx.lineWidth = this.size;
                        ctx.beginPath();
                        ctx.moveTo(this.x, this.y);
                        ctx.lineTo(this.x - this.len, this.y + this.len);
                        ctx.stroke();
                    }
                }
            }
            
            for (let i = 0; i < numStars; i++) stars.push(new Star());
            for (let i = 0; i < numShootingStars; i++) shootingStars.push(new ShootingStar());

            function animate() {
                ctx.clearRect(0, 0, w, h);
                stars.forEach(s => { s.update(); s.draw(); });
                shootingStars.forEach(s => { s.update(); s.draw(); });
                requestAnimationFrame(animate);
            }
            animate();
        }

        document.addEventListener('DOMContentLoaded', () => {
                initStarfield();

                const mainContent = document.querySelector('.main-content');
                if(mainContent) {
                    mainContent.addEventListener('scroll', () => {
                        mainContent.setAttribute('scrollTop', mainContent.scrollTop);
                    });
                }


                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) && window.innerWidth < 1024;
                if (isMobile) {
                    document.body.classList.add('mobile-view');
                } else {
                    document.body.classList.add('desktop-view');
                }

                const QU_ScheduleApp = {
                    state: {
                        calendar: null,
                        allCoursesData: [],
                        groupedCourses: {},
                        linkedCourseGroups: {},
                        schedules: [],
                        activeScheduleIndex: 0,
                        hiddenCourseCodes: new Set(),
                        customColors: {},
                        userSettings: {
                            theme: 'dark',
                            accentColor: '#8b5cf6',
                            showWeekends: false,
                            minTime: '08:00:00',
                            maxTime: '22:00:00',
                            hiddenCourseCodes: [],
                            hideClosedCourses: true
                        }
                    },
                    constants: {
                        PRESET_COLORS: { purple: '#8b5cf6', blue: '#3b82f6', pink: '#ec4899', green: '#22c55e', orange: '#f97316' },
                        COLOR_PALETTE: ['#8b5cf6', '#3b82f6', '#ec4899', '#22c55e', '#f97316', '#ef4444', '#06b6d4', '#d946ef'],
                        DAY_MAPPING: { 'الأحد': 0, 'الاثنين': 1, 'الثلاثاء': 2, 'الأربعاء': 3, 'الخميس': 4, 'الجمعة': 5, 'السبت': 6 },
                        STORAGE_KEYS: {
                            SETTINGS: 'quScheduleSettings_v20', 
                            COURSES: 'quScheduleCourses_v20',
                            SCHEDULES: 'quScheduleSchedules_v20', 
                            COLORS: 'quScheduleColors_v20'
                        },
                        EXTRACTOR_URL: 'https://mutlaq001.github.io/schedule/extractor.js'
                    },
                    dom: {},

                    init() {
                        this._populateDOMElements();
                        this._setupEventListeners();
                        this._loadSettings();
                        this._loadCustomColors();
                        this._initializeCalendar();
                        this._loadDataFromStorage();
                        this._listenForDataFromOpener();
                        this._updateBookmarkletCode();
                    },

                };

                Object.assign(QU_ScheduleApp, {
                    _loadDataFromStorage() {
                        const storedCourses = localStorage.getItem(this.constants.STORAGE_KEYS.COURSES);
                        if (storedCourses) {
                            try {
                                const courses = JSON.parse(storedCourses);
                                if (!Array.isArray(courses)) throw new Error("Stored data is not a valid array.");
                                
                                this._processAndDisplayData(courses);
                                this._loadSchedules();
                                this.updateFullUI();
                            } catch (e) {
                                console.error("Error loading or parsing course data:", e);
                                localStorage.removeItem(this.constants.STORAGE_KEYS.COURSES);
                                this.dom.installOverlay.style.display = 'flex';
                                this.dom.installOverlay.classList.add('visible');
                            }
                        } else {
                            this.dom.installOverlay.style.display = 'flex';
                            this.dom.installOverlay.classList.add('visible');
                        }
                    },
                    _listenForDataFromOpener() {
                        window.addEventListener('message', (event) => {
                            if (event.data && event.data.type === 'universityCoursesData') {
                                const courses = event.data.data;
                                localStorage.setItem(this.constants.STORAGE_KEYS.COURSES, JSON.stringify(courses));
                                
                                this.state.schedules = []; 
                                this._addSchedule(null, true);
                                this.state.activeScheduleIndex = 0;
                                this._saveSchedules();
                                
                                this._processAndDisplayData(courses);
                                this.updateFullUI();
                            }
                        }, false);
                        if (window.opener) {
                            window.opener.postMessage('request_schedule_data', '*');
                        }
                    },
                    _processAndDisplayData(courses) {
                        this.dom.installOverlay.style.display = 'none';
                        this.dom.installOverlay.classList.remove('visible');

                        this.state.allCoursesData = courses.map((section, index) => ({
                            ...section,
                            uniqueId: `${section.code}-${section.section}-${index}`,
                            timeSlots: this._parseTimeEntries(section.time)
                        }));

                        const coursesByName = {};
                        this.state.groupedCourses = this.state.allCoursesData.reduce((acc, course) => {
                            if (!acc[course.code]) {
                                acc[course.code] = { name: course.name, code: course.code, sections: [] };
                                if(!coursesByName[course.name]) coursesByName[course.name] = [];
                                coursesByName[course.name].push(course.code);
                            }
                            acc[course.code].sections.push(course);
                            return acc;
                        }, {});

                        this.state.linkedCourseGroups = {};
                        for (const name in coursesByName) {
                            if (coursesByName[name].length > 1) {
                                this.state.linkedCourseGroups[name] = [...new Set(coursesByName[name])];
                            }
                        }

                        let colorIndex = 0;
                        Object.values(this.state.groupedCourses).forEach(group => {
                            group.color = this.state.customColors[group.code] || this.constants.COLOR_PALETTE[colorIndex++ % this.constants.COLOR_PALETTE.length];
                        });
                        
                        document.getElementById('no-data-message').style.display = 'none';
                        this._renderCoursesList();
                        this._buildSettingsModal();
                    },
                    _loadSchedules() {
                        const stored = localStorage.getItem(this.constants.STORAGE_KEYS.SCHEDULES);
                        if (stored) {
                            try {
                                const parsed = JSON.parse(stored);
                                if (parsed && Array.isArray(parsed.schedules) && parsed.schedules.length > 0) {
                                    this.state.schedules = parsed.schedules.map(s => ({ 
                                        name: s.name || 'جدول', 
                                        sections: new Set(s.sections),
                                        linkedSections: new Map((s.linkedSections || []).map(([key, value]) => [key, new Set(value)]))
                                    }));
                                    this.state.activeScheduleIndex = Math.min(parsed.activeScheduleIndex, this.state.schedules.length - 1);
                                } else {
                                    throw new Error("No valid schedules found in storage.");
                                }
                            } catch (e) {
                                console.error("Error loading schedules, resetting:", e);
                                localStorage.removeItem(this.constants.STORAGE_KEYS.SCHEDULES);
                                this.state.schedules = [];
                                this._addSchedule(null, true);
                            }
                        }
                        if (this.state.schedules.length === 0) {
                           this._addSchedule(null, true);
                        }
                    },
                    _saveSchedules() {
                        const serializableSchedules = {
                           activeScheduleIndex: this.state.activeScheduleIndex,
                           schedules: this.state.schedules.map(s => ({ 
                               name: s.name, 
                               sections: Array.from(s.sections),
                               linkedSections: Array.from(s.linkedSections.entries()).map(([key, value]) => [key, Array.from(value)])
                           }))
                        };
                        localStorage.setItem(this.constants.STORAGE_KEYS.SCHEDULES, JSON.stringify(serializableSchedules));
                    },
                    _loadCustomColors() {
                        const stored = localStorage.getItem(this.constants.STORAGE_KEYS.COLORS);
                        if (stored) {
                            try { this.state.customColors = JSON.parse(stored); } catch (e) { localStorage.removeItem(this.constants.STORAGE_KEYS.COLORS); }
                        }
                    },
                    _saveCustomColors() {
                        localStorage.setItem(this.constants.STORAGE_KEYS.COLORS, JSON.stringify(this.state.customColors));
                    },
                    updateFullUI() {
                        this._renderScheduleTabs();
                        this.updateCalendarAndConflicts();
                        if (isMobile) {
                            this._updateMobileHeader();
                        }
                    },
                    updateCalendarAndConflicts() {
                        if (!this.state.calendar) return;

                        const activeSchedule = this.state.schedules[this.state.activeScheduleIndex];
                        const selectedSections = activeSchedule ? activeSchedule.sections : new Set();
                        
                        this.state.calendar.removeAllEvents();
                        
                        document.querySelectorAll('.section-btn').forEach(btn => {
                            btn.classList.toggle('selected', selectedSections.has(btn.dataset.uniqueId));
                        });

                        const selectedCourseDetails = Array.from(selectedSections).map(id => this.state.allCoursesData.find(c => c.uniqueId === id)).filter(Boolean);
                        
                        const conflictMap = this._calculateConflicts(selectedCourseDetails);

                        selectedCourseDetails.forEach(section => {
                            const group = this.state.groupedCourses[section.code];
                            if (group && !this.state.hiddenCourseCodes.has(section.code)) {
                                const lectureEvents = this._createLectureEventsForSection(section, false, group.color);
                                this.state.calendar.addEventSource(lectureEvents);
                            }
                        });

                        this._renderFinalExams(selectedCourseDetails);
                        this._renderMyScheduleSummary(selectedCourseDetails, conflictMap);
                        this._updateAvailableSectionsUI(selectedCourseDetails);
                        this._saveSchedules();
                    },
                    _renderScheduleTabs() {
                        const containers = [this.dom.scheduleTabsContainer, this.dom.mobileScheduleTabsContainer].filter(Boolean);
                        containers.forEach(container => {
                            container.innerHTML = '';
                            const fragment = document.createDocumentFragment();

                            this.state.schedules.forEach((schedule, index) => {
                                const tab = document.createElement('button');
                                tab.className = `schedule-tab ${index === this.state.activeScheduleIndex ? 'active' : ''}`;
                                tab.dataset.index = index;
                                tab.innerHTML = `<span class="schedule-tab-name" contenteditable="false">${schedule.name}</span><i class="ri-close-line delete-schedule-btn"></i>`;
                                
                                const nameSpan = tab.querySelector('.schedule-tab-name');
                                tab.addEventListener('click', (e) => {
                                    if (e.target.classList.contains('delete-schedule-btn')) return;
                                    this._switchSchedule(index);
                                });
                                tab.addEventListener('dblclick', () => { if (tab.classList.contains('active')) { nameSpan.contentEditable = true; nameSpan.focus(); document.execCommand('selectAll', false, null); } });
                                nameSpan.addEventListener('blur', () => { nameSpan.contentEditable = false; this._renameSchedule(index, nameSpan.textContent); });
                                nameSpan.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); nameSpan.blur(); } });
                                tab.querySelector('.delete-schedule-btn').addEventListener('click', (e) => { e.stopPropagation(); this._deleteSchedule(index); });
                                fragment.appendChild(tab);
                            });

                            const addButton = document.createElement('button');
                            addButton.id = 'add-schedule-btn';
                            addButton.innerHTML = '<i class="ri-add-line"></i>';
                            addButton.title = 'إضافة جدول جديد';
                            addButton.addEventListener('click', () => this._addSchedule());
                            fragment.appendChild(addButton);
                            container.appendChild(fragment);
                        });
                    },
                    _createCoursesListHTML() {
                        const selectedSections = this.state.schedules[this.state.activeScheduleIndex]?.sections || new Set();
                        const visibleCourses = Object.values(this.state.groupedCourses).filter(g => !this.state.hiddenCourseCodes.has(g.code));
                        if (Object.keys(this.state.groupedCourses).length > 0 && visibleCourses.length === 0) {
                            return `<div class="no-data" style="height: auto; padding: 2rem 1rem;"><i class="ri-eye-off-line"></i><h4>لا توجد مقررات ظاهرة</h4><p>يمكنك إظهار المقررات من الإعدادات.</p></div>`;
                        }
                        if(visibleCourses.length === 0) return '';
                        return visibleCourses.sort((a, b) => a.code.localeCompare(b.code)).map((group, i) => {
                            const sectionsToDisplay = this.state.userSettings.hideClosedCourses
                                ? group.sections.filter(section => !section.status.includes('مغلقة'))
                                : group.sections;

                            if (sectionsToDisplay.length === 0) return '';
                            const sectionsHTML = sectionsToDisplay.map(section => {
                                const isNoTime = section.time === 'غير محدد';
                                const isOpen = section.status.includes('مفتوحة');
                                const statusIndicatorHTML = !this.state.userSettings.hideClosedCourses ? `<span class="section-status-dot ${isOpen ? 'open' : 'closed'}"></span>` : ``;
                                
                                return `<div class="section-btn ${selectedSections.has(section.uniqueId) ? 'selected' : ''} ${isNoTime ? 'no-time' : ''}" data-unique-id="${section.uniqueId}" style="${isNoTime ? '--item-color:' + group.color : ''}">
                                            ${statusIndicatorHTML}
                                            <div class="section-btn-number">${section.section}</div>
                                            <div class="section-type">${section.type || ''}</div>
                                        </div>`;
                            }).join('');
                            return `<div class="course-item" style="animation-delay: ${i * 30}ms"><div class="course-item-header"><span class="color-dot" style="background-color: ${group.color}; box-shadow: 0 0 10px 1px ${group.color};"></span><div class="course-info"><h3>${group.name} (${group.code})</h3><p>${sectionsToDisplay.length} شعب متاحة</p></div><i class="ri-arrow-down-s-line toggle-icon"></i></div><div class="sections-wrapper"><div class="sections-grid">${sectionsHTML}</div></div></div>`;
                        }).join('');
                    },
                    _renderCoursesList() {
                        const html = this._createCoursesListHTML();
                        if (this.dom.desktopCoursesList) {
                            this.dom.desktopCoursesList.innerHTML = html || '';
                        }
                        if (this.dom.mobileCoursesList) {
                            this.dom.mobileCoursesList.innerHTML = html || `<div class="no-data"><i class="ri-time-line"></i><h4>في انتظار البيانات...</h4><p>استخدم الأداة لتحميل بيانات المواد.</p></div>`;;
                        }
                    },
                    _renderMyScheduleSummary(selectedCourses, conflictMap) {
                        const desktopContainer = this.dom.myScheduleContainer;
                        const mobileContainer = this.dom.mobileMyScheduleContainer;
                        
                        if (desktopContainer) {
                            desktopContainer.style.display = 'flex';
                            if (selectedCourses.length === 0) {
                                desktopContainer.innerHTML = `<div class="no-data" style="width:100%"><i class="ri-calendar-check-line"></i><h4>جدولك فارغ</h4><p>اختر بعض المقررات لإنشاء جدولك.</p></div>`;
                            } else {
                                desktopContainer.innerHTML = this._createMyScheduleHTML(selectedCourses, conflictMap);
                                const desktopConflictBtn = desktopContainer.querySelector('#desktop-view-conflicts-btn');
                                if (desktopConflictBtn) {
                                    desktopConflictBtn.addEventListener('click', () => this._handleViewAllConflicts(conflictMap));
                                }
                            }
                        }

                        if (mobileContainer) {
                            if (selectedCourses.length === 0) {
                                mobileContainer.innerHTML = `<div class="no-data" style="padding-top: 5rem;"><i class="ri-calendar-check-line"></i><h4>جدولك فارغ</h4><p>اختر بعض المقررات لإنشاء جدولك.</p></div>`;
                            } else {
                                mobileContainer.innerHTML = this._createMobileScheduleHTML(selectedCourses, conflictMap);
                                const mobileConflictBtn = mobileContainer.querySelector('#mobile-view-conflicts-btn');
                                if (mobileConflictBtn) {
                                    mobileConflictBtn.addEventListener('click', () => this._handleViewAllConflicts(conflictMap));
                                }
                            }
                        }
                    },
                    _createMyScheduleHTML(selectedCourses, conflictMap) {
                        let totalCredits = 0;
                        const uniqueCourseCodes = new Set();
                        const tableRowsHTML = selectedCourses.sort((a, b) => a.code.localeCompare(b.code)).map(course => {
                            if (!uniqueCourseCodes.has(course.code)) {
                                totalCredits += parseInt(course.hours, 10) || 0;
                                uniqueCourseCodes.add(course.code);
                            }
                            const examText = course.examPeriodId || "لا يوجد";
                            const statusClass = course.status.includes('مفتوحة') ? 'open' : 'closed';
                            const statusCellHTML = this.state.userSettings.hideClosedCourses ? '' : `<td><span class="status-badge status-${statusClass}">${course.status}</span></td>`;
                            const isConflicted = conflictMap.has(course.uniqueId);
                            const conflictIconHTML = isConflicted ? `<i class="ri-alert-fill conflict-icon" title="${conflictMap.get(course.uniqueId).join('\n')}"></i>` : '';

                            return `<tr class="schedule-row ${isConflicted ? 'has-conflict' : ''}">
                                <td class="course-cell"><div class="course-code">${conflictIconHTML} ${course.code}</div><div class="course-name">${course.name}</div></td>
                                <td class="section-cell"><div class="section-number">${course.section}</div><div class="section-type">${course.type}</div></td>
                                <td>${course.instructor}</td>
                                <td>${course.time.replace(/<br>/g, ' ')}</td>
                                ${statusCellHTML}
                                <td>${examText}</td>
                                <td>${course.location}</td>
                                <td><div class="hours-value">${course.hours}</div></td>
                            </tr>`;
                        }).join('');

                        let conflictButtonHTML = '';
                        if (conflictMap.size > 0) {
                            conflictButtonHTML = `<button class="view-conflicts-btn" id="desktop-view-conflicts-btn">
                                                    <i class="ri-alert-fill"></i> حل التعارض
                                                </button>`;
                        }
                        
                        const statusHeaderHTML = this.state.userSettings.hideClosedCourses ? '' : '<th>الحالة</th>';
                        
                        return `<div class="card my-schedule-card">
                            <div class="my-schedule-section">
                                <div class="card-header-inline">
                                    <h3><i class="ri-calendar-check-line"></i> جدولـي</h3>
                                    <div class="total-credits-pill">إجمالي الساعات: <span>${totalCredits}</span></div>
                                </div>
                                <div class="my-schedule-table-wrapper">
                                    <table class="my-schedule-table">
                                        <thead><tr><th>المقرر</th><th>الشعبة</th><th>المحاضر</th><th>المواعيد</th>${statusHeaderHTML}<th>فترة الاختبار</th><th>المكان</th><th>الساعات</th></tr></thead>
                                        <tbody>${tableRowsHTML}</tbody>
                                    </table>
                                </div>
                                <div class="my-schedule-footer">
                                    ${conflictButtonHTML}
                                </div>
                            </div>
                        </div>`;
                    },
                    _createMobileScheduleHTML(selectedCourses, conflictMap) {
                        let totalCredits = 0;
                        const uniqueCourseCodes = new Set();

                        const itemsHTML = selectedCourses.sort((a, b) => a.code.localeCompare(b.code)).map((course, i) => {
                            if (!uniqueCourseCodes.has(course.code)) {
                                totalCredits += parseInt(course.hours, 10) || 0;
                                uniqueCourseCodes.add(course.code);
                            }
                            const isConflicted = conflictMap.has(course.uniqueId);
                            const conflictIconHTML = isConflicted ? `<i class="ri-alert-fill mobile-conflict-icon" title="${conflictMap.get(course.uniqueId).join('\n')}"></i>` : '';
                            
                            return `<div class="mobile-schedule-item" style="animation-delay:${i*30}ms;">
                                <div class="mobile-schedule-header">
                                    <div class="mobile-schedule-title">
                                        <h3>${course.name}</h3>
                                        <span>${course.code} - شعبة ${course.section}</span>
                                    </div>
                                    ${conflictIconHTML}
                                </div>
                                <div class="mobile-schedule-details">
                                    <div class="mobile-detail-row"><i class="ri-time-line"></i> <strong>المواعيد:</strong> ${course.time.replace(/<br>/g, ' / ') || 'غير محدد'}</div>
                                    <div class="mobile-detail-row"><i class="ri-map-pin-line"></i> <strong>المكان:</strong> ${course.location || 'غير محدد'}</div>
                                    <div class="mobile-detail-row"><i class="ri-user-line"></i> <strong>المحاضر:</strong> ${course.instructor || 'غير محدد'}</div>
                                    <div class="mobile-detail-row"><i class="ri-file-text-line"></i> <strong>الاختبار:</strong> ${course.examPeriodId || 'لا يوجد'}</div>
                                </div>
                            </div>`;
                        }).join('');
                        
                        let conflictButtonHTML = '';
                        if (conflictMap.size > 0) {
                            conflictButtonHTML = `<button class="view-conflicts-btn" id="mobile-view-conflicts-btn">
                                                    <i class="ri-alert-fill"></i> حل التعارض
                                                </button>`;
                        }

                        return `
                            <div id="mobile-my-schedule-list">${itemsHTML}</div>
                            <div class="mobile-schedule-footer">
                                 ${conflictButtonHTML}
                                 <div class="total-credits-summary">إجمالي الساعات: <span>${totalCredits}</span></div>
                            </div>`;
                    },
                    _renderFinalExams(selectedCourses) {
                        const uniqueExams = [...new Map(selectedCourses.filter(e => e.examPeriodId).map(e => [e.examPeriodId, e])).values()];

                        if (uniqueExams.length === 0) {
                            const html = `<div class="no-data" style="height: auto; padding-top: 2rem;"><i class="ri-file-text-line"></i><h4>لا توجد اختبارات</h4><p>لم يتم تحديد اختبارات نهائية للمقررات المختارة.</p></div>`;
                            if (this.dom.desktopExamsList) this.dom.desktopExamsList.innerHTML = html;
                            if (this.dom.mobileExamsList) this.dom.mobileExamsList.innerHTML = html;
                            return;
                        }
                        
                        const html = uniqueExams.sort((a, b) => parseInt(a.examPeriodId, 10) - parseInt(b.examPeriodId, 10)).map(exam => 
                            `<div class="course-item">
                                <div class="course-item-header" style="cursor:default;">
                                    <div class="course-info">
                                        <h3>${exam.name} (${exam.code})</h3>
                                        <p><strong>فترة الاختبار: ${exam.examPeriodId}</strong></p>
                                    </div>
                                </div>
                            </div>`
                        ).join('');

                        if (this.dom.desktopExamsList) this.dom.desktopExamsList.innerHTML = html;
                        if (this.dom.mobileExamsList) this.dom.mobileExamsList.innerHTML = html;
                    },
                    _updateAvailableSectionsUI(selectedCourses) {
                        const activeSections = this.state.schedules[this.state.activeScheduleIndex]?.sections || new Set();
                        this.state.allCoursesData.forEach(section => {
                            const btns = document.querySelectorAll(`.section-btn[data-unique-id='${section.uniqueId}']`);
                            btns.forEach(btn => {
                                if (btn) {
                                    btn.classList.remove('conflicted');
                                    if (!activeSections.has(section.uniqueId)) {
                                        btn.classList.toggle('conflicted', this._isSectionConflicted(section, selectedCourses));
                                    }
                                }
                            });
                        });
                    },
                    _populateDOMElements() {
                        const ids = [
                            'my-schedule-container', 'calendar', 'clear-calendar-btn', 'settings-btn', 
                            'settings-modal', 'modal-overlay', 'install-section-container', 'install-overlay', 'no-data-message', 
                            'schedule-tabs-container', 'desktop-courses-list', 'desktop-exams-list',
                            'mobile-schedule-tabs-container', 'mobile-my-schedule-container', 'mobile-header-title', 
                            'mobile-settings-btn', 'mobile-courses-list', 'mobile-exams-list', 'mobile-calendar',
                            'mobile-section-details-overlay', 'details-panel'
                        ];
                        ids.forEach(id => {
                            this.dom[id.replace(/-(\w)/g, (_, c) => c.toUpperCase())] = document.getElementById(id);
                        });
                        
                        if (isMobile) {
                            this.dom.tabButtons = document.querySelectorAll('#mobile-courses-view .tab-btn');
                            this.dom.tabContents = document.querySelectorAll('#mobile-courses-view .tab-content');
                            this.dom.mobileNavButtons = document.querySelectorAll('.mobile-nav-btn');
                            this.dom.mobileViewContents = document.querySelectorAll('.mobile-view-content');
                        } else {
                            this.dom.tabButtons = document.querySelectorAll('.page-wrapper .sidebar .tab-btn');
                            this.dom.tabContents = document.querySelectorAll('.page-wrapper .sidebar .tab-content');
                        }
                    },
                    _calculateConflicts(selectedCourses) {
                        const conflictMap = new Map();
                        for (let i = 0; i < selectedCourses.length; i++) {
                            for (let j = i + 1; j < selectedCourses.length; j++) {
                                const cA = selectedCourses[i], cB = selectedCourses[j];
                                const msgA = conflictMap.get(cA.uniqueId) || [], msgB = conflictMap.get(cB.uniqueId) || [];
                                if (cA.timeSlots.some(sA => cB.timeSlots.some(sB => sA.day === sB.day && sA.start < sB.end && sA.end > sB.start))) {
                                    msgA.push(`تعارض وقت محاضرة مع ${cB.name} (${cB.code})`);
                                    msgB.push(`تعارض وقت محاضرة مع ${cA.name} (${cA.code})`);
                                }
                                if (cA.code !== cB.code && cA.examPeriodId && cB.examPeriodId && cA.examPeriodId === cB.examPeriodId) {
                                    msgA.push(`تعارض اختبار نهائي مع ${cB.name} (${cB.code})`);
                                    msgB.push(`تعارض اختبار نهائي مع ${cA.name} (${cA.code})`);
                                }
                                if (msgA.length > 0) conflictMap.set(cA.uniqueId, msgA);
                                if (msgB.length > 0) conflictMap.set(cB.uniqueId, msgB);
                            }
                        }
                        return conflictMap;
                    },
                    _isSectionConflicted(section, selectedCourses) {
                        return selectedCourses.some(sel => {
                            if(sel.uniqueId === section.uniqueId) return false;
                            const lectureConflict = section.timeSlots.some(sA => sel.timeSlots.some(sB => sA.day === sB.day && sA.start < sB.end && sA.end > sB.start));
                            const examConflict = section.code !== sel.code && section.examPeriodId && sel.examPeriodId && section.examPeriodId === sel.examPeriodId;
                            return lectureConflict || examConflict;
                        });
                    },
                    _createLectureEventsForSection(section, isPreview, color) {
                        const sourceId = isPreview ? 'preview-source' : undefined;
                        return {
                            id: sourceId,
                            events: section.timeSlots.map(slot => ({
                                title: `${section.name}`,
                                daysOfWeek: [slot.day],
                                startTime: slot.start,
                                endTime: slot.end,
                                backgroundColor: isPreview ? 'transparent' : color,
                                borderColor: isPreview ? color : this._adjustColorBrightness(color, -20),
                                classNames: isPreview ? ['preview-event'] : [],
                                extendedProps: { ...section },
                                display: 'block'
                            }))
                        };
                    },
                    _parseTimeEntries(timeString) {
                        if (!timeString || typeof timeString !== 'string' || timeString === 'غير محدد') return [];
                        return timeString.split('<br>').map(entry => {
                            const parts = entry.match(/([\u0621-\u064A\s]+):\s*(\d{1,2}:\d{2})\s*(ص|م)\s*-\s*(\d{1,2}:\d{2})\s*(ص|م)/);
                            if (!parts) return null;
                            const days = parts[1].trim().split(/\s+/);
                            const start = this._convertTo24Hour(parts[2], parts[3]);
                            const end = this._convertTo24Hour(parts[4], parts[5]);
                            return days.map(day => this.constants.DAY_MAPPING[day] !== undefined ? { day: this.constants.DAY_MAPPING[day], start, end } : null);
                        }).flat().filter(Boolean);
                    },
                    _convertTo24Hour(time, period) {
                        let[h,m] = time.split(':');
                        h = parseInt(h, 10);
                        if (period.includes('م') && h !== 12) h += 12;
                        if (period.includes('ص') && h === 12) h = 0;
                        return `${String(h).padStart(2, '0')}:${m}:00`;
                    },
                     _setupEventListeners() {
                        this.dom.clearCalendarBtn?.addEventListener('click', () => this._handleClearCalendar());
                        this.dom.settingsBtn?.addEventListener('click', () => this._toggleSettingsModal(true));
                        this.dom.mobileSettingsBtn?.addEventListener('click', () => this._toggleSettingsModal(true));
                        this.dom.modalOverlay.addEventListener('click', () => this._toggleSettingsModal(false));
                        this.dom.tabButtons.forEach(button => button.addEventListener('click', () => this._handleTabClick(button)));
                        
                        const courseLists = [this.dom.desktopCoursesList, this.dom.mobileCoursesList];
                        courseLists.forEach(list => {
                            if(list) {
                                list.addEventListener('click', e => this._handleCourseListClick(e));
                                list.addEventListener('mouseover', e => this._handleSectionHover(e, true));
                                list.addEventListener('mouseout', e => this._handleSectionHover(e, false));
                            }
                        });

                        if(isMobile) {
                            this.dom.mobileNavButtons.forEach(btn => btn.addEventListener('click', () => this._handleMobileNav(btn)));
                            this.dom.mobileSectionDetailsOverlay.addEventListener('click', (e) => {
                                if(e.target === this.dom.mobileSectionDetailsOverlay) {
                                    this._hideMobileSectionDetails();
                                }
                            });
                        }
                    },
                    _handleSectionHover(event, isHovering) {
                        if (isMobile) return;
                        const sectionBtn = event.target.closest('.section-btn');
                        if (!sectionBtn) return;
                        if (isHovering) {
                            const section = this.state.allCoursesData.find(c => c.uniqueId === sectionBtn.dataset.uniqueId);
                            if (section) this._showPreviewEvent(section);
                        } else {
                            this._removePreviewEvent();
                        }
                    },
                    _showPreviewEvent(section) {
                        this._removePreviewEvent();
                        const group = this.state.groupedCourses[section.code];
                        if (!group) return;
                        const previewEventSource = this._createLectureEventsForSection(section, true, group.color);
                        this.state.calendar.addEventSource(previewEventSource);
                    },
                    _removePreviewEvent() {
                        const existingSource = this.state.calendar.getEventSourceById('preview-source');
                        if (existingSource) existingSource.remove();
                    },
                    _handleCourseListClick(e) {
                        const sectionBtn = e.target.closest('.section-btn');
                        const header = e.target.closest('.course-item-header');
                        if (sectionBtn) {
                            const uniqueId = sectionBtn.dataset.uniqueId;
                            const section = this.state.allCoursesData.find(c => c.uniqueId === uniqueId);
                            if (!section) return;
                            const group = this.state.groupedCourses[section.code];
                            const activeSchedule = this.state.schedules[this.state.activeScheduleIndex];
                            if (!activeSchedule) return;

                            if (isMobile) {
                                this._showMobileSectionDetails(section, group);
                            } else {
                                if (activeSchedule.sections.has(uniqueId)) {
                                    this._removeSectionAndUnlink(uniqueId, activeSchedule);
                                } else {
                                    this._addSectionAndLink(uniqueId, activeSchedule);
                                }
                                this.updateCalendarAndConflicts();
                            }
                        } else if (header) {
                            const courseItem = header.parentElement;
                            const isOpening = !courseItem.classList.contains('open');
                            courseItem.classList.toggle('open');
                            if (isOpening) {
                                const sections = courseItem.querySelectorAll('.section-btn');
                                sections.forEach((section, index) => {
                                    section.style.animationDelay = `${index * 25}ms`;
                                });
                            }
                        }
                    },
                     _addSectionAndLink(sectionId, schedule) {
                        const section = this.state.allCoursesData.find(s => s.uniqueId === sectionId);
                        if (!section) return false;
                        
                        const tempSelectedDetails = Array.from(schedule.sections).map(id => this.state.allCoursesData.find(c => c.uniqueId === id)).filter(Boolean);
                        if(this._isSectionConflicted(section, tempSelectedDetails)) {
                             if(isMobile){ this._showToast('warning', 'تنبيه: الشعبة المضافة متعارضة.'); }
                        }
                        
                        schedule.sections.add(sectionId);

                        const linkedGroup = this.state.linkedCourseGroups[section.name];
                        if (linkedGroup) {
                            const otherCourseCodes = linkedGroup.filter(code => code !== section.code);
                            for (const otherCode of otherCourseCodes) {
                                const correspondingSection = this.state.groupedCourses[otherCode]?.sections.find(s => s.section === section.section);
                                if (!correspondingSection || schedule.sections.has(correspondingSection.uniqueId)) continue;
                                 if (this.state.userSettings.hideClosedCourses && correspondingSection.status.includes('مغلقة')) {
                                    this._showToast('info', `الشعبة المرتبطة ${correspondingSection.code}-${correspondingSection.section} مغلقة.`);
                                    continue;
                                }
                                schedule.sections.add(correspondingSection.uniqueId);
                                
                                if(!schedule.linkedSections.has(sectionId)) schedule.linkedSections.set(sectionId, new Set());
                                schedule.linkedSections.get(sectionId).add(correspondingSection.uniqueId);

                                this._showToast('success', `تمت إضافة شعبة مرتبطة: ${correspondingSection.code}-${correspondingSection.section}`);
                            }
                        }
                        return true; 
                    },
                    _removeSectionAndUnlink(sectionId, schedule) {
                        schedule.sections.delete(sectionId);
                        if (schedule.linkedSections.has(sectionId)) {
                            const linkedIds = schedule.linkedSections.get(sectionId);
                            linkedIds.forEach(id => schedule.sections.delete(id));
                            schedule.linkedSections.delete(sectionId);
                            if(linkedIds.size > 0) this._showToast('info', 'تمت إزالة الشعب المرتبطة.');
                        }
                        for (const [triggerId, linkedIds] of schedule.linkedSections.entries()) {
                            if (linkedIds.has(sectionId)) {
                                schedule.sections.delete(triggerId);
                                linkedIds.forEach(id => schedule.sections.delete(id));
                                schedule.linkedSections.delete(triggerId);
                                this._showToast('info', 'تمت إزالة المجموعة المرتبطة.');
                                break; 
                            }
                        }
                        return true;
                    },
                    _handleClearCalendar() {
                        const activeSchedule = this.state.schedules[this.state.activeScheduleIndex];
                        if (!activeSchedule || activeSchedule.sections.size === 0) {
                            this._showToast('info', 'الجدول الحالي فارغ بالفعل');
                            return;
                        }
                        Swal.fire({
                            title: 'هل أنت متأكد؟', text: `سيتم مسح جميع المواد المختارة من "${activeSchedule.name}".`, icon: 'warning',
                            showCancelButton: true, confirmButtonText: 'نعم، امسح الجدول!', cancelButtonText: 'إلغاء',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                activeSchedule.sections.clear();
                                activeSchedule.linkedSections.clear();
                                this.updateCalendarAndConflicts();
                                this._showToast('success', 'تم مسح الجدول بنجاح');
                            }
                        });
                    },
                    _showToast(icon, title) {
                         Swal.fire({ 
                            toast: true, 
                            position: isMobile ? 'bottom' : 'bottom-end', 
                            icon: icon, 
                            title: title, 
                            showConfirmButton: false, 
                            timer: 3000, 
                            timerProgressBar: true,
                            customClass: { popup: 'swal2-toast' },
                            showClass: { popup: 'swal-toast-enter' },
                            hideClass: { popup: 'swal-toast-exit' },
                        });
                    },
                    _handleTabClick(button) {
                        const parentSidebar = button.closest('.sidebar');
                        parentSidebar.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        parentSidebar.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                        document.getElementById(button.dataset.tab).classList.add('active');
                    },
                    _handleMobileNav(button) {
                        const view = button.dataset.view;
                        this.dom.mobileNavButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        this.dom.mobileViewContents.forEach(content => {
                           content.style.display = 'none';
                           content.classList.remove('active');
                        });
                        const targetView = document.getElementById(view);
                        if(targetView) {
                            targetView.style.display = 'flex';
                            targetView.classList.add('active');
                        }
                        this._updateMobileHeader();
                        if (view === 'mobile-calendar-view') {
                           setTimeout(() => { 
                               if(this.state.calendar) this.state.calendar.updateSize() 
                           }, 50);
                        }
                    },
                    _updateBookmarkletCode() {
                        const code = `javascript:!function(){var e=document.createElement('script');e.src='${this.constants.EXTRACTOR_URL}?v='+Date.now(),document.head.appendChild(e)}();`;
                        const container = this.dom.installSectionContainer;
                        
                        if (isMobile) {
                             container.innerHTML = `
                                <div id="install-header">
                                    <i class="ri-smartphone-line"></i>
                                    <h2>التثبيت على الجوال</h2>
                                </div>
                                <div id="install-section-mobile">
                                    <ol>
                                        <li data-step="1">انسخ الكود التالي.</li>
                                        <li data-step="2">اذهب لصفحة "المقررات المطروحة" في موقع الجامعة.</li>
                                        <li data-step="3">الصق الكود في شريط العنوان ثم اضغط "اذهب".</li>
                                    </ol>
                                    <div class="code-container">
                                        <pre><span class="highlight">javascript:</span>!function(){var e=document.createElement('script');e.src='${this.constants.EXTRACTOR_URL}?v='+Date.now(),document.head.appendChild(e)}();</pre>
                                    </div>
                                    <button id="copy-code-btn"><i class="ri-clipboard-line"></i> نسخ الكود</button>
                                    <div class="js-warning">
                                        قد يحذف المتصفح <code>javascript:</code> تأكد من إعادتها يدوياً.
                                    </div>
                                </div>
                            `;
                            const copyBtn = container.querySelector('#copy-code-btn');
                            copyBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                navigator.clipboard.writeText(code).then(() => {
                                    this._showToast('success', 'تم نسخ الكود بنجاح!');
                                }).catch(err => {
                                    console.error('Failed to copy text: ', err);
                                    this._showToast('error', 'فشل النسخ!');
                                });
                            });
                        } else {
                            container.innerHTML = `
                                <div id="install-header">
                                    <i class="ri-drag-move-2-line"></i>
                                    <h2>التثبيت على الكمبيوتر</h2>
                                </div>
                                <p>اسحب هذا الزر إلى شريط الإشارات المرجعية في متصفحك، ثم اضغط عليه وأنت في صفحة المقررات المطروحة.</p>
                                <br>
                                <a class="bookmarklet-button" href="${code}" onclick="Swal.fire({title:'خطأ!', text:'لا تضغط على الزر، بل قم بسحبه إلى شريط الإشارات المرجعية.', icon:'error'}); return false;"><i class="ri-magic-line"></i> أداة QU Schedule</a>
                            `;
                        }
                    },
                    _initializeCalendar() {
                        if (this.state.calendar) this.state.calendar.destroy();
                        const calendarEl = document.getElementById(isMobile ? 'mobile-calendar' : 'calendar');
                        const calendarOptions = {
                            initialView: 'timeGridWeek', locale: 'ar', headerToolbar: false, allDaySlot: false, 
                            events: [], dir: 'rtl', dayHeaderFormat: { weekday: isMobile ? 'short' : 'long' }, 
                            slotMinTime: this.state.userSettings.minTime, slotMaxTime: this.state.userSettings.maxTime,
                            hiddenDays: this.state.userSettings.showWeekends ? [] : [5, 6], nowIndicator: false,
                            dayCellDidMount: (arg) => { if (arg.isToday) arg.el.style.backgroundColor = 'transparent'; },
                            eventContent: (arg) => {
                                const props = arg.event.extendedProps;
                                const wrapper = document.createElement('div');
                                wrapper.style.cssText = 'display: flex; flex-direction: column; height: 100%; overflow: hidden; font-size: 0.8rem; line-height: 1.4;';
                                wrapper.innerHTML = `<b style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: var(--font-title); font-weight: 400;">${arg.event.title.split('(')[0].trim()}</b><small>${props.section} - ${props.instructor}</small><small style="margin-top: auto;"><i class="ri-map-pin-line"></i> ${props.location}</small>`;
                                return { domNodes: [wrapper] };
                            },
                            windowResize: () => { if(this.state.calendar) this.state.calendar.updateSize(); }
                        };
                        this.state.calendar = new FullCalendar.Calendar(calendarEl, calendarOptions);
                        this.state.calendar.render();
                    },
                    _addSchedule(name, isDefault = false) {
                        let scheduleName = name;
                        if (!name) {
                            const scheduleNumber = this.state.schedules.length + 1;
                            scheduleName = `جدول ${scheduleNumber}`;
                        }
                        this.state.schedules.push({ name: scheduleName, sections: new Set(), linkedSections: new Map() });
                        if(!isDefault){
                            this.state.activeScheduleIndex = this.state.schedules.length - 1;
                            this.updateFullUI();
                        }
                    },
                    _switchSchedule(index) {
                        if (index !== this.state.activeScheduleIndex && index >= 0 && index < this.state.schedules.length) {
                            this.state.activeScheduleIndex = index;
                            this.updateFullUI();
                        }
                    },
                    _deleteSchedule(index) {
                        const scheduleName = this.state.schedules[index].name;
                        Swal.fire({
                            title: `حذف "${scheduleName}"؟`, text: "لا يمكن التراجع عن هذا الإجراء.", icon: 'warning',
                            showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'نعم، احذفه!', cancelButtonText: 'إلغاء'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                this.state.schedules.splice(index, 1);
                                if (this.state.schedules.length === 0) {
                                    this._addSchedule(null, true); 
                                }
                                
                                if (this.state.activeScheduleIndex >= index) {
                                    this.state.activeScheduleIndex = Math.max(0, this.state.activeScheduleIndex - 1);
                                }
                                
                                this.updateFullUI();
                                this._showToast('success', 'تم حذف الجدول');
                            }
                        });
                    },
                    _renameSchedule(index, newName) {
                        const trimmedName = newName.trim();
                        if (trimmedName && this.state.schedules[index]) {
                            this.state.schedules[index].name = trimmedName;
                            this._saveSchedules();
                            if (isMobile) this._updateMobileHeader();
                        } else {
                            this._renderScheduleTabs();
                        }
                    },
                    _updateMobileHeader() {
                        const activeNavBtn = document.querySelector('.mobile-nav-btn.active');
                        if (!activeNavBtn) return;
                        const currentView = activeNavBtn.dataset.view;
                        if (currentView === 'mobile-calendar-view' || currentView === 'mobile-my-schedule-view') {
                             this.dom.mobileHeaderTitle.textContent = this.state.schedules[this.state.activeScheduleIndex]?.name || 'الجدول';
                        } else if (currentView === 'mobile-courses-view') {
                             this.dom.mobileHeaderTitle.textContent = 'المقررات';
                        }
                    },
                    _adjustColorBrightness(hex, p) {
                        if (!hex || hex.length < 7) return '#7f7f7f';
                        let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                        p /= 100;
                        r = Math.round(Math.min(255, Math.max(0, r * (1 + p))));
                        g = Math.round(Math.min(255, Math.max(0, g * (1 + p))));
                        b = Math.round(Math.min(255, Math.max(0, b * (1 + p))));
                        return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
                    },
                    _hexToRgb(hex) {
                        let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                        return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '139, 92, 246';
                    },
                    _hexToHue(H) {
                        if (!H) return 257;
                        let r = 0, g = 0, b = 0;
                        if (H.length == 7) { r = parseInt("0x" + H.substring(1,3)); g = parseInt("0x" + H.substring(3,5)); b = parseInt("0x" + H.substring(5,7)); }
                        r /= 255; g /= 255; b /= 255;
                        let cmin = Math.min(r, g, b), cmax = Math.max(r, g, b), delta = cmax - cmin, h = 0;
                        if (delta == 0) h = 0;
                        else if (cmax == r) h = ((g - b) / delta) % 6;
                        else if (cmax == g) h = (b - r) / delta + 2;
                        else h = (r - g) / delta + 4;
                        h = Math.round(h * 60);
                        if (h < 0) h += 360;
                        return h;
                    },
                     _showMobileSectionDetails(section, group, shouldUpdatePanel = true) {
                        const panel = this.dom.detailsPanel;
                        const activeSchedule = this.state.schedules[this.state.activeScheduleIndex];
                        const isSelected = activeSchedule.sections.has(section.uniqueId);
                        
                        const tempSelectedDetails = Array.from(activeSchedule.sections).map(id => this.state.allCoursesData.find(c => c.uniqueId === id)).filter(Boolean);
                        const isConflicted = !isSelected && this._isSectionConflicted(section, tempSelectedDetails);
                        
                        const conflictBanner = isConflicted ? `<div class="conflict-banner"><i class="ri-alert-fill"></i> شعبة متعارضة مع جدولك الحالي</div>` : ``;

                        const courseSections = group.sections.filter(s => !this.state.userSettings.hideClosedCourses || !s.status.includes('مغلقة')).sort((a, b) => a.section.localeCompare(b.section, undefined, {numeric: true}));
                        const currentIndex = courseSections.findIndex(s => s.uniqueId === section.uniqueId);

                        const actionBtnText = isSelected ? "إزالة من الجدول" : "إضافة للجدول";
                        const actionBtnClass = isSelected ? "remove" : "add";
                        const actionBtnIcon = isSelected ? "ri-delete-bin-line" : "ri-add-line";

                        if (shouldUpdatePanel) {
                           panel.innerHTML = `
                                ${conflictBanner}
                                <div class="details-header">
                                    <h4><span class="color-dot" style="background-color: ${group.color};"></span>${section.name} (${section.code})</h4>
                                    <i class="ri-close-line details-close-btn"></i>
                                </div>
                                <div class="details-grid">
                                    <div class="detail-item"><span>الشعبة</span><strong>${section.section}</strong></div>
                                    <div class="detail-item"><span>الحالة</span><strong><span class="status-badge status-${section.status.includes('مفتوحة') ? 'open' : 'closed'}">${section.status}</span></strong></div>
                                    <div class="detail-item" data-full-width="true"><span>المحاضر</span><strong>${section.instructor || 'غير محدد'}</strong></div>
                                    <div class="detail-item" data-full-width="true"><span>المواعيد</span><strong>${section.time.replace(/<br>/g, ' / ') || 'غير محدد'}</strong></div>
                                    <div class="detail-item"><span>المكان</span><strong>${section.location || 'غير محدد'}</strong></div>
                                    <div class="detail-item"><span>الاختبار النهائي</span><strong>${section.examPeriodId || 'لا يوجد'}</strong></div>
                                </div>
                                <div class="details-actions-container">
                                    <button class="details-nav-btn" id="details-prev-btn" ${currentIndex === 0 ? 'disabled' : ''}><i class="ri-arrow-right-s-line"></i></button>
                                    <button class="details-action-btn ${actionBtnClass}" id="details-action-btn"><i class="${actionBtnIcon}"></i> ${actionBtnText}</button>
                                    <button class="details-nav-btn" id="details-next-btn" ${currentIndex === courseSections.length - 1 ? 'disabled' : ''}><i class="ri-arrow-left-s-line"></i></button>
                                </div>
                            `;
                        } else {
                            const btn = panel.querySelector('#details-action-btn');
                            btn.className = `details-action-btn ${actionBtnClass}`;
                            btn.innerHTML = `<i class="${actionBtnIcon}"></i> ${actionBtnText}`;
                            
                            const oldBanner = panel.querySelector('.conflict-banner');
                            if(oldBanner) oldBanner.remove();
                            if(conflictBanner) panel.insertAdjacentHTML('afterbegin', conflictBanner);
                        }
                        
                        panel.querySelector('.details-close-btn').onclick = () => this._hideMobileSectionDetails();
                        
                        panel.querySelector('#details-action-btn').onclick = () => {
                             let success = false;
                             if (activeSchedule.sections.has(section.uniqueId)) {
                                 success = this._removeSectionAndUnlink(section.uniqueId, activeSchedule);
                             } else {
                                 success = this._addSectionAndLink(section.uniqueId, activeSchedule);
                             }
                            
                             if (success) {
                                 this.updateCalendarAndConflicts();
                                 this._showMobileSectionDetails(section, group, false);
                             }
                        };
                        
                        const prevBtn = panel.querySelector('#details-prev-btn');
                        if (prevBtn) {
                           prevBtn.disabled = currentIndex <= 0;
                           prevBtn.onclick = () => { if(currentIndex > 0) this._showMobileSectionDetails(courseSections[currentIndex - 1], group, true)};
                        }
                        
                        const nextBtn = panel.querySelector('#details-next-btn');
                        if (nextBtn) {
                           nextBtn.disabled = currentIndex >= courseSections.length - 1;
                           nextBtn.onclick = () => { if(currentIndex < courseSections.length - 1) this._showMobileSectionDetails(courseSections[currentIndex + 1], group, true)};
                        }

                        if(shouldUpdatePanel) {
                           this.dom.mobileSectionDetailsOverlay.classList.add('open');
                        }
                    },
                    _hideMobileSectionDetails() {
                        this.dom.mobileSectionDetailsOverlay.classList.remove('open');
                    },
                    _handleViewAllConflicts(conflictMap) {
                        const allConflictingIds = new Set(conflictMap.keys());
                        const conflictingSections = Array.from(allConflictingIds).map(id => this.state.allCoursesData.find(c => c.uniqueId === id)).filter(Boolean);
                        
                        const visited = new Set();
                        const conflictGroups = [];

                        conflictingSections.forEach(section => {
                            if (!visited.has(section.uniqueId)) {
                                const group = new Set([section]);
                                visited.add(section.uniqueId);
                                const queue = [section];
                                
                                while(queue.length > 0) {
                                    const current = queue.shift();
                                    conflictingSections.forEach(other => {
                                        if(!visited.has(other.uniqueId)) {
                                            if (this._isSectionConflicted(current, [other])) {
                                                visited.add(other.uniqueId);
                                                group.add(other);
                                                queue.push(other);
                                            }
                                        }
                                    });
                                }
                                if(group.size > 1) conflictGroups.push(Array.from(group));
                            }
                        });

                        const modalHTML = conflictGroups.map((group, groupIndex) => {
                            const groupItemsHTML = group.sort((a,b) => a.code.localeCompare(b.code)).map((section, itemIndex) => {
                                const detailsId = `details-${groupIndex}-${itemIndex}`;
                                return `<div class="conflict-item">
                                    <div class="conflict-item-flex">
                                        <label class="conflict-item-main-label">
                                            <input type="radio" name="conflict-group-${groupIndex}" value="${section.uniqueId}" ${itemIndex === 0 ? 'checked' : ''}>
                                            <div class="custom-radio"></div>
                                            <div class="conflict-item-info">
                                                <h4>${section.name}</h4>
                                                <span>${section.code} - شعبة ${section.section}</span>
                                            </div>
                                        </label>
                                        <button type="button" class="conflict-details-btn" data-details-id="${detailsId}">تفاصيل</button>
                                    </div>
                                    <div class="conflict-extra-details" id="${detailsId}">
                                        <div><strong>المحاضر:</strong> ${section.instructor || 'غير محدد'}</div>
                                        <div><strong>المواعيد:</strong> ${section.time.replace(/<br>/g, ' / ') || 'غير محدد'}</div>
                                        <div><strong>المكان:</strong> ${section.location || 'غير محدد'}</div>
                                    </div>
                                </div>`;
                            }).join('');
                            
                            return `<div class="conflict-group-container">
                                <div class="conflict-group-title">مجموعة التعارض ${this._toArabicNumerals(groupIndex + 1)}</div>
                                ${groupItemsHTML}
                            </div>`;
                        }).join('');

                        Swal.fire({
                            title: 'حل جميع التعارضات',
                            html: `<div id="conflict-modal-content" class="custom-scrollbar">${modalHTML || '<p>لا توجد مجموعات تعارض واضحة.</p>'}</div>`,
                            icon: 'warning', confirmButtonText: 'حفظ التغييرات',
                            showCancelButton: true, cancelButtonText: 'إلغاء',
                            customClass: { popup: 'swal2-popup wide-swal' },
                            didOpen: (popup) => {
                                popup.querySelectorAll('.conflict-details-btn').forEach(btn => {
                                    btn.addEventListener('click', (e) => {
                                        e.preventDefault();
                                        const detailsEl = document.getElementById(btn.dataset.detailsId);
                                        if (detailsEl) detailsEl.classList.toggle('visible');
                                    });
                                });
                            },
                            preConfirm: () => {
                                const sectionsToRemove = new Set();
                                conflictGroups.forEach((group, groupIndex) => {
                                    const selectedRadio = Swal.getPopup().querySelector(`input[name="conflict-group-${groupIndex}"]:checked`);
                                    if(selectedRadio){
                                        const selectedId = selectedRadio.value;
                                        group.forEach(section => {
                                            if (section.uniqueId !== selectedId) {
                                                sectionsToRemove.add(section.uniqueId);
                                            }
                                        });
                                    }
                                });
                                return Array.from(sectionsToRemove);
                            }
                        }).then((result) => {
                            if (result.isConfirmed && Array.isArray(result.value)) {
                                const sectionsToRemove = result.value;
                                if (sectionsToRemove.length > 0) {
                                    const activeSchedule = this.state.schedules[this.state.activeScheduleIndex];
                                    sectionsToRemove.forEach(id => this._removeSectionAndUnlink(id, activeSchedule));
                                    this.updateFullUI();
                                    this._showToast('success', `تم حل التعارضات وإزالة ${this._toArabicNumerals(sectionsToRemove.length)} شعبة.`);
                                } else {
                                     this._showToast('info', 'لم يتم إجراء أي تغييرات.');
                                }
                            }
                        });
                    },
                    _loadSettings() {
                        const saved = localStorage.getItem(this.constants.STORAGE_KEYS.SETTINGS);
                        if (saved) {
                            try {
                                this.state.userSettings = { ...this.state.userSettings, ...JSON.parse(saved) };
                                this.state.hiddenCourseCodes = new Set(this.state.userSettings.hiddenCourseCodes || []);
                            } catch (e) {
                                console.error("Could not load settings:", e);
                                localStorage.removeItem(this.constants.STORAGE_KEYS.SETTINGS);
                            }
                        }
                        this._applySettings();
                    },
                    _saveSettings() {
                        this.state.userSettings.hiddenCourseCodes = Array.from(this.state.hiddenCourseCodes);
                        localStorage.setItem(this.constants.STORAGE_KEYS.SETTINGS, JSON.stringify(this.state.userSettings));
                    },
                    _buildSettingsModal() {
                        const modal = this.dom.settingsModal;
                        let courseColorsHTML = Object.values(this.state.groupedCourses).sort((a,b)=>a.code.localeCompare(b.code)).map(g=>`<div class="settings-item"><div class="settings-item-label"><span style="color:${g.color};font-weight:600;">${g.name} (${g.code})</span></div><label class="color-picker-label" style="background-color:${g.color};"><input type="color" class="color-picker-input" data-course-code="${g.code}" value="${g.color}"></label></div>`).join('');
                        if (!courseColorsHTML) courseColorsHTML = '<p style="color:var(--color-text-muted);font-size:0.9rem;">لم يتم تحميل بيانات المقررات بعد.</p>';
                        let courseVisibilityHTML = Object.values(this.state.groupedCourses).sort((a,b)=>a.code.localeCompare(b.code)).map(g=>{
                            const isHidden = this.state.hiddenCourseCodes.has(g.code);
                            return`<button class="course-visibility-btn ${isHidden?'hidden':'visible'}" data-course-code="${g.code}" style="--item-color:${g.color};--item-color-rgb:${this._hexToRgb(g.color)};"><span class="color-dot"></span>${g.code}</button>`;
                        }).join('');
                        if (!courseVisibilityHTML) courseVisibilityHTML = '<p style="color:var(--color-text-muted);font-size:0.9rem;">لم يتم تحميل بيانات المقررات بعد.</p>';
                        modal.innerHTML = `
                            <div class="modal-header"><h3><i class="ri-settings-3-line"></i> الإعدادات</h3><i class="ri-close-line modal-close-btn"></i></div>
                            <div class="modal-content custom-scrollbar">
                                <div class="settings-group"><h4 class="settings-group-title"><i class="ri-palette-line"></i>المظهر</h4><div class="settings-item"><div class="settings-item-label"><span>الوضع</span></div><div class="mode-toggle"></div></div><div class="settings-item"><div class="settings-item-label"><span>اللون الأساسي</span></div><div class="theme-picker" id="accent-color-picker"></div></div></div>
                                <div class="settings-group"><h4 class="settings-group-title"><i class="ri-filter-3-line"></i>ترشيح المقررات</h4><div class="settings-item"><div class="settings-item-label"><span>إخفاء الشعب المغلقة</span><small>لإزالة الشعب غير المتاحة من القائمة</small></div><label class="toggle-switch"><input type="checkbox" id="hide-closed-toggle"><span class="slider"></span></label></div><h4 class="settings-group-title" style="margin-top:2rem;"><i class="ri-eye-off-line"></i>التحكم في ظهور المقررات</h4><div id="course-visibility-list" class="course-visibility-grid">${courseVisibilityHTML}</div></div>
                                <div class="settings-group"><h4 class="settings-group-title"><i class="ri-paint-brush-line"></i>ألوان المقررات</h4><div id="course-colors-list">${courseColorsHTML}</div></div>
                                <div class="settings-group"><h4 class="settings-group-title"><i class="ri-calendar-2-line"></i>عرض التقويم</h4><div class="settings-item"><div class="settings-item-label"><span>إظهار عطلة نهاية الأسبوع</span><small>لعرض يومي الجمعة والسبت</small></div><label class="toggle-switch"><input type="checkbox" id="show-weekend-toggle"><span class="slider"></span></label></div><div class="settings-item"><div class="settings-item-label"><span>نطاق الساعات</span></div><div class="time-range-selects"><div id="min-time-select-container"></div><div id="max-time-select-container"></div></div></div></div>
                                <div class="settings-group"><h4 class="settings-group-title"><i class="ri-database-2-line"></i>إدارة البيانات</h4><div class="data-management-zone"><button class="data-btn" id="export-btn"><i class="ri-download-cloud-2-line"></i>تصدير الجدول الحالي</button><button class="data-btn" id="import-btn"><i class="ri-upload-cloud-2-line"></i>استيراد جدول</button><input type="file" id="import-file-input" accept=".json" style="display:none;"><button class="data-btn danger" id="reset-app-btn"><i class="ri-restart-line"></i>إعادة تعيين التطبيق</button></div></div>
                            </div>`;
                        this._attachModalEventListeners();
                        this._populateTimeSelects();
                        this._applySettings();
                    },
                    _attachModalEventListeners() {
                        const modal = this.dom.settingsModal;
                        modal.querySelector('.modal-close-btn').addEventListener('click', () => this._toggleSettingsModal(false));
                        modal.querySelector('#course-colors-list').addEventListener('input', e => this._handleCourseColorChange(e));
                        modal.querySelector('#course-visibility-list').addEventListener('click', e => this._handleVisibilityToggle(e));
                        modal.querySelector('#export-btn').addEventListener('click', () => this._handleExport());
                        modal.querySelector('#import-btn').addEventListener('click', () => modal.querySelector('#import-file-input').click());
                        modal.querySelector('#import-file-input').addEventListener('change', e => this._handleImport(e));
                        modal.querySelector('#reset-app-btn').addEventListener('click', () => this._handleReset());
                    },
                    _handleCourseColorChange(e) {
                        if (e.target.matches('.color-picker-input')) {
                            const code = e.target.dataset.courseCode;
                            const color = e.target.value;
                            this.state.customColors[code] = color;
                            if (this.state.groupedCourses[code]) {
                                this.state.groupedCourses[code].color = color;
                            }
                            this._saveCustomColors();
                            this.updateFullUI();
                            this._buildSettingsModal();
                        }
                    },
                    _handleVisibilityToggle(e) {
                        const btn = e.target.closest('.course-visibility-btn');
                        if (!btn) return;
                        const code = btn.dataset.courseCode;
                        if (this.state.hiddenCourseCodes.has(code)) {
                            this.state.hiddenCourseCodes.delete(code);
                            btn.classList.remove('hidden');
                            btn.classList.add('visible');
                        } else {
                            this.state.hiddenCourseCodes.add(code);
                            btn.classList.add('hidden');
                            btn.classList.remove('visible');
                        }
                        this._saveSettings();
                        this._renderCoursesList();
                    },
                    _handleExport() {
                        const activeSchedule = this.state.schedules[this.state.activeScheduleIndex];
                        if (!activeSchedule || activeSchedule.sections.size === 0) {
                            return Swal.fire('الجدول الحالي فارغ!', 'الرجاء اختيار بعض الشعب أولاً.', 'warning');
                        }
                        const dataStr = JSON.stringify({ version: 20, schedule: Array.from(activeSchedule.sections), linked: Array.from(activeSchedule.linkedSections.entries()).map(([k, v]) => [k, Array.from(v)]) });
                        const blob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `qu_schedule_${activeSchedule.name.replace(/[^a-z0-9]/gi,'_').toLowerCase()}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    },
                    _handleImport(e) {
                        const file = e.target.files[0];
                        if (!file) return;
                        if(this.state.allCoursesData.length === 0){
                             Swal.fire('خطأ!', 'يجب تحميل بيانات المقررات أولاً قبل استيراد جدول.', 'error');
                             e.target.value = '';
                             return;
                        }
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const data = JSON.parse(event.target.result);
                                if (data && data.schedule && Array.isArray(data.schedule)) {
                                    const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                                    const newName = `مستورد ${time}`;
                                    this._addSchedule(newName, false);
                                    const newSchedule = this.state.schedules[this.state.schedules.length-1];
                                    data.schedule.forEach(id => {
                                        if (this.state.allCoursesData.some(c => c.uniqueId === id)) {
                                            newSchedule.sections.add(id);
                                        }
                                    });
                                    if(data.linked && Array.isArray(data.linked)) {
                                        newSchedule.linkedSections = new Map(data.linked.map(([k, v]) => [k, new Set(v)]));
                                    }
                                    this.updateFullUI();
                                    this._toggleSettingsModal(false);
                                    this._showToast('success', 'تم استيراد الجدول بنجاح!');
                                } else throw new Error('Invalid file format');
                            } catch (error) { Swal.fire('خطأ!', 'ملف غير صالح أو تالف.', 'error'); }
                        };
                        reader.readAsText(file);
                        e.target.value = '';
                    },
                    _handleReset() {
                        Swal.fire({
                            title: 'هل أنت متأكد؟',
                            text: "سيؤدي هذا إلى مسح جميع بيانات التطبيق، بما في ذلك جميع الجداول المحفوظة والإعدادات.",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            confirmButtonText: 'نعم، إعادة تعيين!',
                            cancelButtonText: 'إلغاء'
                        }).then(r => {
                            if (r.isConfirmed) {
                                localStorage.clear();
                                location.reload();
                            }
                        });
                    },
                    _toggleSettingsModal(show) {
                        this.dom.modalOverlay.classList.toggle('open', show);
                        this.dom.settingsModal.classList.toggle('open', show);
                    },
                    _applySettings() {
                        document.body.className = this.state.userSettings.theme === 'light' ? 'light' : '';
                        if (isMobile) {
                            document.body.classList.add('mobile-view');
                        } else {
                            document.body.classList.add('desktop-view');
                        }

                        const pColor = this.state.userSettings.accentColor;
                        const pDark = this._adjustColorBrightness(pColor, -10);
                        const pRgb = this._hexToRgb(pColor);
                        const pHue = this._hexToHue(pColor);
                        document.documentElement.style.setProperty('--color-primary', pColor);
                        document.documentElement.style.setProperty('--color-primary-dark', pDark);
                        document.documentElement.style.setProperty('--rgb-primary', pRgb);
                        document.documentElement.style.setProperty('--primary-hue', String(pHue));
                        document.documentElement.style.setProperty('--secondary-hue', String((pHue + 40) % 360));
                        
                        const modeToggle = this.dom.settingsModal.querySelector('.mode-toggle');
                        if (modeToggle) {
                            modeToggle.innerHTML = `<button class="mode-btn ${this.state.userSettings.theme==='dark'?'active':''}" data-theme="dark">ظلام</button><button class="mode-btn ${this.state.userSettings.theme==='light'?'active':''}" data-theme="light">نهار</button>`;
                            modeToggle.onclick = e => {
                                if (e.target.matches('.mode-btn')) {
                                    this.state.userSettings.theme = e.target.dataset.theme;
                                    this._saveSettings();
                                    this._applySettings();
                                }
                            };
                        }
                        this._populateAccentColorPicker();
                        
                        const weekendToggle = this.dom.settingsModal.querySelector('#show-weekend-toggle');
                        if (weekendToggle) {
                            weekendToggle.checked = this.state.userSettings.showWeekends;
                            weekendToggle.onchange = e => {
                                this.state.userSettings.showWeekends = e.target.checked;
                                this._saveSettings();
                                this._initializeCalendar();
                                this.updateCalendarAndConflicts();
                            };
                        }
                        
                        const closedToggle = this.dom.settingsModal.querySelector('#hide-closed-toggle');
                        if (closedToggle) {
                            closedToggle.checked = this.state.userSettings.hideClosedCourses;
                            closedToggle.onchange = e => {
                                this.state.userSettings.hideClosedCourses = e.target.checked;
                                this._saveSettings();
                                this._renderCoursesList();
                                this.updateCalendarAndConflicts();
                            };
                        }
                    },
                    _populateAccentColorPicker() {
                        const picker = this.dom.settingsModal.querySelector('#accent-color-picker');
                        if (!picker) return;
                        picker.innerHTML = '';
                        Object.values(this.constants.PRESET_COLORS).forEach(c => {
                            const dot = document.createElement('div');
                            dot.className = `theme-dot ${this.state.userSettings.accentColor === c ? 'active' : ''}`;
                            dot.style.backgroundColor = c;
                            dot.onclick = () => {
                                this.state.userSettings.accentColor = c;
                                this._saveSettings();
                                this._applySettings();
                            };
                            picker.appendChild(dot);
                        });
                        const isCustom = !Object.values(this.constants.PRESET_COLORS).includes(this.state.userSettings.accentColor);
                        const customLabel = document.createElement('label');
                        customLabel.className = `color-picker-label ${isCustom ? 'active' : ''}`;
                        customLabel.style.backgroundColor = isCustom ? this.state.userSettings.accentColor : 'transparent';
                        customLabel.style.backgroundImage = isCustom ? 'none' : 'conic-gradient(red, yellow, lime, aqua, blue, magenta, red)';

                        customLabel.innerHTML = `<input type="color" class="color-picker-input" value="${this.state.userSettings.accentColor}">`;
                        customLabel.querySelector('input').oninput = e => {
                            this.state.userSettings.accentColor = e.target.value;
                            this._saveSettings();
                            this._applySettings();
                        };
                        picker.appendChild(customLabel);
                    },
                    _populateTimeSelects() {
                        const minContainer = this.dom.settingsModal.querySelector('#min-time-select-container');
                        const maxContainer = this.dom.settingsModal.querySelector('#max-time-select-container');
                        if (!minContainer || !maxContainer) return;
                        const timeOpts = Array.from({ length: 24 }, (_, i) => ({ value: `${String(i).padStart(2,'0')}:00:00`, label: `${String(i).padStart(2,'0')}:00` }));
                        this._createActionPicker(minContainer, timeOpts, this.state.userSettings.minTime, val => {
                            this.state.userSettings.minTime = val;
                            this._saveSettings();
                            this._initializeCalendar();
                            this.updateCalendarAndConflicts();
                        });
                        this._createActionPicker(maxContainer, timeOpts, this.state.userSettings.maxTime, val => {
                            this.state.userSettings.maxTime = val;
                            this._saveSettings();
                            this._initializeCalendar();
                            this.updateCalendarAndConflicts();
                        });
                    },
                    _createActionPicker(container, opts, val, onChange) {
                        container.innerHTML = '';
                        let isOpen = false;
                        const wrapper = document.createElement('div');
                        wrapper.className = 'action-picker-wrapper';
                        const selected = opts.find(o => o.value === val) || opts[0];
                        const display = document.createElement('button');
                        display.type = 'button';
                        display.className = 'action-picker-display';
                        display.textContent = selected.label;
                        const panel = document.createElement('div');
                        panel.className = 'action-picker-panel';
                        panel.style.display = 'none';
                        opts.forEach(o => {
                            const btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = `action-picker-option ${val === o.value ? 'selected' : ''}`;
                            btn.textContent = o.label;
                            btn.onclick = () => {
                                onChange(o.value);
                                display.textContent = o.label;
                                panel.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                                btn.classList.add('selected');
                                closePanel();
                            };
                            panel.appendChild(btn);
                        });
                        const openPanel = () => { isOpen = true; panel.style.display = 'block'; };
                        const closePanel = () => { isOpen = false; panel.style.display = 'none'; };
                        display.onclick = () => isOpen ? closePanel() : openPanel();
                        wrapper.appendChild(display);
                        wrapper.appendChild(panel);
                        container.appendChild(wrapper);
                        document.addEventListener('click', (e) => {
                            if (!wrapper.contains(e.target)) closePanel();
                        });
                    }
                });

                QU_ScheduleApp.init();
            });
        </script>
    </body>
</html>
