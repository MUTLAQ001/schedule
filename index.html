<!DOCTYPE html>
<html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>QU Schedule</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
        <meta name="theme-color" content="#0a0a0a">
        <style>
            :root {
                --color-primary: #8b5cf6;
                --color-primary-dark: #7c3aed;
                --color-danger: #ff5252;
                --color-warning: #ffc400;
                --color-success: #00c853;
                --color-bg: #0a0a0a;
                --color-card: rgba(20, 20, 22, 0.75);
                --color-border: rgba(255, 255, 255, 0.1);
                --color-text: #e0e0e0;
                --color-text-muted: #9e9e9e;
                --color-text-dark: #ffffff;
                --font-body: "Cairo", sans-serif;
                --font-title: "IBM Plex Sans Arabic", sans-serif;
                --radius: 20px;
                --radius-md: 16px;
                --radius-full: 999px;
                --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                --transition-smooth: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
                --rgb-primary: 139, 92, 246;
                --rgb-warning: 255, 196, 0;
                --rgb-danger: 255, 82, 82;
                --rgb-success: 0, 200, 83;
                --primary-hue: 257;
                --secondary-hue: 287;
            }

            .light {
                --color-primary: #7c3aed;
                --color-primary-dark: #6d28d9;
                --color-danger: #ef4444;
                --color-warning: #d97706;
                --color-success: #16a34a;
                --color-bg: #f4f4f5;
                --color-card: rgba(255, 255, 255, 0.75);
                --color-border: rgba(0, 0, 0, 0.09);
                --color-text: #18181b;
                --color-text-muted: #71717a;
                --color-text-dark: #18181b;
            }

            @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px) } to { opacity: 1; transform: translateY(0) } }
            @keyframes scaleIn { from { opacity: 0; transform: scale(.95) } to { opacity: 1; transform: scale(1) } }
            @keyframes gradient-animation { 0% { background-position: 0% 50% } 50% { background-position: 100% 50% } 100% { background-position: 0% 50% } }
            @keyframes swal-scale-in { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
            @keyframes swal-scale-out { from { transform: scale(1); opacity: 1; } to { transform: scale(0.9); opacity: 0; } }

            *, *::before, *::after { box-sizing: border-box; }
            html { scroll-behavior: smooth; }
            body {
                font-family: var(--font-body);
                background-color: var(--color-bg);
                color: var(--color-text);
                margin: 0;
                height: 100vh;
                width: 100vw;
                overflow: hidden;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            .cosmic-bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden }
            #starfield-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100% }
            .nebula-glow {
                position: absolute; top: 50%; left: 50%;
                width: 80vmax; height: 80vmax; margin-top: -40vmax; margin-left: -40vmax;
                background: radial-gradient(circle,hsl(var(--primary-hue),90%,60%,.15) 0%,hsl(var(--secondary-hue),80%,50%,.1) 40%,transparent 70%);
                filter: blur(100px); border-radius: 50%;
            }

            #install-section {
                position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%); z-index: 1000;
                background-color: var(--color-card); padding: 1.5rem 2rem; border-radius: var(--radius);
                box-shadow: 0 16px 40px -12px rgba(0,0,0,0.4); border: 1px solid var(--color-border);
                width: 90%; max-width: 600px; text-align: center; display: none;
                backdrop-filter: blur(16px); animation: scaleIn .5s var(--transition) both;
            }
            .bookmarklet-button {
                display: inline-block; background: linear-gradient(90deg, var(--color-primary-dark), var(--color-primary));
                color: white; padding: 0.7rem 1.5rem; border-radius: var(--radius-full);
                font-weight: 600; text-decoration: none; cursor: grab;
            }
            
            .custom-scrollbar::-webkit-scrollbar { width: 8px; }
            .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(var(--rgb-primary), 0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(var(--rgb-primary), 0.5); }
            .custom-scrollbar { scrollbar-width: thin; scrollbar-color: rgba(var(--rgb-primary), 0.3) transparent; }

            /* Desktop Styles */
            .page-wrapper { display: flex; height: 100vh; }
            .main-content { flex-grow: 1; height: 100%; display: flex; flex-direction: column; padding: 2rem; gap: 1.5rem; overflow-y: auto; }
            .sidebar { width: 420px; height: 100%; background-color: var(--color-card); border-left: 1px solid var(--color-border); display: flex; flex-direction: column; flex-shrink: 0; backdrop-filter: blur(16px); }
            .main-header { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; animation: fadeInUp .8s var(--transition-smooth) both; }
            .main-header h1 {
                font-family: var(--font-title); font-weight: 700; font-size: 2.5rem;
                background: linear-gradient(90deg,var(--color-primary-dark),var(--color-primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
                background-size: 200% 200%; animation: gradient-animation 5s ease-in-out infinite;
                display: flex; align-items: center; gap: 1rem;
            }
            .header-actions { display: flex; gap: 0.75rem; }
            .header-actions button {
                background: rgba(var(--rgb-primary), 0.1); border: 1px solid var(--color-border); color: var(--color-primary);
                padding: 0.6rem 1.2rem; border-radius: var(--radius-full); font-size: 0.9rem; font-weight: 600; cursor: pointer;
                display: inline-flex; align-items: center; gap: 0.5rem; transition: all var(--transition);
            }
            .header-actions button:hover { background: rgba(var(--rgb-primary), 0.2); border-color: var(--color-primary); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(var(--rgb-primary), 0.2); }
            .card { width: 100%; height: 100%; background-color: var(--color-card); border: 1px solid var(--color-border); border-radius: var(--radius); display: flex; flex-direction: column; backdrop-filter: blur(16px); box-shadow: 0 16px 40px -12px rgba(0,0,0,0.4); overflow: hidden; animation: scaleIn .8s var(--transition-smooth) .2s both; }
            .schedule-tabs-container { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: var(--radius); flex-shrink: 0; animation: fadeInUp .8s var(--transition-smooth) .1s both; overflow-x: auto;}
            .schedule-tab { padding: 0.6rem 1.2rem; border: none; border-radius: var(--radius-md); background: transparent; color: var(--color-text-muted); font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; }
            .schedule-tab.active { background: var(--color-primary); color: white; box-shadow: 0 4px 15px rgba(var(--rgb-primary), 0.2); }
            .schedule-tab-name { outline: none; }
            .schedule-tab .delete-schedule-btn { font-size: 1.1rem; color: rgba(255,255,255,0.6); background: none; border: none; padding: 0; margin-right: -5px; display: none; cursor: pointer; }
            .schedule-tab.active .delete-schedule-btn { display: inline-block; }
            .schedule-tab.active .delete-schedule-btn:hover { color: white; }
            #add-schedule-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(var(--rgb-primary), 0.1); color: var(--color-primary); border: 1px solid var(--color-border); font-size: 1.5rem; cursor: pointer; transition: var(--transition); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
            #add-schedule-btn:hover { background: var(--color-primary); color: white; transform: rotate(90deg); }
            .calendar-wrapper { flex: 1 1 auto; min-height: 500px; }
            .calendar-wrapper .card { padding: 1.5rem; }
            #calendar { height: 100%; }
            .sidebar-header { padding: 1.5rem 2rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
            .sidebar-header h2 { margin: 0; font-family: var(--font-title); font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; color: var(--color-text-dark); }
            .sidebar-content-wrapper { flex: 1; display: flex; flex-direction: column; min-height: 0; }
            .sidebar-tabs { display: flex; padding: 0.75rem 1rem 0; border-bottom: 1px solid var(--color-border); }
            .tab-btn { flex: 1; text-align: center; padding: 0.75rem 0.5rem; background: none; border: none; color: var(--color-text-muted); font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition); border-bottom: 2px solid transparent; }
            .tab-btn.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
            .tab-content { padding: 1rem; display: none; overflow-y: auto; flex-grow: 1; }
            .tab-content.active { display: block; }
            .sidebar-footer { padding: 1.25rem; border-top: 1px solid var(--color-border); text-align: center; flex-shrink: 0; }
            .course-item { border: 1px solid var(--color-border); border-radius: var(--radius-md); margin-bottom: 0.75rem; background-color: transparent; animation: fadeInUp .5s ease both; overflow: hidden; transition: var(--transition-smooth); box-shadow: inset 0 1px 0 rgba(255,255,255,0.07); }
            .course-item:hover { transform: translateY(-4px); border-color: rgba(var(--rgb-primary), 0.5); box-shadow: inset 0 1px 0 rgba(255,255,255,0.07), 0 8px 25px -10px rgba(0,0,0,0.4); }
            .course-item-header { display: flex; align-items: center; gap: 0.75rem; padding: 1.25rem; cursor: pointer; }
            .course-item .color-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; box-shadow: 0 0 10px 1px; }
            .course-info { flex-grow: 1; }
            .course-info h3 { margin: 0; font-family: var(--font-title); font-size: 1.1rem; font-weight: 400; color: var(--color-text-dark); }
            .course-info p { margin: 4px 0 0; font-size: 0.8rem; color: var(--color-text-muted); }
            .course-item.open .sections-wrapper { max-height: 9999px; }
            .sections-wrapper { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background-color: rgba(0,0,0,0.1); }
            .sections-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.75rem; padding: 1rem 1.25rem 1.25rem; }
            .section-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.25rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--radius-full); text-align: center; cursor: pointer; background-color: transparent; transition: all var(--transition); }
            .section-btn:hover { border-color: var(--color-primary); color: var(--color-primary); background: rgba(var(--rgb-primary), 0.1); }
            .section-btn.selected { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
            .section-btn.conflicted { background-color: rgba(var(--rgb-danger), 0.1); border-color: var(--color-danger); color: var(--color-danger); }
            .section-btn .section-type { font-size: 0.7rem; color: var(--color-text-muted); }
            .section-btn.selected .section-type { color: rgba(255,255,255,0.8); }
            .section-btn.no-time { border-bottom: 3px solid var(--item-color); padding-bottom: calc(0.5rem - 3px); }
            .my-schedule-container { flex-shrink: 0; display: none; flex-direction: column; }
            .my-schedule-container .card { animation-delay: 200ms; }
            .conflict-summary-banner { display: none; flex-shrink: 0; padding: .75rem 1.25rem; background-color: rgba(var(--rgb-warning), 0.1); color: var(--color-warning); border-bottom: 1px solid var(--color-border); align-items: center; gap: .75rem; font-weight: 600; border-top-left-radius: var(--radius); border-top-right-radius: var(--radius); }
            .conflict-summary-banner i { font-size: 1.2rem; }
            .my-schedule-section { flex: 1; min-height: 0; display: flex; flex-direction: column; padding: 1.5rem; }
            .my-schedule-section h3 { margin: 0 0 1.5rem; font-size: 1.5rem; display: flex; align-items: center; gap: .75rem; color: var(--color-primary); flex-shrink: 0; font-family: var(--font-title); }
            .my-schedule-table-wrapper { overflow-x: auto; }
            .my-schedule-table { width: 100%; border-collapse: collapse; white-space: nowrap; }
            .my-schedule-table thead th { padding: 1rem; text-align: right; font-family: var(--font-title); color: var(--color-text-muted); border-bottom: 2px solid var(--color-border); font-size: 0.9rem; }
            .my-schedule-table tbody td { padding: 1.25rem 1rem; border-bottom: 1px solid var(--color-border); vertical-align: middle; }
            .my-schedule-table tbody tr:last-child td { border-bottom: none; }
            .my-schedule-table tbody tr.has-conflict { background-color: rgba(var(--rgb-warning), 0.08) !important; }
            .my-schedule-table tbody tr:not(.has-conflict):hover { background-color: rgba(var(--rgb-primary), 0.05); }
            .my-schedule-table .course-cell .course-code { font-family: var(--font-title); font-size: 1.1rem; color: var(--color-text-dark); display: inline-flex; align-items: center; gap: 0.5rem; }
            .my-schedule-table .course-cell .conflict-icon { color: var(--color-warning); font-size: 1.2rem; cursor: help; }
            .my-schedule-table .course-cell .course-name { font-size: 0.8rem; color: var(--color-text-muted); }
            .my-schedule-table .section-cell .section-number { font-size: 1.1rem; font-weight: 600; }
            .my-schedule-table .section-cell .section-type { font-size: 0.8rem; color: var(--color-text-muted); }
            .status-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 0.8rem; font-weight: 600; }
            .status-badge::before { content: ''; display: block; width: 8px; height: 8px; border-radius: 50%; }
            .status-badge.status-open { background-color: rgba(var(--rgb-success), 0.1); color: var(--color-success); }
            .status-badge.status-open::before { background-color: var(--color-success); }
            .status-badge.status-closed { background-color: rgba(var(--rgb-danger), 0.1); color: var(--color-danger); }
            .status-badge.status-closed::before { background-color: var(--color-danger); }
            .hours-value { font-size: 1.3rem; font-weight: 700; color: var(--color-primary); }
            .my-schedule-footer { display: flex; justify-content: flex-end; padding-top: 1.5rem; }
            .total-credits-summary { padding: 0.75rem 1.5rem; font-weight: 600; background: rgba(var(--rgb-primary), 0.1); border: 1px solid rgba(var(--rgb-primary), 0.2); border-radius: var(--radius-md); font-size: 1.1rem; color: var(--color-primary); }
            .fc { --fc-border-color: var(--color-border); --fc-event-text-color: #fff; --fc-page-bg-color: transparent; font-family: var(--font-body); }
            .fc-theme-standard .fc-scrollgrid { border: none; }
            .fc-event { border: none !important; border-radius: 8px !important; font-weight: 600; padding: 4px 8px !important; cursor: pointer; }
            .fc-event.preview-event { border-style: dashed !important; border-width: 2px !important; }
            .no-data { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; padding: 2rem; color: var(--color-text-muted); }
            .no-data i { font-size: 4rem; margin-bottom: 1.5rem; color: var(--color-primary); opacity: 0.5; }
            .swal2-popup { background: var(--color-card)!important; color: var(--color-text)!important; border-radius: var(--radius)!important; border: 1px solid var(--color-border)!important; backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
            .swal2-title { color: var(--color-text-dark)!important; font-family: var(--font-title) !important; }
            .swal2-html-container { color: var(--color-text-muted)!important; margin: 1em 0 !important; font-size: 1em !important; display: block !important; }
            .swal2-confirm { background: var(--color-primary)!important; border-radius: var(--radius-full)!important; padding: .6rem 1.5rem!important; font-family: var(--font-body)!important; }
            .swal2-confirm:focus { box-shadow: 0 0 0 3px rgba(var(--rgb-primary),0.5)!important }
            .swal2-cancel { background: rgba(255,255,255,0.1)!important; color: var(--color-text)!important; border-radius: var(--radius-full)!important; padding: .6rem 1.5rem!important; font-family: var(--font-body)!important; }
            .swal-popup-animation-in { animation: swal-scale-in 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
            .swal-popup-animation-out { animation: swal-scale-out 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
            .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); z-index: 2999; opacity: 0; visibility: hidden; transition: all .3s ease; }
            .modal-overlay.open { opacity: 1; visibility: visible; }
            .settings-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); width: 90%; max-width: 550px; background-color: var(--color-card); border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 3000; opacity: 0; visibility: hidden; transition: all 0.3s; border: 1px solid var(--color-border); }
            .settings-modal.open { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
            .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
            .modal-header h3 { margin: 0; font-family: var(--font-title); font-size: 1.3rem; color: var(--color-text-dark); }
            .modal-header .modal-close-btn { cursor: pointer; font-size: 1.5rem; color: var(--color-text-muted); transition: all .2s; }
            .modal-header .modal-close-btn:hover { color: var(--color-text-dark); transform: rotate(90deg); }
            .modal-content { padding: 1.5rem; max-height: 70vh; overflow-y: auto; }
            .designer-credit { font-size: 0.9rem; font-weight: 600; color: var(--color-text-muted); text-decoration: none; transition: color 0.2s ease; display: inline-flex; align-items: center; gap: 0.5rem; }
            .designer-credit:hover { color: var(--color-primary); }
            .settings-group { margin-bottom: 2rem; }
            .settings-group-title { font-size: 1.2rem; font-weight: 600; color: var(--color-primary); padding-bottom: 0.75rem; border-bottom: 1px solid var(--color-border); margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.75rem; }
            .settings-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
            .settings-item-label { display: flex; flex-direction: column; gap: 0.25rem; flex-grow: 1; }
            .settings-item-label span { font-size: 1rem; }
            .settings-item-label small { font-size: 0.8rem; color: var(--color-text-muted); }
            .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
            .toggle-switch input { opacity: 0; width: 0; height: 0; }
            .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: .4s; border-radius: 34px; }
            .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
            input:checked + .slider { background-color: var(--color-primary); }
            input:checked + .slider:before { transform: translateX(20px); }
            .mode-toggle { display: flex; background: rgba(0,0,0,0.3); border: 1px solid var(--color-border); border-radius: 999px; padding: 4px; gap: 4px; }
            .light .mode-toggle { background: rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.08); }
            .mode-btn { padding: 0.4rem 1rem; border: none; border-radius: 999px; font-size: 0.9rem; font-weight: 600; cursor: pointer; background: transparent; color: var(--color-text-muted); transition: all 0.2s ease; }
            .mode-btn.active { background: var(--color-primary); color: #fff; box-shadow: 0 2px 5px rgba(var(--rgb-primary), 0.2); }
            .theme-picker { display: flex; gap: .5rem; align-items: center; }
            .theme-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; transition: all .2s ease; border: 2px solid transparent }
            .theme-dot:hover { transform: scale(1.2) }
            .theme-dot.active { border-color: #fff; transform: scale(1.1); }
            .light .theme-dot.active { border-color: var(--color-text-dark); }
            .color-picker-label { position: relative; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid var(--color-border); overflow: hidden; }
            .color-picker-label:hover { transform: scale(1.2); }
            .color-picker-label.active { border-color: #fff; transform: scale(1.1); }
            .light .color-picker-label.active { border-color: var(--color-text-dark); }
            .color-picker-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; border: none; padding: 0; cursor: pointer; }
            .time-range-selects { display: flex; gap: 0.5rem; }
            #course-colors-list .settings-item-label { flex-grow: 1; }
            .data-management-zone { border: 1px solid rgba(var(--rgb-warning), 0.3); border-radius: var(--radius-md); padding: 1.25rem; margin-top: 1rem; background: rgba(var(--rgb-warning), 0.05); }
            .data-btn { width: 100%; background: transparent; border: 1px solid var(--color-border); color: var(--color-text); padding: 0.6rem 1.2rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.75rem; }
            .data-btn:hover { border-color: var(--color-primary); color: var(--color-primary); background: rgba(var(--rgb-primary), 0.1); }
            .data-btn.danger { border-color: rgba(var(--rgb-danger), 0.5); color: var(--color-danger); }
            .data-btn.danger:hover { background: rgba(var(--rgb-danger), 0.1); color: var(--color-danger); }
            .course-visibility-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; }
            .course-visibility-btn { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 0.8rem; border: 1px solid; border-radius: var(--radius-md); text-align: right; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
            .course-visibility-btn .color-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; transition: all 0.2s; }
            .course-visibility-btn.visible { border-color: var(--item-color); background-color: rgba(var(--item-color-rgb), 0.1); color: var(--color-text-dark); }
            .course-visibility-btn.visible .color-dot { background-color: var(--item-color); box-shadow: 0 0 8px var(--item-color); }
            .course-visibility-btn.visible:hover { background-color: rgba(var(--item-color-rgb), 0.15); }
            .course-visibility-btn.hidden { border-color: var(--color-border); color: var(--color-text-muted); opacity: 0.6; }
            .course-visibility-btn.hidden .color-dot { background-color: var(--color-text-muted); opacity: 0.5; }
            .course-visibility-btn.hidden:hover { background-color: rgba(255, 255, 255, 0.05); opacity: 1; }
            .action-picker-wrapper { position: relative; }
            .action-picker-display { width: 100%; padding: .5rem 1rem; font-family: var(--font-body); font-size: 0.9rem; color: var(--color-text); background: rgba(0,0,0,0.3); border: 1px solid var(--color-border); border-radius: 8px; cursor: pointer; transition: all var(--transition); text-align: center; }
            .action-picker-display:hover { border-color: var(--color-primary); }
            .light .action-picker-display { background: rgba(0,0,0,0.04); }
            .action-picker-panel { position: absolute; bottom: calc(100% + 8px); left: 0; right: 0; z-index: 3500; background-color: rgba(30,30,32,0.9); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: 0.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.3); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); animation: scaleIn 0.2s ease-out; transform-origin: bottom center; max-height: 200px; overflow-y: auto; }
            .light .action-picker-panel { background-color: rgba(250,250,250,0.9); }
            .action-picker-option { width: 100%; padding: 0.7rem 1rem; font-family: var(--font-body); font-size: 0.9rem; color: var(--color-text-muted); background-color: transparent; border-radius: var(--radius-full); border: none; cursor: pointer; transition: all var(--transition); text-align: center; }
            .action-picker-option:hover { background-color: rgba(var(--rgb-primary), 0.1); }
            .action-picker-option.selected { color: var(--color-primary); font-weight: 700; background-color: transparent; }
            
            /* Mobile-specific styles */
            .mobile-wrapper, .mobile-nav { display: none; }
            
            .mobile-section-details-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); backdrop-filter: blur(8px);
                z-index: 2000; opacity: 0; visibility: hidden; transition: all .3s ease;
            }
            .mobile-section-details-overlay.open { opacity: 1; visibility: visible; }
            .details-panel {
                position: absolute; bottom: 0; left: 0; right: 0;
                background-color: var(--color-card); border-top: 1px solid var(--color-border);
                border-top-left-radius: var(--radius); border-top-right-radius: var(--radius);
                padding: 1.5rem 1.5rem calc(1.5rem + env(safe-area-inset-bottom));
                box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
                transform: translateY(100%); transition: transform .3s cubic-bezier(0.2, 0.8, 0.2, 1);
            }
            .mobile-section-details-overlay.open .details-panel { transform: translateY(0); }
            .details-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; gap: 1rem; }
            .details-header .title-group { display: flex; flex-direction: column; flex-grow: 1; }
            .details-header h4 { margin: 0; font-family: var(--font-title); font-size: 1.2rem; display: flex; align-items: center; gap: .75rem; }
            .details-header .section-number-display { font-size: 0.85rem; font-weight: 400; color: var(--color-text-muted); }
            .details-header .color-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
            .details-nav { display: flex; align-items: center; gap: 0.5rem; }
            .details-nav-btn, .details-close-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border: none; border-radius: 50%; font-size: 1.6rem; color: var(--color-text-muted); cursor: pointer; transition: all .2s; }
            .details-nav-btn:hover, .details-close-btn:hover { background: rgba(255,255,255,0.1); color: var(--color-text); }
            .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem 1rem; margin-bottom: 1.5rem; }
            .detail-item { display: flex; flex-direction: column; gap: 0.25rem; }
            .detail-item span { color: var(--color-text-muted); font-size: 0.8rem; }
            .detail-item strong { color: var(--color-text-dark); font-weight: 600; font-size: 1rem; }
            .detail-item[data-full-width="true"] { grid-column: 1 / -1; }
            .details-action-btn { width: 100%; padding: 0.9rem 1.5rem; border: none; border-radius: var(--radius-md); font-family: var(--font-body); font-size: 1rem; font-weight: 700; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: .5rem; transition: .2s; }
            .details-action-btn.add { background-color: var(--color-primary); }
            .details-action-btn.add:hover { background-color: var(--color-primary-dark); }
            .details-action-btn.remove { background-color: var(--color-danger); }

            @media (max-width: 1023px) {
                body { overflow: auto; --radius: 16px; --radius-md: 12px; }
                .page-wrapper { display: none; }
                .mobile-wrapper { display: block; position: relative; width: 100vw; overflow: hidden; padding-bottom: 75px; }
                .mobile-header { display: flex; justify-content: space-between; align-items: center; padding: 0 1.25rem; height: 65px; background-color: var(--color-card); border-bottom: 1px solid var(--color-border); position: fixed; top: 0; left: 0; right: 0; z-index: 100; backdrop-filter: blur(16px); box-shadow: 0 5px 20px -5px rgba(0,0,0,0.2); }
                .mobile-header h1 { margin: 0; font-size: 1.25rem; font-family: var(--font-title); color: var(--color-text-dark); font-weight: 700; }
                .mobile-header #mobile-settings-btn { background: none; border: none; color: var(--color-primary); font-size: 1.6rem; padding: 0.5rem; }
                .mobile-view-content { display: none; height: calc(100vh - 65px - 75px); margin-top: 65px; overflow-y: auto; }
                .mobile-view-content.active { display: flex; flex-direction: column; }
                .light .mobile-header, .light .mobile-nav { box-shadow: 0 5px 20px -5px rgba(0,0,0,0.05); }
                #mobile-calendar-view { padding: 1rem; gap: 1rem; }
                #mobile-calendar-view .schedule-tabs-container { flex-shrink: 0; }
                #mobile-calendar-view .card { padding: 0; overflow: hidden; flex-grow: 1; height: auto; }
                .mobile-calendar-scroll-wrapper { overflow-x: auto; height: 100%; -webkit-overflow-scrolling: touch; direction: ltr; }
                .mobile-calendar-scroll-wrapper::-webkit-scrollbar { height: 4px; }
                .mobile-calendar-scroll-wrapper::-webkit-scrollbar-track { background: transparent; }
                .mobile-calendar-scroll-wrapper::-webkit-scrollbar-thumb { background: rgba(var(--rgb-primary), 0.5); border-radius: 4px; }
                #mobile-calendar { min-width: 850px; direction: rtl; }
                #mobile-courses-view { padding: 0; }
                #mobile-courses-view .sidebar { height: 100%; border-left: none; }
                #mobile-courses-view .sidebar-header, #mobile-courses-view .sidebar-tabs { display: none; }
                #mobile-courses-view .tab-content { padding: 1rem; }
                #mobile-my-schedule-view { padding: 0; }
                #mobile-my-schedule-view .card { margin: 0; border-radius: 0; box-shadow: none; border-left: none; border-right: none; }
                #mobile-my-schedule-container { width: 100%; }
                #mobile-my-schedule-container .my-schedule-section { padding: 1.25rem; }
                #mobile-my-schedule-container .my-schedule-section h3 { display: none; }
                .mobile-nav { display: flex; position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background-color: var(--color-card); border-top: 1px solid var(--color-border); backdrop-filter: blur(16px); z-index: 100; box-shadow: 0 -5px 20px -5px rgba(0,0,0,0.2); padding-bottom: env(safe-area-inset-bottom); }
                .mobile-nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; background: none; border: none; color: var(--color-text-muted); font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: color 0.2s ease; }
                .mobile-nav-btn i { font-size: 1.6rem; }
                .mobile-nav-btn.active { color: var(--color-primary); }
                .mobile-nav-btn span { transition: all 0.2s ease; padding: 0.2rem 0.6rem; border-radius: 99px; }
                .mobile-nav-btn.active span { color: white; background-color: var(--color-primary); }
                .sidebar { width: 100%; height: 100%; border-left: none; }
                .main-content { padding: 0; height: 100%; }
                .my-schedule-container { display: flex; }
                .my-schedule-section { padding: 1rem; }
                .fc .fc-toolbar { padding: 0 1rem 1rem; font-size: 0.9em; }
            }
        </style>
    </head>
    <body>
        <div class="cosmic-bg-container"><div class="nebula-glow"></div><canvas id="starfield-canvas"></canvas></div>
        <div id="install-section"></div>
        
        <div class="page-wrapper">
            <main class="main-content custom-scrollbar">
                <header class="main-header"><h1><i class="ri-calendar-event-line"></i> QU Schedule</h1><div class="header-actions"><button id="settings-btn"><i class="ri-settings-3-line"></i> إعدادات</button><button id="clear-calendar-btn"><i class="ri-delete-bin-6-line"></i> مسح الجدول الحالي</button></div></header>
                <div class="schedule-tabs-container" id="schedule-tabs-container"></div>
                <div class="calendar-wrapper card"><div id='calendar'></div></div>
                <div class="my-schedule-container" id="my-schedule-container"></div>
            </main>
            <aside class="sidebar">
                <header class="sidebar-header"><h2><i class="ri-stack-line"></i> المقررات</h2></header>
                <div class="sidebar-content-wrapper"><div class="sidebar-tabs"><button class="tab-btn active" data-tab="courses-tab"><i class="ri-layout-grid-line"></i> المقررات المتاحة</button><button class="tab-btn" data-tab="exams-tab"><i class="ri-file-list-3-line"></i> الاختبارات النهائية</button></div><div id="courses-tab" class="tab-content active custom-scrollbar"><div id="desktop-courses-list"><div class="no-data" id="no-data-message"><i class="ri-time-line"></i><h4>في انتظار البيانات...</h4><p>اسحب الأداة من شريط الإشارات المرجعية وضعها في صفحة المقررات المطروحة لتظهر هنا.</p></div></div></div><div id="exams-tab" class="tab-content custom-scrollbar"><div id="desktop-exams-list"></div></div></div>
                <footer class="sidebar-footer"><a href="https://t.me/mutlaq1" target="_blank" rel="noopener noreferrer" class="designer-credit"><i class="ri-telegram-line"></i> MUTLAQ1</a></footer>
            </aside>
        </div>

        <div class="mobile-wrapper">
            <header class="mobile-header"><h1 id="mobile-header-title"></h1><button id="mobile-settings-btn"><i class="ri-settings-3-line"></i></button></header>
            <div id="mobile-calendar-view" class="mobile-view-content active">
                <main class="main-content">
                    <div class="schedule-tabs-container" id="mobile-schedule-tabs-container"></div>
                    <div class="calendar-wrapper card"><div class="mobile-calendar-scroll-wrapper"><div id='mobile-calendar'></div></div></div>
                </main>
            </div>
            <div id="mobile-courses-view" class="mobile-view-content">
                <aside class="sidebar">
                    <header class="sidebar-header"><h2><i class="ri-stack-line"></i> المقررات</h2></header>
                    <div class="sidebar-content-wrapper"><div class="sidebar-tabs"><button class="tab-btn active" data-tab="mobile-courses-tab"><i class="ri-layout-grid-line"></i> المقررات</button><button class="tab-btn" data-tab="mobile-exams-tab"><i class="ri-file-list-3-line"></i> الاختبارات</button></div><div id="mobile-courses-tab" class="tab-content active custom-scrollbar"><div id="mobile-courses-list"></div></div><div id="mobile-exams-tab" class="tab-content custom-scrollbar"><div id="mobile-exams-list"></div></div></div>
                </aside>
            </div>
            <div id="mobile-my-schedule-view" class="mobile-view-content"><div class="my-schedule-container" id="mobile-my-schedule-container"></div></div>
            <nav class="mobile-nav">
                <button class="mobile-nav-btn active" data-view="mobile-calendar-view"><i class="ri-calendar-line"></i><span>الجدول</span></button>
                <button class="mobile-nav-btn" data-view="mobile-courses-view"><i class="ri-stack-line"></i><span>المقررات</span></button>
                <button class="mobile-nav-btn" data-view="mobile-my-schedule-view"><i class="ri-list-check-2"></i><span>جدولي</span></button>
            </nav>
        </div>

        <div class="modal-overlay" id="modal-overlay"></div>
        <div class="settings-modal" id="settings-modal"></div>
        <div class="mobile-section-details-overlay" id="mobile-section-details-overlay"><div class="details-panel" id="details-panel"></div></div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) && window.innerWidth < 1024;
                if (isMobile) {
                    document.body.classList.add('mobile-view');
                }

                const QU_ScheduleApp = {
                    state: {
                        calendar: null,
                        allCoursesData: [],
                        groupedCourses: {},
                        linkedCourseGroups: {},
                        schedules: [],
                        activeScheduleIndex: 0,
                        hiddenCourseCodes: new Set(),
                        customColors: {},
                        userSettings: { theme: 'dark', accentColor: '#8b5cf6', showWeekends: false, minTime: '08:00:00', maxTime: '22:00:00', hiddenCourseCodes: [], hideClosedCourses: false },
                        currentMobileDetail: { section: null, group: null, allSections: [] }
                    },
                    constants: {
                        PRESET_COLORS: { purple: '#8b5cf6', blue: '#3b82f6', pink: '#ec4899', green: '#22c55e', orange: '#f97316' },
                        COLOR_PALETTE: ['#8b5cf6', '#3b82f6', '#ec4899', '#22c55e', '#f97316', '#ef4444', '#06b6d4', '#d946ef'],
                        DAY_MAPPING: { 'الأحد': 0, 'الاثنين': 1, 'الثلاثاء': 2, 'الأربعاء': 3, 'الخميس': 4, 'الجمعة': 5, 'السبت': 6 },
                        STORAGE_KEYS: { SETTINGS: 'quScheduleSettings_v20', COURSES: 'quScheduleCourses_v20', SCHEDULES: 'quScheduleSchedules_v20', COLORS: 'quScheduleColors_v20' },
                        EXTRACTOR_URL: 'https://mutlaq001.github.io/schedule/extractor.js'
                    },
                    dom: {},

                    init() { this._populateDOMElements(); this._setupEventListeners(); this._loadSettings(); this._loadCustomColors(); this._initializeCalendar(); this._loadDataFromStorage(); this._listenForDataFromOpener(); this._updateBookmarkletCode(); },
                };
                
                for (const key of Object.getOwnPropertyNames(Object.getPrototypeOf(QU_ScheduleApp))) { if (key !== 'constructor' && typeof QU_ScheduleApp[key] === 'function') { QU_ScheduleApp[key] = QU_ScheduleApp[key].bind(QU_ScheduleApp); } }

                Object.assign(QU_ScheduleApp, {
                    _loadDataFromStorage() { const d = localStorage.getItem(this.constants.STORAGE_KEYS.COURSES); if (d) { try { this._processAndDisplayData(JSON.parse(d)); this._loadSchedules(); this.updateFullUI(); } catch (e) { console.error("Error loading courses:", e); localStorage.removeItem(this.constants.STORAGE_KEYS.COURSES); this.dom.installSection.style.display = 'block'; } } else { this.dom.installSection.style.display = 'block'; } },
                    _listenForDataFromOpener() { window.addEventListener('message', e => { if (e.data && e.data.type === 'universityCoursesData') { localStorage.setItem(this.constants.STORAGE_KEYS.COURSES, JSON.stringify(e.data.data)); this.state.schedules = []; this._addSchedule("جدول 1", true); this.state.activeScheduleIndex = 0; this._saveSchedules(); this._processAndDisplayData(e.data.data); this.updateFullUI(); } }, false); if (window.opener) window.opener.postMessage('request_schedule_data', '*'); },
                    _processAndDisplayData(courses) { this.dom.installSection.style.display = 'none'; this.state.allCoursesData = courses.map((s, i) => ({ ...s, uniqueId: `${s.code}-${s.section}-${i}`, timeSlots: this._parseTimeEntries(s.time) })); const byName = {}; this.state.groupedCourses = this.state.allCoursesData.reduce((acc, c) => { if (!acc[c.code]) { acc[c.code] = { name: c.name, code: c.code, sections: [] }; if (!byName[c.name]) byName[c.name] = []; byName[c.name].push(c.code); } acc[c.code].sections.push(c); return acc; }, {}); this.state.linkedCourseGroups = {}; for (const name in byName) { if (byName[name].length > 1) this.state.linkedCourseGroups[name] = [...new Set(byName[name])]; } let i=0; Object.values(this.state.groupedCourses).forEach(g => { g.color = this.state.customColors[g.code] || this.constants.COLOR_PALETTE[i++ % this.constants.COLOR_PALETTE.length]; }); document.getElementById('no-data-message').style.display='none'; this._renderCoursesList(); this._buildSettingsModal(); },
                    _loadSchedules() { const d = localStorage.getItem(this.constants.STORAGE_KEYS.SCHEDULES); if (d) { try { const p = JSON.parse(d); if (p && Array.isArray(p.schedules)) { this.state.schedules = p.schedules.map(s => ({ name: s.name, sections: new Set(s.sections), linkedSections: new Map((s.linkedSections || []).map(([k,v]) => [k, new Set(v)])) })); this.state.activeScheduleIndex = p.activeScheduleIndex < p.schedules.length ? p.activeScheduleIndex : 0; } } catch(e) { console.error("Error loading schedules:", e); localStorage.removeItem(this.constants.STORAGE_KEYS.SCHEDULES); } } if (this.state.schedules.length === 0) this._addSchedule("جدول 1", true); },
                    _saveSchedules() { const s = { activeScheduleIndex: this.state.activeScheduleIndex, schedules: this.state.schedules.map(s => ({ name: s.name, sections: Array.from(s.sections), linkedSections: Array.from(s.linkedSections.entries()).map(([k,v]) => [k, Array.from(v)]) })) }; localStorage.setItem(this.constants.STORAGE_KEYS.SCHEDULES, JSON.stringify(s)); },
                    _loadCustomColors() { const d = localStorage.getItem(this.constants.STORAGE_KEYS.COLORS); if (d) { try { this.state.customColors = JSON.parse(d); } catch(e) { localStorage.removeItem(this.constants.STORAGE_KEYS.COLORS); } } },
                    _saveCustomColors() { localStorage.setItem(this.constants.STORAGE_KEYS.COLORS, JSON.stringify(this.state.customColors)); },
                    updateFullUI() { this._renderScheduleTabs(); this.updateCalendarAndConflicts(); if (isMobile) this._updateMobileHeader(); },
                    updateCalendarAndConflicts() { if (!this.state.calendar) return; const sched = this.state.schedules[this.state.activeScheduleIndex]; const selectedIds = sched ? sched.sections : new Set(); this.state.calendar.removeAllEvents(); document.querySelectorAll('.section-btn').forEach(b => b.classList.toggle('selected', selectedIds.has(b.dataset.uniqueId))); const selectedDetails = Array.from(selectedIds).map(id => this.state.allCoursesData.find(c => c.uniqueId === id)).filter(Boolean); const conflictMap = this._calculateConflicts(selectedDetails); selectedDetails.forEach(s => { const g = this.state.groupedCourses[s.code]; if (g && !this.state.hiddenCourseCodes.has(s.code)) this.state.calendar.addEventSource(this._createLectureEventsForSection(s, false, g.color)); }); this._renderFinalExams(selectedDetails); this._renderMyScheduleSummary(selectedDetails, conflictMap); this._updateAvailableSectionsUI(selectedDetails); this._saveSchedules(); },
                    _renderScheduleTabs() { [this.dom.scheduleTabsContainer, this.dom.mobileScheduleTabsContainer].filter(Boolean).forEach(c => { c.innerHTML = ''; const frag = document.createDocumentFragment(); if (this.state.schedules.length === 0 && this.state.allCoursesData.length > 0) { const el = document.createElement('div'); el.className = 'no-data'; el.style.cssText = 'padding:0.5rem 1rem;height:auto;'; el.innerHTML = '<p>لا توجد جداول. اضغط + لإنشاء جدول جديد.</p>'; frag.appendChild(el); } this.state.schedules.forEach((s, i) => { const t = document.createElement('button'); t.className = `schedule-tab ${i === this.state.activeScheduleIndex ? 'active' : ''}`; t.dataset.index = i; t.innerHTML = `<span class="schedule-tab-name" contenteditable="false">${s.name}</span><i class="ri-close-line delete-schedule-btn"></i>`; t.addEventListener('click', () => this._switchSchedule(i)); const n = t.querySelector('.schedule-tab-name'); t.addEventListener('dblclick', () => { n.contentEditable = true; n.focus(); }); n.addEventListener('blur', () => { n.contentEditable = false; this._renameSchedule(i, n.textContent); }); n.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); n.blur(); } }); t.querySelector('.delete-schedule-btn').addEventListener('click', e => { e.stopPropagation(); this._deleteSchedule(i); }); frag.appendChild(t); }); const addBtn = document.createElement('button'); addBtn.id = 'add-schedule-btn'; addBtn.innerHTML = '<i class="ri-add-line"></i>'; addBtn.title = 'إضافة جدول جديد'; addBtn.onclick = () => this._addSchedule(); frag.appendChild(addBtn); c.appendChild(frag); }); },
                    _createCoursesListHTML() { const selected = this.state.schedules[this.state.activeScheduleIndex]?.sections || new Set(); const visible = Object.values(this.state.groupedCourses).filter(g => !this.state.hiddenCourseCodes.has(g.code)); if (Object.keys(this.state.groupedCourses).length > 0 && visible.length === 0) return `<div class="no-data"><i class="ri-eye-off-line"></i><h4>لا توجد مقررات ظاهرة</h4><p>يمكنك إظهار المقررات من الإعدادات.</p></div>`; return visible.sort((a,b)=>a.code.localeCompare(b.code)).map((g, i) => { const sections = this.state.userSettings.hideClosedCourses ? g.sections.filter(s => !s.status.includes('مغلقة')) : g.sections; if (sections.length === 0) return ''; const html = sections.map(s => `<div class="section-btn ${selected.has(s.uniqueId)?'selected':''} ${s.time==='غير محدد'?'no-time':''}" data-unique-id="${s.uniqueId}" style="${s.time==='غير محدد'?'--item-color:'+g.color:''}"><div class="section-btn-number">${s.section}</div><div class="section-type">${s.type||''}</div></div>`).join(''); return `<div class="course-item" style="animation-delay:${i*50}ms"><div class="course-item-header"><span class="color-dot" style="background-color:${g.color};"></span><div class="course-info"><h3>${g.name} (${g.code})</h3><p>${sections.length} شعب متاحة</p></div><i class="ri-arrow-down-s-line toggle-icon"></i></div><div class="sections-wrapper"><div class="sections-grid">${html}</div></div></div>`; }).join(''); },
                    _renderCoursesList() { const h = this._createCoursesListHTML(); if(this.dom.desktopCoursesList)this.dom.desktopCoursesList.innerHTML=h; if(this.dom.mobileCoursesList)this.dom.mobileCoursesList.innerHTML=h; },
                    _createMyScheduleHTML(courses, conflictMap) { const banner = conflictMap.size > 0 ? `<div class="conflict-summary-banner" style="display:flex;"><i class="ri-alert-fill"></i><span>يوجد تعارض في جدولك! المواد المتعارضة مظللة.</span></div>` : ''; let credits = 0; const codes = new Set(); const rows = courses.sort((a,b)=>a.code.localeCompare(b.code)).map(c => { if (!codes.has(c.code)) { credits += parseInt(c.hours, 10) || 0; codes.add(c.code); } const msgs = conflictMap.get(c.uniqueId); const isConflict = !!msgs; const icon = isConflict ? `<i class="ri-alert-fill conflict-icon" title="${msgs.join('\n')}"></i>` : ''; return `<tr class="${isConflict?'has-conflict':''}">
                        <td class="course-cell"><div class="course-code">${icon} ${c.code}</div><div class="course-name">${c.name}</div></td>
                        <td class="section-cell"><div class="section-number">${c.section}</div><div class="section-type">${c.type}</div></td>
                        <td>${c.instructor}</td><td>${c.time.replace(/<br>/g, ' ')}</td>
                        <td><span class="status-badge status-${c.status.includes('مفتوحة')?'open':'closed'}">${c.status}</span></td>
                        <td>${c.examPeriodId||"لا يوجد"}</td><td>${c.location}</td><td><div class="hours-value">${c.hours}</div></td>
                    </tr>`; }).join(''); return `<div class="card">${banner}<div class="my-schedule-section"><h3><i class="ri-calendar-check-line"></i> جدولـي</h3><div class="my-schedule-table-wrapper"><table class="my-schedule-table"><thead><tr><th>المقرر</th><th>الشعبة</th><th>المحاضر</th><th>المواعيد</th><th>الحالة</th><th>الاختبار</th><th>المكان</th><th>الساعات</th></tr></thead><tbody>${rows}</tbody></table></div><div class="my-schedule-footer"><div class="total-credits-summary">إجمالي الساعات: <span>${credits}</span></div></div></div></div>`; },
                    _renderMyScheduleSummary(c, cm) { [this.dom.myScheduleContainer, this.dom.mobileMyScheduleContainer].filter(Boolean).forEach(cont => { cont.style.display='flex'; if(c.length === 0) { cont.innerHTML = `<div class="no-data"><i class="ri-calendar-check-line"></i><h4>جدولك فارغ</h4><p>اختر بعض المقررات لإنشاء جدولك.</p></div>`; } else { cont.innerHTML = this._createMyScheduleHTML(c, cm); } }); },
                    _createFinalExamsHTML(courses) { const exams = [...new Map(courses.map(e => e.examPeriodId ? [e.examPeriodId, e] : [e.uniqueId, e])).values()].filter(e => e.examPeriodId); if (exams.length === 0) return `<div class="no-data"><i class="ri-file-text-line"></i><h4>لا توجد اختبارات</h4><p>لم يتم تحديد اختبارات للمقررات المختارة.</p></div>`; return exams.sort((a,b)=>parseInt(a.examPeriodId,10)-parseInt(b.examPeriodId,10)).map(e => `<div class="course-item"><div class="course-item-header" style="cursor:default;"><div class="course-info"><h3>${e.name} (${e.code})</h3><p><strong>فترة الاختبار: ${e.examPeriodId}</strong></p></div></div></div>`).join(''); },
                    _renderFinalExams(c) { const h = this._createFinalExamsHTML(c); if(this.dom.desktopExamsList)this.dom.desktopExamsList.innerHTML=h; if(this.dom.mobileExamsList)this.dom.mobileExamsList.innerHTML=h; },
                    _updateAvailableSectionsUI(c) { const active = this.state.schedules[this.state.activeScheduleIndex]?.sections || new Set(); this.state.allCoursesData.forEach(s => { document.querySelectorAll(`.section-btn[data-unique-id='${s.uniqueId}']`).forEach(b => { if(b){ b.classList.remove('conflicted'); if(!active.has(s.uniqueId)) b.classList.toggle('conflicted', this._isSectionConflicted(s, c)); } }); }); },
                    _populateDOMElements() { ['my-schedule-container','calendar','clear-calendar-btn','settings-btn','settings-modal','modal-overlay','install-section','no-data-message','schedule-tabs-container','desktop-courses-list','desktop-exams-list','mobile-schedule-tabs-container','mobile-my-schedule-container','mobile-header-title','mobile-settings-btn','mobile-courses-list','mobile-exams-list','mobile-calendar','mobile-section-details-overlay','details-panel'].forEach(id=>this.dom[id.replace(/-(\w)/g,(_,c)=>c.toUpperCase())]=document.getElementById(id)); if(isMobile){ this.dom.tabButtons=document.querySelectorAll('#mobile-courses-view .tab-btn'); this.dom.tabContents=document.querySelectorAll('#mobile-courses-view .tab-content'); this.dom.mobileNavButtons=document.querySelectorAll('.mobile-nav-btn'); this.dom.mobileViewContents=document.querySelectorAll('.mobile-view-content'); }else{ this.dom.tabButtons=document.querySelectorAll('.page-wrapper .sidebar .tab-btn'); this.dom.tabContents=document.querySelectorAll('.page-wrapper .sidebar .tab-content'); } },
                    _calculateConflicts(courses) { const map=new Map(); for(let i=0;i<courses.length;i++){for(let j=i+1;j<courses.length;j++){const cA=courses[i],cB=courses[j];if(cA.code===cB.code)continue;const msgA=map.get(cA.uniqueId)||[],msgB=map.get(cB.uniqueId)||[];if(cA.timeSlots.some(sA=>cB.timeSlots.some(sB=>sA.day===sB.day&&sA.start<sB.end&&sA.end>sB.start))){msgA.push(`تعارض وقت محاضرة مع ${cB.name} (${cB.code})`);msgB.push(`تعارض وقت محاضرة مع ${cA.name} (${cA.code})`);}if(cA.examPeriodId&&cB.examPeriodId&&cA.examPeriodId===cB.examPeriodId){msgA.push(`تعارض اختبار نهائي مع ${cB.name} (${cB.code})`);msgB.push(`تعارض اختبار نهائي مع ${cA.name} (${cA.code})`);}if(msgA.length>0)map.set(cA.uniqueId,msgA);if(msgB.length>0)map.set(cB.uniqueId,msgB);}}return map;},
                    _isSectionConflicted(s,c){return c.some(sel=>{if(s.code===sel.code)return false;const l=s.timeSlots.some(sA=>sel.timeSlots.some(sB=>sA.day===sB.day&&sA.start<sB.end&&sA.end>sB.start));const e=s.examPeriodId&&sel.examPeriodId&&s.examPeriodId===sel.examPeriodId;return l||e;});},
                    _createLectureEventsForSection(s,isPreview,color){const id=isPreview?'preview-source':undefined;return{id,events:s.timeSlots.map(slot=>({title:s.name,daysOfWeek:[slot.day],startTime:slot.start,endTime:slot.end,backgroundColor:isPreview?'transparent':color,borderColor:isPreview?color:this._adjustColorBrightness(color,-20),classNames:isPreview?['preview-event']:[],extendedProps:{...s},display:'block'}))};},
                    _parseTimeEntries(t) { if(!t||typeof t!=='string'||t==='غير محدد')return[]; return t.split('<br>').map(e=>{const p=e.match(/([\u0621-\u064A\s]+):\s*(\d{1,2}:\d{2})\s*(ص|م)\s*-\s*(\d{1,2}:\d{2})\s*(ص|م)/); if(!p)return null; const d=p[1].trim().split(/\s+/); const s=this._convertTo24Hour(p[2],p[3]); const ed=this._convertTo24Hour(p[4],p[5]); return d.map(day=>this.constants.DAY_MAPPING[day]!==undefined?{day:this.constants.DAY_MAPPING[day],start:s,end:ed}:null);}).flat().filter(Boolean);},
                    _convertTo24Hour(t, p){let[h,m]=t.split(':');h=parseInt(h,10);if(p.includes('م')&&h!==12)h+=12;if(p.includes('ص')&&h===12)h=0;return `${String(h).padStart(2,'0')}:${m}:00`;},
                    _setupEventListeners() { this.dom.clearCalendarBtn?.addEventListener('click',()=>this._handleClearCalendar());this.dom.settingsBtn?.addEventListener('click',()=>this._toggleSettingsModal(true));this.dom.mobileSettingsBtn?.addEventListener('click',()=>this._toggleSettingsModal(true));this.dom.modalOverlay.addEventListener('click',()=>this._toggleSettingsModal(false));this.dom.tabButtons.forEach(b=>b.addEventListener('click',()=>this._handleTabClick(b))); [this.dom.desktopCoursesList,this.dom.mobileCoursesList].forEach(l=>{if(l){l.addEventListener('click',e=>this._handleCourseListClick(e));l.addEventListener('mouseover',e=>this._handleSectionHover(e,true));l.addEventListener('mouseout',e=>this._handleSectionHover(e,false));}}); if(isMobile){this.dom.mobileNavButtons.forEach(b=>b.addEventListener('click',()=>this._handleMobileNav(b)));this.dom.mobileSectionDetailsOverlay.addEventListener('click',e=>{if(e.target===this.dom.mobileSectionDetailsOverlay)this._hideMobileSectionDetails();});} },
                    _handleSectionHover(e,isHover){if(isMobile)return;const btn=e.target.closest('.section-btn');if(!btn)return;if(isHover){const s=this.state.allCoursesData.find(c=>c.uniqueId===btn.dataset.uniqueId);if(s)this._showPreviewEvent(s);}else{this._removePreviewEvent();}},
                    _showPreviewEvent(s){this._removePreviewEvent();const g=this.state.groupedCourses[s.code];if(!g)return;this.state.calendar.addEventSource(this._createLectureEventsForSection(s,true,g.color));},
                    _removePreviewEvent(){const s=this.state.calendar.getEventSourceById('preview-source');if(s)s.remove();},
                    _handleCourseListClick(e){const btn=e.target.closest('.section-btn');const hdr=e.target.closest('.course-item-header');if(btn){const id=btn.dataset.uniqueId;if(isMobile){const s=this.state.allCoursesData.find(c=>c.uniqueId===id);const g=this.state.groupedCourses[s.code];const allS=g.sections.filter(sec=>!this.state.userSettings.hideClosedCourses||!sec.status.includes('مغلقة'));this._showMobileSectionDetails(s,g,allS);}else{const sched=this.state.schedules[this.state.activeScheduleIndex];if(!sched)return;if(sched.sections.has(id)){this._removeSectionAndUnlink(id,sched);}else{this._addSectionAndLink(id,sched);}this.updateCalendarAndConflicts();}}else if(hdr){hdr.parentElement.classList.toggle('open');}},
                    _addSectionAndLink(id,sched){const s=this.state.allCoursesData.find(sec=>sec.uniqueId===id);if(!s)return;sched.sections.add(id);const linked=this.state.linkedCourseGroups[s.name];if(!linked)return;const others=linked.filter(code=>code!==s.code);if(others.length===0)return;const linkedIds=new Set();for(const oCode of others){const oSec=this.state.groupedCourses[oCode]?.sections.find(sec=>sec.section===s.section);if(!oSec)continue;if(sched.sections.has(oSec.uniqueId))continue;if(this.state.userSettings.hideClosedCourses&&oSec.status.includes('مغلقة')){this._showToast('info',`الشعبة المرتبطة ${oSec.code}-${oSec.section} مغلقة.`);continue;}const tempSel=Array.from(sched.sections).map(i=>this.state.allCoursesData.find(c=>c.uniqueId===i)).filter(Boolean);if(this._isSectionConflicted(oSec,tempSel)){this._showToast('warning',`الشعبة المرتبطة ${oSec.code}-${oSec.section} متعارضة.`);continue;}sched.sections.add(oSec.uniqueId);linkedIds.add(oSec.uniqueId);this._showToast('success',`تمت إضافة شعبة مرتبطة: ${oSec.code}-${oSec.section}`);}if(linkedIds.size>0)sched.linkedSections.set(id,linkedIds);},
                    _removeSectionAndUnlink(id, sched){sched.sections.delete(id);if(sched.linkedSections.has(id)){const ids=sched.linkedSections.get(id);ids.forEach(i=>sched.sections.delete(i));sched.linkedSections.delete(id);if(ids.size>0)this._showToast('info','تمت إزالة الشعب المرتبطة.');}for(const [tId,lIds]of sched.linkedSections.entries()){if(lIds.has(id)){sched.sections.delete(tId);lIds.forEach(i=>sched.sections.delete(i));sched.linkedSections.delete(tId);if(lIds.size>0)this._showToast('info','تمت إزالة المجموعة المرتبطة.');break;}}},
                    _handleClearCalendar(){const s=this.state.schedules[this.state.activeScheduleIndex];if(!s||s.sections.size===0){this._showToast('info','الجدول فارغ بالفعل');return;}Swal.fire({title:'هل أنت متأكد؟',text:`سيتم مسح المواد من "${s.name}".`,icon:'warning',showCancelButton:true,confirmButtonText:'نعم، امسح!',cancelButtonText:'إلغاء',}).then(r=>{if(r.isConfirmed){s.sections.clear();s.linkedSections.clear();this.updateCalendarAndConflicts();this._showToast('success','تم مسح الجدول');}});},
                    _showToast(icon, title) { Swal.fire({ toast: true, position: 'bottom', icon, title, showConfirmButton: false, timer: 3000, timerProgressBar: true }); },
                    _handleTabClick(b) { const p = b.closest('.sidebar'); p.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); b.classList.add('active'); p.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(b.dataset.tab).classList.add('active'); },
                    _handleMobileNav(b) { const v = b.dataset.view; this.dom.mobileNavButtons.forEach(btn => btn.classList.remove('active')); b.classList.add('active'); this.dom.mobileViewContents.forEach(c => { c.style.display = 'none'; c.classList.remove('active'); }); const t = document.getElementById(v); if(t) { t.style.display = 'flex'; t.classList.add('active'); } this._updateMobileHeader(); if(v === 'mobile-calendar-view') setTimeout(() => this.state.calendar.updateSize(), 50); },
                    _updateBookmarkletCode() { document.getElementById('install-section').innerHTML=`<h3>طريقة التثبيت</h3><p>اسحب هذا الزر إلى شريط الإشارات المرجعية:</p><a class="bookmarklet-button" href="javascript:!function(){var e=document.createElement('script');e.src='${this.constants.EXTRACTOR_URL}?v='+Date.now(),document.head.appendChild(e)}();" onclick="Swal.fire({title:'خطأ!',text:'لا تضغط على الزر، بل قم بسحبه إلى شريط الإشارات المرجعية.',icon:'error'}); return false;">QU Schedule</a>`; },
                    _initializeCalendar() { if (this.state.calendar) this.state.calendar.destroy(); const el = document.getElementById(isMobile ? 'mobile-calendar' : 'calendar'); const opts = { initialView: 'timeGridWeek', locale: 'ar', headerToolbar: false, allDaySlot: false, events: [], dir: 'rtl', dayHeaderFormat: { weekday: isMobile ? 'short' : 'long' }, slotMinTime: this.state.userSettings.minTime, slotMaxTime: this.state.userSettings.maxTime, hiddenDays: this.state.userSettings.showWeekends ? [] : [5, 6], nowIndicator: false, dayCellDidMount: a=>{if(a.isToday)a.el.style.backgroundColor='transparent';}, eventContent: a => { const p=a.event.extendedProps; const w=document.createElement('div'); w.style.cssText='display:flex;flex-direction:column;height:100%;overflow:hidden;font-size:0.8rem;line-height:1.4;'; w.innerHTML=`<b style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:var(--font-title);font-weight:400;">${a.event.title.split('(')[0].trim()}</b><small>${p.section} - ${p.instructor}</small><small style="margin-top:auto;"><i class="ri-map-pin-line"></i> ${p.location}</small>`; return {domNodes:[w]};}, windowResize:()=>this.state.calendar.updateSize()};this.state.calendar=new FullCalendar.Calendar(el,opts);this.state.calendar.render(); },
                    _addSchedule(name, isDefault = false) { const n = name || `جدول ${this.state.schedules.length + 1}`; this.state.schedules.push({ name: n, sections: new Set(), linkedSections: new Map() }); if (!isDefault) { this.state.activeScheduleIndex = this.state.schedules.length - 1; this.updateFullUI(); } },
                    _switchSchedule(i){ if(i!==this.state.activeScheduleIndex){ this.state.activeScheduleIndex = i; this.updateFullUI(); } },
                    _deleteSchedule(i){const n=this.state.schedules[i].name;Swal.fire({title:`حذف "${n}"؟`,text:"لا يمكن التراجع.",icon:'warning',showCancelButton:true,confirmButtonColor:'#d33',confirmButtonText:'نعم، احذف!',cancelButtonText:'إلغاء'}).then(r=>{if(r.isConfirmed){this.state.schedules.splice(i,1);if(this.state.activeScheduleIndex>=i)this.state.activeScheduleIndex=Math.max(0,this.state.activeScheduleIndex-1);if(this.state.schedules.length===0)this._addSchedule("جدول 1",true);this.updateFullUI();this._showToast('success','تم حذف الجدول');}});},
                    _renameSchedule(i, n) { const t=n.trim(); if (t) { this.state.schedules[i].name = t; this._saveSchedules(); if (isMobile) this._updateMobileHeader(); } else { const s = document.querySelector(`.schedule-tab[data-index='${i}'] .schedule-tab-name`); if (s) s.textContent = this.state.schedules[i].name; } },
                    _updateMobileHeader() { const b = document.querySelector('.mobile-nav-btn.active'); if (!b) return; const v = b.dataset.view; if (v === 'mobile-calendar-view' || v === 'mobile-my-schedule-view') { this.dom.mobileHeaderTitle.textContent = this.state.schedules[this.state.activeScheduleIndex]?.name || 'الجدول'; } else if (v === 'mobile-courses-view') { this.dom.mobileHeaderTitle.textContent = 'المقررات'; } },
                    _adjustColorBrightness(h,p){let r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);p/=100;r=Math.round(Math.min(255,Math.max(0,r*(1+p))));g=Math.round(Math.min(255,Math.max(0,g*(1+p))));b=Math.round(Math.min(255,Math.max(0,b*(1+p))));return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;},
                    _hexToRgb(h){const r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return r?`${parseInt(r[1],16)}, ${parseInt(r[2],16)}, ${parseInt(r[3],16)}`:'139,92,246';},
                    _hexToHue(H){if(!H)return 257;let r=0,g=0,b=0;if(H.length==7){r=parseInt("0x"+H.substring(1,3));g=parseInt("0x"+H.substring(3,5));b=parseInt("0x"+H.substring(5,7));}r/=255;g/=255;b/=255;let cmin=Math.min(r,g,b),cmax=Math.max(r,g,b),delta=cmax-cmin,h=0;if(delta==0)h=0;else if(cmax==r)h=((g-b)/delta)%6;else if(cmax==g)h=(b-r)/delta+2;else h=(r-g)/delta+4;h=Math.round(h*60);if(h<0)h+=360;return h;},
                    _showMobileSectionDetails(section, group, allSections) { this.state.currentMobileDetail = { section, group, allSections }; this._renderMobileSectionDetails(); this.dom.mobileSectionDetailsOverlay.classList.add('open'); },
                    _renderMobileSectionDetails() { const { section, group, allSections } = this.state.currentMobileDetail; const panel = this.dom.detailsPanel; const activeSchedule = this.state.schedules[this.state.activeScheduleIndex]; const isSelected = activeSchedule.sections.has(section.uniqueId); const currentIndex = allSections.findIndex(s => s.uniqueId === section.uniqueId); panel.innerHTML = `
                        <div class="details-header">
                            <div class="title-group">
                                <h4><span class="color-dot" style="background-color: ${group.color};"></span>${section.name}</h4>
                                <span class="section-number-display">شعبة ${section.section}</span>
                            </div>
                            <div class="details-nav">
                                <button class="details-nav-btn" id="prev-section-btn"><i class="ri-arrow-right-s-line"></i></button>
                                <button class="details-nav-btn" id="next-section-btn"><i class="ri-arrow-left-s-line"></i></button>
                            </div>
                            <button class="details-close-btn"><i class="ri-close-line"></i></button>
                        </div>
                        <div class="details-grid">
                            <div class="detail-item"><span>المحاضر</span><strong>${section.instructor || 'غير محدد'}</strong></div>
                            <div class="detail-item"><span>الحالة</span><strong><span class="status-badge status-${section.status.includes('مفتوحة') ? 'open' : 'closed'}">${section.status}</span></strong></div>
                            <div class="detail-item" data-full-width="true"><span>المواعيد</span><strong>${section.time.replace(/<br>/g, ' / ') || 'غير محدد'}</strong></div>
                            <div class="detail-item"><span>المكان</span><strong>${section.location || 'غير محدد'}</strong></div>
                            <div class="detail-item"><span>الاختبار</span><strong>${section.examPeriodId || 'لا يوجد'}</strong></div>
                        </div>
                        <button class="details-action-btn ${isSelected?'remove':'add'}" id="details-action-btn"><i class="${isSelected?'ri-delete-bin-line':'ri-add-line'}"></i> ${isSelected?'إزالة':'إضافة للجدول'}</button>
                    `; panel.querySelector('.details-close-btn').onclick=()=>this._hideMobileSectionDetails(); panel.querySelector('#details-action-btn').onclick=()=>{if(isSelected){this._removeSectionAndUnlink(section.uniqueId,activeSchedule);}else{this._addSectionAndLink(section.uniqueId,activeSchedule);}this.updateCalendarAndConflicts();this._hideMobileSectionDetails();}; panel.querySelector('#next-section-btn').onclick = () => { const nextIndex = (currentIndex + 1) % allSections.length; this._showMobileSectionDetails(allSections[nextIndex], group, allSections); }; panel.querySelector('#prev-section-btn').onclick = () => { const prevIndex = (currentIndex - 1 + allSections.length) % allSections.length; this._showMobileSectionDetails(allSections[prevIndex], group, allSections); }; },
                    _hideMobileSectionDetails() { this.dom.mobileSectionDetailsOverlay.classList.remove('open'); },
                    _loadSettings() { const d=localStorage.getItem(this.constants.STORAGE_KEYS.SETTINGS);if(d){try{this.state.userSettings={...this.state.userSettings,...JSON.parse(d)};this.state.hiddenCourseCodes=new Set(this.state.userSettings.hiddenCourseCodes||[]);}catch(e){}}this._applySettings();},
                    _saveSettings() { this.state.userSettings.hiddenCourseCodes = Array.from(this.state.hiddenCourseCodes); localStorage.setItem(this.constants.STORAGE_KEYS.SETTINGS, JSON.stringify(this.state.userSettings)); },
                    _buildSettingsModal() { const modal=this.dom.settingsModal;let cch=Object.values(this.state.groupedCourses).sort((a,b)=>a.code.localeCompare(b.code)).map(g=>`<div class="settings-item"><div class="settings-item-label"><span style="color:${g.color};font-weight:600;">${g.name} (${g.code})</span></div><label class="color-picker-label" style="background-color:${g.color};"><input type="color" class="color-picker-input" data-course-code="${g.code}" value="${g.color}"></label></div>`).join(''); if(!cch)cch='<p style="color:var(--color-text-muted);font-size:0.9rem;">لم يتم تحميل بيانات المقررات بعد.</p>';let cvh=Object.values(this.state.groupedCourses).sort((a,b)=>a.code.localeCompare(b.code)).map(g=>{const i=this.state.hiddenCourseCodes.has(g.code);return`<button class="course-visibility-btn ${i?'hidden':'visible'}" data-course-code="${g.code}" style="--item-color:${g.color};--item-color-rgb:${this._hexToRgb(g.color)};"><span class="color-dot"></span>${g.code}</button>`;}).join('');if(!cvh)cvh='<p style="color:var(--color-text-muted);font-size:0.9rem;">لم يتم تحميل بيانات المقررات بعد.</p>';modal.innerHTML=`<div class="modal-header"><h3><i class="ri-settings-3-line"></i> الإعدادات</h3><i class="ri-close-line modal-close-btn"></i></div><div class="modal-content custom-scrollbar"><div class="settings-group"><h4 class="settings-group-title"><i class="ri-palette-line"></i>المظهر</h4><div class="settings-item"><div class="settings-item-label"><span>الوضع</span></div><div class="mode-toggle"></div></div><div class="settings-item"><div class="settings-item-label"><span>اللون الأساسي</span></div><div class="theme-picker" id="accent-color-picker"></div></div></div><div class="settings-group"><h4 class="settings-group-title"><i class="ri-filter-3-line"></i>ترشيح</h4><div class="settings-item"><div class="settings-item-label"><span>إخفاء الشعب المغلقة</span><small>لإزالة الشعب غير المتاحة</small></div><label class="toggle-switch"><input type="checkbox" id="hide-closed-toggle"><span class="slider"></span></label></div><h4 class="settings-group-title" style="margin-top:2rem;"><i class="ri-eye-off-line"></i>ظهور المقررات</h4><div id="course-visibility-list" class="course-visibility-grid">${cvh}</div></div><div class="settings-group"><h4 class="settings-group-title"><i class="ri-paint-brush-line"></i>ألوان المقررات</h4><div id="course-colors-list">${cch}</div></div><div class="settings-group"><h4 class="settings-group-title"><i class="ri-calendar-2-line"></i>عرض التقويم</h4><div class="settings-item"><div class="settings-item-label"><span>عرض نهاية الأسبوع</span></div><label class="toggle-switch"><input type="checkbox" id="show-weekend-toggle"><span class="slider"></span></label></div><div class="settings-item"><div class="settings-item-label"><span>نطاق الساعات</span></div><div class="time-range-selects"><div id="min-time-select-container"></div><div id="max-time-select-container"></div></div></div></div><div class="settings-group"><h4 class="settings-group-title"><i class="ri-database-2-line"></i>البيانات</h4><div class="data-management-zone"><button class="data-btn" id="export-btn"><i class="ri-download-cloud-2-line"></i>تصدير</button><button class="data-btn" id="import-btn"><i class="ri-upload-cloud-2-line"></i>استيراد</button><input type="file" id="import-file-input" accept=".json" style="display:none;"><button class="data-btn danger" id="reset-app-btn"><i class="ri-restart-line"></i>إعادة تعيين</button></div></div></div>`;this._attachModalEventListeners();this._populateTimeSelects();this._applySettings();},
                    _attachModalEventListeners() { const m=this.dom.settingsModal;m.querySelector('.modal-close-btn').onclick=()=>this._toggleSettingsModal(false);m.querySelector('#course-colors-list').onchange=e=>this._handleCourseColorChange(e);m.querySelector('#course-visibility-list').onclick=e=>this._handleVisibilityToggle(e);m.querySelector('#export-btn').onclick=()=>this._handleExport();m.querySelector('#import-btn').onclick=()=>m.querySelector('#import-file-input').click();m.querySelector('#import-file-input').onchange=e=>this._handleImport(e);m.querySelector('#reset-app-btn').onclick=()=>this._handleReset();},
                    _handleImport(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=evt=>{try{const d=JSON.parse(evt.target.result);if(d&&d.schedule&&Array.isArray(d.schedule)){const t=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});const n=`مستورد ${t}`;this._addSchedule(n,false);const newS=this.state.schedules[this.state.activeScheduleIndex];d.schedule.forEach(id=>{if(this.state.allCoursesData.some(c=>c.uniqueId===id))newS.sections.add(id);});if(d.linked&&Array.isArray(d.linked))newS.linkedSections=new Map(d.linked.map(([k,v])=>[k,new Set(v)]));this.updateFullUI();this._toggleSettingsModal(false);this._showToast('success','تم استيراد الجدول بنجاح!');}else throw new Error();}catch(err){Swal.fire('خطأ!','ملف غير صالح.','error');}};r.readAsText(f);e.target.value='';},
                    _applySettings() { document.body.className = this.state.userSettings.theme === 'light' ? 'light' : ''; if (isMobile) document.body.classList.add('mobile-view'); const pc = this.state.userSettings.accentColor, pcd = this._adjustColorBrightness(pc, -10), pcr = this._hexToRgb(pc), pch = this._hexToHue(pc); document.documentElement.style.setProperty('--color-primary', pc); document.documentElement.style.setProperty('--color-primary-dark', pcd); document.documentElement.style.setProperty('--rgb-primary', pcr); document.documentElement.style.setProperty('--primary-hue', String(pch)); document.documentElement.style.setProperty('--secondary-hue', String((pch + 40) % 360)); const mt=this.dom.settingsModal.querySelector('.mode-toggle');if(mt){mt.innerHTML=`<button class="mode-btn ${this.state.userSettings.theme==='dark'?'active':''}" data-theme="dark">ظلام</button><button class="mode-btn ${this.state.userSettings.theme==='light'?'active':''}" data-theme="light">نهار</button>`;mt.onclick=e=>{if(e.target.matches('.mode-btn')){this.state.userSettings.theme=e.target.dataset.theme;this._saveSettings();this._applySettings();}}; }this._populateAccentColorPicker();const wt=this.dom.settingsModal.querySelector('#show-weekend-toggle');if(wt){wt.checked=this.state.userSettings.showWeekends;wt.onchange=e=>{this.state.userSettings.showWeekends=e.target.checked;this._saveSettings();this._initializeCalendar();this.updateCalendarAndConflicts();};}const ct=this.dom.settingsModal.querySelector('#hide-closed-toggle');if(ct){ct.checked=this.state.userSettings.hideClosedCourses;ct.onchange=e=>{this.state.userSettings.hideClosedCourses=e.target.checked;this._saveSettings();this._renderCoursesList();};}},
                    _populateAccentColorPicker(){const p=this.dom.settingsModal.querySelector('#accent-color-picker');if(!p)return;p.innerHTML='';Object.values(this.constants.PRESET_COLORS).forEach(c=>{const d=document.createElement('div');d.className=`theme-dot ${this.state.userSettings.accentColor===c?'active':''}`;d.style.backgroundColor=c;d.onclick=()=>{this.state.userSettings.accentColor=c;this._saveSettings();this._applySettings();};p.appendChild(d);});const isCustom=!Object.values(this.constants.PRESET_COLORS).includes(this.state.userSettings.accentColor);const cl=document.createElement('label');cl.className=`color-picker-label ${isCustom?'active':''}`;cl.style.backgroundColor=isCustom?this.state.userSettings.accentColor:'transparent';cl.innerHTML=`<input type="color" class="color-picker-input" value="${this.state.userSettings.accentColor}">`;cl.querySelector('input').onchange=e=>{this.state.userSettings.accentColor=e.target.value;this._saveSettings();this._applySettings();};p.appendChild(cl);},
                    _populateTimeSelects() { const minC=this.dom.settingsModal.querySelector('#min-time-select-container'); const maxC=this.dom.settingsModal.querySelector('#max-time-select-container'); if(!minC||!maxC)return; const opts=Array.from({length:24},(_,i)=>({value:`${String(i).padStart(2,'0')}:00:00`,label:`${String(i).padStart(2,'0')}:00`})); this._createActionPicker(minC,opts,this.state.userSettings.minTime,v=>{this.state.userSettings.minTime=v;this._saveSettings();this._initializeCalendar();this.updateCalendarAndConflicts();}); this._createActionPicker(maxC,opts,this.state.userSettings.maxTime,v=>{this.state.userSettings.maxTime=v;this._saveSettings();this._initializeCalendar();this.updateCalendarAndConflicts();}); },
                    _createActionPicker(cont,opts,val,cb){cont.innerHTML='';let open=false;const w=document.createElement('div');w.className='action-picker-wrapper';const s=opts.find(o=>o.value===val)||opts[0];const d=document.createElement('button');d.type='button';d.className='action-picker-display';d.textContent=s.label;const p=document.createElement('div');p.className='action-picker-panel';p.style.display='none';opts.forEach(o=>{const b=document.createElement('button');b.type='button';b.className=`action-picker-option ${val===o.value?'selected':''}`;b.textContent=o.label;b.onclick=()=>{cb(o.value);d.textContent=o.label;p.querySelectorAll('.selected').forEach(el=>el.classList.remove('selected'));b.classList.add('selected');closePanel();};p.appendChild(b);});const openPanel=()=>{open=true;p.style.display='block';};const closePanel=()=>{open=false;p.style.display='none';};d.onclick=()=>open?closePanel():openPanel();w.appendChild(d);w.appendChild(p);cont.appendChild(w);document.addEventListener('click',e=>{if(!w.contains(e.target))closePanel();});}
                });

                QU_ScheduleApp.init();
            });
        </script>
    </body>
</html>
