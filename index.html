<!DOCTYPE html>
<html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>QU Schedule</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;700&family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
        <meta name="theme-color" content="#0a0a0a">
        <style>
            :root {
                --color-primary: #8b5cf6;
                --color-primary-dark: #7c3aed;
                --color-danger: #ff5252;
                --color-warning: #ffc400;
                --color-success: #00c853;
                --color-bg: #0a0a0a;
                --color-card: rgba(20, 20, 22, 0.75);
                --color-border: rgba(255, 255, 255, 0.1);
                --color-text: #e0e0e0;
                --color-text-muted: #9e9e9e;
                --color-text-dark: #ffffff;
                --font-body: "Cairo", sans-serif;
                --font-title: "IBM Plex Sans Arabic", sans-serif;
                --radius: 20px;
                --radius-md: 16px;
                --radius-full: 999px;
                --transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                --transition-smooth: 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
                --rgb-primary: 139, 92, 246;
                --rgb-warning: 255, 196, 0;
                --rgb-danger: 255, 82, 82;
                --rgb-success: 0, 200, 83;
                --primary-hue: 257;
                --secondary-hue: 287;
            }

            .light {
                --color-primary: #7c3aed;
                --color-primary-dark: #6d28d9;
                --color-danger: #ef4444;
                --color-warning: #d97706;
                --color-success: #16a34a;
                --color-bg: #f4f4f5;
                --color-card: rgba(255, 255, 255, 0.75);
                --color-border: rgba(0, 0, 0, 0.09);
                --color-text: #18181b;
                --color-text-muted: #71717a;
                --color-text-dark: #18181b;
            }

            @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px) } to { opacity: 1; transform: translateY(0) } }
            @keyframes scaleIn { from { opacity: 0; transform: scale(.95) } to { opacity: 1; transform: scale(1) } }
            @keyframes gradient-animation { 0% { background-position: 0% 50% } 50% { background-position: 100% 50% } 100% { background-position: 0% 50% } }
            @keyframes swal-scale-in { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
            @keyframes swal-scale-out { from { transform: scale(1); opacity: 1; } to { transform: scale(0.9); opacity: 0; } }

            *, *::before, *::after { box-sizing: border-box; }
            html { scroll-behavior: smooth; }
            body {
                font-family: var(--font-body);
                background-color: var(--color-bg);
                color: var(--color-text);
                margin: 0;
                height: 100vh;
                width: 100vw;
                overflow: hidden;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            .cosmic-bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden }
            #starfield-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100% }
            .nebula-glow {
                position: absolute; top: 50%; left: 50%;
                width: 80vmax; height: 80vmax; margin-top: -40vmax; margin-left: -40vmax;
                background: radial-gradient(circle,hsl(var(--primary-hue),90%,60%,.15) 0%,hsl(var(--secondary-hue),80%,50%,.1) 40%,transparent 70%);
                filter: blur(100px); border-radius: 50%;
            }

            #install-section {
                position: fixed; top: 1.5rem; left: 50%; transform: translateX(-50%); z-index: 1000;
                background-color: var(--color-card); padding: 1.5rem 2rem; border-radius: var(--radius);
                box-shadow: 0 16px 40px -12px rgba(0,0,0,0.4); border: 1px solid var(--color-border);
                width: 90%; max-width: 600px; text-align: center; display: none;
                backdrop-filter: blur(16px); animation: scaleIn .5s var(--transition) both;
            }
            .bookmarklet-button {
                display: inline-block; background: linear-gradient(90deg, var(--color-primary-dark), var(--color-primary));
                color: white; padding: 0.7rem 1.5rem; border-radius: var(--radius-full);
                font-weight: 600; text-decoration: none; cursor: grab;
            }
            
            .custom-scrollbar::-webkit-scrollbar { width: 8px; }
            .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(var(--rgb-primary), 0.3); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(var(--rgb-primary), 0.5); }
            .custom-scrollbar { scrollbar-width: thin; scrollbar-color: rgba(var(--rgb-primary), 0.3) transparent; }

            /* Desktop Styles */
            .page-wrapper { display: flex; height: 100vh; }
            .main-content { flex-grow: 1; height: 100%; display: flex; flex-direction: column; padding: 2rem; gap: 1.5rem; overflow-y: auto; }
            .sidebar { width: 420px; height: 100%; background-color: var(--color-card); border-left: 1px solid var(--color-border); display: flex; flex-direction: column; flex-shrink: 0; backdrop-filter: blur(16px); }
            .main-header { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; animation: fadeInUp .8s var(--transition-smooth) both; }
            .main-header h1 {
                font-family: var(--font-title); font-weight: 700; font-size: 2.5rem;
                background: linear-gradient(90deg,var(--color-primary-dark),var(--color-primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
                background-size: 200% 200%; animation: gradient-animation 5s ease-in-out infinite;
                display: flex; align-items: center; gap: 1rem;
            }
            .header-actions { display: flex; gap: 0.75rem; }
            .header-actions button {
                background: rgba(var(--rgb-primary), 0.1); border: 1px solid var(--color-border); color: var(--color-primary);
                padding: 0.6rem 1.2rem; border-radius: var(--radius-full); font-size: 0.9rem; font-weight: 600; cursor: pointer;
                display: inline-flex; align-items: center; gap: 0.5rem; transition: all var(--transition);
            }
            .header-actions button:hover { background: rgba(var(--rgb-primary), 0.2); border-color: var(--color-primary); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(var(--rgb-primary), 0.2); }
            .card { width: 100%; height: 100%; background-color: var(--color-card); border: 1px solid var(--color-border); border-radius: var(--radius); display: flex; flex-direction: column; backdrop-filter: blur(16px); box-shadow: 0 16px 40px -12px rgba(0,0,0,0.4); overflow: hidden; animation: scaleIn .8s var(--transition-smooth) .2s both; }
            .schedule-tabs-container { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: var(--radius); flex-shrink: 0; animation: fadeInUp .8s var(--transition-smooth) .1s both; overflow-x: auto;}
            .schedule-tab { padding: 0.6rem 1.2rem; border: none; border-radius: var(--radius-md); background: transparent; color: var(--color-text-muted); font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; }
            .schedule-tab.active { background: var(--color-primary); color: white; box-shadow: 0 4px 15px rgba(var(--rgb-primary), 0.2); }
            .schedule-tab-name { outline: none; }
            .schedule-tab .delete-schedule-btn { font-size: 1.1rem; color: rgba(255,255,255,0.6); background: none; border: none; padding: 0; margin-right: -5px; display: none; cursor: pointer; }
            .schedule-tab.active .delete-schedule-btn { display: inline-block; }
            .schedule-tab.active .delete-schedule-btn:hover { color: white; }
            #add-schedule-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(var(--rgb-primary), 0.1); color: var(--color-primary); border: 1px solid var(--color-border); font-size: 1.5rem; cursor: pointer; transition: var(--transition); flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
            #add-schedule-btn:hover { background: var(--color-primary); color: white; transform: rotate(90deg); }
            .calendar-wrapper { flex: 1 1 auto; min-height: 500px; }
            .calendar-wrapper .card { padding: 1.5rem; }
            #calendar { height: 100%; }
            .sidebar-header { padding: 1.5rem 2rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
            .sidebar-header h2 { margin: 0; font-family: var(--font-title); font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; color: var(--color-text-dark); }
            .sidebar-content-wrapper { flex: 1; display: flex; flex-direction: column; min-height: 0; }
            .sidebar-tabs { display: flex; padding: 0.75rem 1rem 0; border-bottom: 1px solid var(--color-border); }
            .tab-btn { flex: 1; text-align: center; padding: 0.75rem 0.5rem; background: none; border: none; color: var(--color-text-muted); font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition); border-bottom: 2px solid transparent; }
            .tab-btn.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
            .tab-content { padding: 1rem; display: none; overflow-y: auto; flex-grow: 1; }
            .tab-content.active { display: block; }
            .sidebar-footer { padding: 1.25rem; border-top: 1px solid var(--color-border); text-align: center; flex-shrink: 0; }
            .course-item { border: 1px solid var(--color-border); border-radius: var(--radius-md); margin-bottom: 0.75rem; background-color: transparent; animation: fadeInUp .5s ease both; overflow: hidden; transition: var(--transition-smooth); box-shadow: inset 0 1px 0 rgba(255,255,255,0.07); }
            .course-item:hover { transform: translateY(-4px); border-color: rgba(var(--rgb-primary), 0.5); box-shadow: inset 0 1px 0 rgba(255,255,255,0.07), 0 8px 25px -10px rgba(0,0,0,0.4); }
            .course-item-header { display: flex; align-items: center; gap: 0.75rem; padding: 1.25rem; cursor: pointer; }
            .course-item .color-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; box-shadow: 0 0 10px 1px; }
            .course-info { flex-grow: 1; }
            .course-info h3 { margin: 0; font-family: var(--font-title); font-size: 1.1rem; font-weight: 400; color: var(--color-text-dark); }
            .course-info p { margin: 4px 0 0; font-size: 0.8rem; color: var(--color-text-muted); }
            .course-item.open .sections-wrapper { max-height: 9999px; }
            .sections-wrapper { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background-color: rgba(0,0,0,0.1); }
            .sections-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.75rem; padding: 1rem 1.25rem 1.25rem; }
            .section-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.25rem; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: var(--radius-full); text-align: center; cursor: pointer; background-color: transparent; transition: all var(--transition); }
            .section-btn:hover { border-color: var(--color-primary); color: var(--color-primary); background: rgba(var(--rgb-primary), 0.1); }
            .section-btn.selected { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
            .section-btn.conflicted { background-color: rgba(var(--rgb-danger), 0.1); border-color: var(--color-danger); color: var(--color-danger); }
            .section-btn .section-type { font-size: 0.7rem; color: var(--color-text-muted); }
            .section-btn.selected .section-type { color: rgba(255,255,255,0.8); }
            .section-btn.no-time { border-bottom: 3px solid var(--item-color); padding-bottom: calc(0.5rem - 3px); }
            .my-schedule-container { flex-shrink: 0; display: none; flex-direction: column; }
            .my-schedule-container .card { animation-delay: 200ms; }
            .conflict-summary-banner { display: none; flex-shrink: 0; padding: .75rem 1.25rem; background-color: rgba(var(--rgb-warning), 0.1); color: var(--color-warning); border-bottom: 1px solid var(--color-border); align-items: center; gap: .75rem; font-weight: 600; border-top-left-radius: var(--radius); border-top-right-radius: var(--radius); }
            .conflict-summary-banner i { font-size: 1.2rem; }
            .my-schedule-section { flex: 1; min-height: 0; display: flex; flex-direction: column; padding: 1.5rem; }
            .my-schedule-section h3 { margin: 0 0 1.5rem; font-size: 1.5rem; display: flex; align-items: center; gap: .75rem; color: var(--color-primary); flex-shrink: 0; font-family: var(--font-title); }
            .my-schedule-table-wrapper { overflow-x: auto; }
            .my-schedule-table { width: 100%; border-collapse: collapse; white-space: nowrap; }
            .my-schedule-table thead th { padding: 1rem; text-align: right; font-family: var(--font-title); color: var(--color-text-muted); border-bottom: 2px solid var(--color-border); font-size: 0.9rem; }
            .my-schedule-table tbody td { padding: 1.25rem 1rem; border-bottom: 1px solid var(--color-border); vertical-align: middle; }
            .my-schedule-table tbody tr:last-child td { border-bottom: none; }
            .my-schedule-table tbody tr.has-conflict { background-color: rgba(var(--rgb-warning), 0.08) !important; }
            .my-schedule-table tbody tr:not(.has-conflict):hover { background-color: rgba(var(--rgb-primary), 0.05); }
            .my-schedule-table .course-cell .course-code { font-family: var(--font-title); font-size: 1.1rem; color: var(--color-text-dark); display: inline-flex; align-items: center; gap: 0.5rem; }
            .my-schedule-table .course-cell .conflict-icon { color: var(--color-warning); font-size: 1.2rem; cursor: help; }
            .my-schedule-table .course-cell .course-name { font-size: 0.8rem; color: var(--color-text-muted); }
            .my-schedule-table .section-cell .section-number { font-size: 1.1rem; font-weight: 600; }
            .my-schedule-table .section-cell .section-type { font-size: 0.8rem; color: var(--color-text-muted); }
            .status-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; border-radius: var(--radius-full); font-size: 0.8rem; font-weight: 600; }
            .status-badge::before { content: ''; display: block; width: 8px; height: 8px; border-radius: 50%; }
            .status-badge.status-open { background-color: rgba(var(--rgb-success), 0.1); color: var(--color-success); }
            .status-badge.status-open::before { background-color: var(--color-success); }
            .status-badge.status-closed { background-color: rgba(var(--rgb-danger), 0.1); color: var(--color-danger); }
            .status-badge.status-closed::before { background-color: var(--color-danger); }
            .hours-value { font-size: 1.3rem; font-weight: 700; color: var(--color-primary); }
            .my-schedule-footer { display: flex; justify-content: flex-end; padding-top: 1.5rem; }
            .total-credits-summary { padding: 0.75rem 1.5rem; font-weight: 600; background: rgba(var(--rgb-primary), 0.1); border: 1px solid rgba(var(--rgb-primary), 0.2); border-radius: var(--radius-md); font-size: 1.1rem; color: var(--color-primary); }
            .fc { --fc-border-color: var(--color-border); --fc-event-text-color: #fff; --fc-page-bg-color: transparent; font-family: var(--font-body); }
            .fc-theme-standard .fc-scrollgrid { border: none; }
            .fc-event { border: none !important; border-radius: 8px !important; font-weight: 600; padding: 4px 8px !important; cursor: pointer; }
            .fc-event.preview-event { border-style: dashed !important; border-width: 2px !important; }
            .no-data { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; padding: 2rem; color: var(--color-text-muted); }
            .no-data i { font-size: 4rem; margin-bottom: 1.5rem; color: var(--color-primary); opacity: 0.5; }
            .swal2-popup { background: var(--color-card)!important; color: var(--color-text)!important; border-radius: var(--radius)!important; border: 1px solid var(--color-border)!important; backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
            .swal2-title { color: var(--color-text-dark)!important; font-family: var(--font-title) !important; }
            .swal2-html-container { color: var(--color-text-muted)!important; margin: 1em 0 !important; font-size: 1em !important; display: block !important; }
            .swal2-confirm { background: var(--color-primary)!important; border-radius: var(--radius-full)!important; padding: .6rem 1.5rem!important; font-family: var(--font-body)!important; }
            .swal2-confirm:focus { box-shadow: 0 0 0 3px rgba(var(--rgb-primary),0.5)!important }
            .swal2-cancel { background: rgba(255,255,255,0.1)!important; color: var(--color-text)!important; border-radius: var(--radius-full)!important; padding: .6rem 1.5rem!important; font-family: var(--font-body)!important; }
            .swal-popup-animation-in { animation: swal-scale-in 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
            .swal-popup-animation-out { animation: swal-scale-out 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
            .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); z-index: 2999; opacity: 0; visibility: hidden; transition: all .3s ease; }
            .modal-overlay.open { opacity: 1; visibility: visible; }
            .settings-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); width: 90%; max-width: 550px; background-color: var(--color-card); border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 3000; opacity: 0; visibility: hidden; transition: all 0.3s; border: 1px solid var(--color-border); }
            .settings-modal.open { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }
            .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
            .modal-header h3 { margin: 0; font-family: var(--font-title); font-size: 1.3rem; color: var(--color-text-dark); }
            .modal-header .modal-close-btn { cursor: pointer; font-size: 1.5rem; color: var(--color-text-muted); transition: all .2s; }
            .modal-header .modal-close-btn:hover { color: var(--color-text-dark); transform: rotate(90deg); }
            .modal-content { padding: 1.5rem; max-height: 70vh; overflow-y: auto; }
            .designer-credit { font-size: 0.9rem; font-weight: 600; color: var(--color-text-muted); text-decoration: none; transition: color 0.2s ease; display: inline-flex; align-items: center; gap: 0.5rem; }
            .designer-credit:hover { color: var(--color-primary); }
            .settings-group { margin-bottom: 2rem; }
            .settings-group-title { font-size: 1.2rem; font-weight: 600; color: var(--color-primary); padding-bottom: 0.75rem; border-bottom: 1px solid var(--color-border); margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.75rem; }
            .settings-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem; }
            .settings-item-label { display: flex; flex-direction: column; gap: 0.25rem; flex-grow: 1; }
            .settings-item-label span { font-size: 1rem; }
            .settings-item-label small { font-size: 0.8rem; color: var(--color-text-muted); }
            .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
            .toggle-switch input { opacity: 0; width: 0; height: 0; }
            .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: .4s; border-radius: 34px; }
            .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
            input:checked + .slider { background-color: var(--color-primary); }
            input:checked + .slider:before { transform: translateX(20px); }
            .mode-toggle { display: flex; background: rgba(0,0,0,0.3); border: 1px solid var(--color-border); border-radius: 999px; padding: 4px; gap: 4px; }
            .light .mode-toggle { background: rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.08); }
            .mode-btn { padding: 0.4rem 1rem; border: none; border-radius: 999px; font-size: 0.9rem; font-weight: 600; cursor: pointer; background: transparent; color: var(--color-text-muted); transition: all 0.2s ease; }
            .mode-btn.active { background: var(--color-primary); color: #fff; box-shadow: 0 2px 5px rgba(var(--rgb-primary), 0.2); }
            .theme-picker { display: flex; gap: .5rem; align-items: center; }
            .theme-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; transition: all .2s ease; border: 2px solid transparent }
            .theme-dot:hover { transform: scale(1.2) }
            .theme-dot.active { border-color: #fff; transform: scale(1.1); }
            .light .theme-dot.active { border-color: var(--color-text-dark); }
            .color-picker-label { position: relative; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid var(--color-border); overflow: hidden; }
            .color-picker-label:hover { transform: scale(1.2); }
            .color-picker-label.active { border-color: #fff; transform: scale(1.1); }
            .light .color-picker-label.active { border-color: var(--color-text-dark); }
            .color-picker-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; border: none; padding: 0; cursor: pointer; }
            .time-range-selects { display: flex; gap: 0.5rem; }
            #course-colors-list .settings-item-label { flex-grow: 1; }
            .data-management-zone { border: 1px solid rgba(var(--rgb-warning), 0.3); border-radius: var(--radius-md); padding: 1.25rem; margin-top: 1rem; background: rgba(var(--rgb-warning), 0.05); }
            .data-btn { width: 100%; background: transparent; border: 1px solid var(--color-border); color: var(--color-text); padding: 0.6rem 1.2rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.75rem; }
            .data-btn:hover { border-color: var(--color-primary); color: var(--color-primary); background: rgba(var(--rgb-primary), 0.1); }
            .data-btn.danger { border-color: rgba(var(--rgb-danger), 0.5); color: var(--color-danger); }
            .data-btn.danger:hover { background: rgba(var(--rgb-danger), 0.1); color: var(--color-danger); }
            .course-visibility-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; }
            .course-visibility-btn { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 0.8rem; border: 1px solid; border-radius: var(--radius-md); text-align: right; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
            .course-visibility-btn .color-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; transition: all 0.2s; }
            .course-visibility-btn.visible { border-color: var(--item-color); background-color: rgba(var(--item-color-rgb), 0.1); color: var(--color-text-dark); }
            .course-visibility-btn.visible .color-dot { background-color: var(--item-color); box-shadow: 0 0 8px var(--item-color); }
            .course-visibility-btn.visible:hover { background-color: rgba(var(--item-color-rgb), 0.15); }
            .course-visibility-btn.hidden { border-color: var(--color-border); color: var(--color-text-muted); opacity: 0.6; }
            .course-visibility-btn.hidden .color-dot { background-color: var(--color-text-muted); opacity: 0.5; }
            .course-visibility-btn.hidden:hover { background-color: rgba(255, 255, 255, 0.05); opacity: 1; }
            .action-picker-wrapper { position: relative; }
            .action-picker-display { width: 100%; padding: .5rem 1rem; font-family: var(--font-body); font-size: 0.9rem; color: var(--color-text); background: rgba(0,0,0,0.3); border: 1px solid var(--color-border); border-radius: 8px; cursor: pointer; transition: all var(--transition); text-align: center; }
            .action-picker-display:hover { border-color: var(--color-primary); }
            .light .action-picker-display { background: rgba(0,0,0,0.04); }
            .action-picker-panel { position: absolute; bottom: calc(100% + 8px); left: 0; right: 0; z-index: 3500; background-color: rgba(30,30,32,0.9); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: 0.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.3); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); animation: scaleIn 0.2s ease-out; transform-origin: bottom center; max-height: 200px; overflow-y: auto; }
            .light .action-picker-panel { background-color: rgba(250,250,250,0.9); }
            .action-picker-option { width: 100%; padding: 0.7rem 1rem; font-family: var(--font-body); font-size: 0.9rem; color: var(--color-text-muted); background-color: transparent; border-radius: var(--radius-full); border: none; cursor: pointer; transition: all var(--transition); text-align: center; }
            .action-picker-option:hover { background-color: rgba(var(--rgb-primary), 0.1); }
            .action-picker-option.selected { color: var(--color-primary); font-weight: 700; background-color: transparent; }
            
            /* Mobile-specific styles */
            .mobile-wrapper, .mobile-nav { display: none; }
            
            @media (max-width: 1023px) {
                body { overflow: auto; --radius: 16px; --radius-md: 12px; }
                .page-wrapper { display: none; }
                .mobile-wrapper { display: block; position: relative; width: 100vw; overflow: hidden; padding-bottom: 75px; /* Space for new nav bar height */ }
                
                /* --- Improved Mobile Header --- */
                .mobile-header {
                    display: flex; justify-content: space-between; align-items: center;
                    padding: 0 1.25rem; height: 65px;
                    background-color: var(--color-card);
                    border-bottom: 1px solid var(--color-border);
                    position: fixed; top: 0; left: 0; right: 0;
                    z-index: 100; backdrop-filter: blur(16px);
                    box-shadow: 0 5px 20px -5px rgba(0,0,0,0.2);
                }
                .mobile-header h1 { margin: 0; font-size: 1.25rem; font-family: var(--font-title); color: var(--color-text-dark); font-weight: 700; }
                .mobile-header #mobile-settings-btn { background: none; border: none; color: var(--color-primary); font-size: 1.6rem; padding: 0.5rem; }

                /* --- Main Content Views --- */
                .mobile-view-content { display: none; height: calc(100vh - 65px - 75px); margin-top: 65px; overflow-y: auto; }
                .mobile-view-content.active { display: flex; flex-direction: column; }
                .light .mobile-header, .light .mobile-nav { box-shadow: 0 5px 20px -5px rgba(0,0,0,0.05); }

                /* --- Calendar View --- */
                #mobile-calendar-view { padding: 1rem; gap: 1rem; }
                #mobile-calendar-view .schedule-tabs-container { flex-shrink: 0; }
                #mobile-calendar-view .card { padding: 0; overflow: hidden; flex-grow: 1; height: auto; }
                
                .mobile-calendar-scroll-wrapper {
                    overflow-x: auto;
                    height: 100%;
                    -webkit-overflow-scrolling: touch;
                    direction: ltr; /* Force LTR on container for predictable scroll */
                }
                .mobile-calendar-scroll-wrapper::-webkit-scrollbar { height: 4px; }
                .mobile-calendar-scroll-wrapper::-webkit-scrollbar-track { background: transparent; }
                .mobile-calendar-scroll-wrapper::-webkit-scrollbar-thumb { background: rgba(var(--rgb-primary), 0.5); border-radius: 4px; }
                
                #mobile-calendar {
                    min-width: 850px;
                    direction: rtl; /* Reset direction for calendar content */
                }
                
                /* --- SIMPLIFIED Courses View --- */
                #mobile-courses-view { padding: 0; }
                #mobile-courses-view .sidebar { height: 100%; border-left: none; }
                #mobile-courses-view .sidebar-header, #mobile-courses-view .sidebar-tabs { display: none; }
                #mobile-courses-view .tab-content { padding: 1rem; }

                /* --- Edge-to-Edge "My Schedule" View --- */
                #mobile-my-schedule-view { padding: 0; }
                #mobile-my-schedule-view .card { margin: 0; border-radius: 0; box-shadow: none; border-left: none; border-right: none; }
                #mobile-my-schedule-container { width: 100%; }
                #mobile-my-schedule-container .my-schedule-section { padding: 1.25rem; }
                #mobile-my-schedule-container .my-schedule-section h3 { display: none; }

                /* --- Polished Mobile Bottom Nav --- */
                .mobile-nav {
                    display: flex; position: fixed; bottom: 0; left: 0; right: 0; height: 75px;
                    background-color: var(--color-card);
                    border-top: 1px solid var(--color-border);
                    backdrop-filter: blur(16px); z-index: 100;
                    box-shadow: 0 -5px 20px -5px rgba(0,0,0,0.2);
                    padding-bottom: env(safe-area-inset-bottom);
                }
                .mobile-nav-btn {
                    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
                    gap: 5px; background: none; border: none;
                    color: var(--color-text-muted); font-size: 0.75rem; font-weight: 700;
                    cursor: pointer; transition: color 0.2s ease;
                }
                .mobile-nav-btn i { font-size: 1.6rem; }
                .mobile-nav-btn.active { color: var(--color-primary); }
                .mobile-nav-btn span { transition: all 0.2s ease; padding: 0.2rem 0.6rem; border-radius: 99px; }
                .mobile-nav-btn.active span { color: white; background-color: var(--color-primary); }
                
                /* --- General Overrides & Inherited Styles --- */
                .sidebar { width: 100%; height: 100%; border-left: none; }
                .main-content { padding: 0; height: 100%; }
                .my-schedule-container { display: flex; }
                .my-schedule-section { padding: 1rem; }
                .fc .fc-toolbar { padding: 0 1rem 1rem; font-size: 0.9em; }
            }
        </style>
    </head>
    <body>
        <div class="cosmic-bg-container"><div class="nebula-glow"></div><canvas id="starfield-canvas"></canvas></div>
        <div id="install-section"></div>
        
        <!-- Desktop View -->
        <div class="page-wrapper">
            <main class="main-content custom-scrollbar">
                <header class="main-header"><h1><i class="ri-calendar-event-line"></i> QU Schedule</h1><div class="header-actions"><button id="settings-btn"><i class="ri-settings-3-line"></i> إعدادات</button><button id="clear-calendar-btn"><i class="ri-delete-bin-6-line"></i> مسح الجدول الحالي</button></div></header>
                <div class="schedule-tabs-container" id="schedule-tabs-container"></div>
                <div class="calendar-wrapper card"><div id='calendar'></div></div>
                <div class="my-schedule-container" id="my-schedule-container"></div>
            </main>
            <aside class="sidebar">
                <header class="sidebar-header"><h2><i class="ri-stack-line"></i> المقررات</h2></header>
                <div class="sidebar-content-wrapper"><div class="sidebar-tabs"><button class="tab-btn active" data-tab="courses-tab"><i class="ri-layout-grid-line"></i> المقررات المتاحة</button><button class="tab-btn" data-tab="exams-tab"><i class="ri-file-list-3-line"></i> الاختبارات النهائية</button></div><div id="courses-tab" class="tab-content active custom-scrollbar"><div id="desktop-courses-list"><div class="no-data" id="no-data-message"><i class="ri-time-line"></i><h4>في انتظار البيانات...</h4><p>اسحب الأداة من شريط الإشارات المرجعية وضعها في صفحة المقررات المطروحة لتظهر هنا.</p></div></div></div><div id="exams-tab" class="tab-content custom-scrollbar"><div id="desktop-exams-list"></div></div></div>
                <footer class="sidebar-footer"><a href="https://t.me/mutlaq1" target="_blank" rel="noopener noreferrer" class="designer-credit"><i class="ri-telegram-line"></i> MUTLAQ1</a></footer>
            </aside>
        </div>

        <!-- Mobile View -->
        <div class="mobile-wrapper">
            <header class="mobile-header">
                <h1 id="mobile-header-title"></h1>
                <button id="mobile-settings-btn"><i class="ri-settings-3-line"></i></button>
            </header>
            
            <div id="mobile-calendar-view" class="mobile-view-content active">
                <main class="main-content">
                    <div class="schedule-tabs-container" id="mobile-schedule-tabs-container"></div>
                    <div class="calendar-wrapper card">
                        <div class="mobile-calendar-scroll-wrapper">
                            <div id='mobile-calendar'></div>
                        </div>
                    </div>
                </main>
            </div>
            <div id="mobile-courses-view" class="mobile-view-content">
                <aside class="sidebar">
                    <header class="sidebar-header"><h2><i class="ri-stack-line"></i> المقررات</h2></header>
                    <div class="sidebar-content-wrapper"><div class="sidebar-tabs"><button class="tab-btn active" data-tab="mobile-courses-tab"><i class="ri-layout-grid-line"></i> المقررات</button><button class="tab-btn" data-tab="mobile-exams-tab"><i class="ri-file-list-3-line"></i> الاختبارات</button></div><div id="mobile-courses-tab" class="tab-content active custom-scrollbar"><div id="mobile-courses-list"></div></div><div id="mobile-exams-tab" class="tab-content custom-scrollbar"><div id="mobile-exams-list"></div></div></div>
                </aside>
            </div>
            <div id="mobile-my-schedule-view" class="mobile-view-content">
                <div class="my-schedule-container" id="mobile-my-schedule-container"></div>
            </div>

            <nav class="mobile-nav">
                <button class="mobile-nav-btn active" data-view="mobile-calendar-view"><i class="ri-calendar-line"></i><span>الجدول</span></button>
                <button class="mobile-nav-btn" data-view="mobile-courses-view"><i class="ri-stack-line"></i><span>المقررات</span></button>
                <button class="mobile-nav-btn" data-view="mobile-my-schedule-view"><i class="ri-list-check-2"></i><span>جدولي</span></button>
            </nav>
        </div>

        <!-- Modals and Overlays (shared) -->
        <div class="modal-overlay" id="modal-overlay"></div>
        <div class="settings-modal" id="settings-modal"></div>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) && window.innerWidth < 1024;
                if (isMobile) {
                    document.body.classList.add('mobile-view');
                }

                const QU_ScheduleApp = {
                    state: {
                        calendar: null,
                        allCoursesData: [],
                        groupedCourses: {},
                        linkedCourseGroups: {},
                        schedules: [],
                        activeScheduleIndex: 0,
                        hiddenCourseCodes: new Set(),
                        customColors: {},
                        userSettings: {
                            theme: 'dark',
                            accentColor: '#8b5cf6',
                            showWeekends: false,
                            minTime: '08:00:00',
                            maxTime: '22:00:00',
                            hiddenCourseCodes: [],
                            hideClosedCourses: false
                        }
                    },
                    constants: {
                        PRESET_COLORS: { purple: '#8b5cf6', blue: '#3b82f6', pink: '#ec4899', green: '#22c55e', orange: '#f97316' },
                        COLOR_PALETTE: ['#8b5cf6', '#3b82f6', '#ec4899', '#22c55e', '#f97316', '#ef4444', '#06b6d4', '#d946ef'],
                        DAY_MAPPING: { 'الأحد': 0, 'الاثنين': 1, 'الثلاثاء': 2, 'الأربعاء': 3, 'الخميس': 4, 'الجمعة': 5, 'السبت': 6 },
                        STORAGE_KEYS: {
                            SETTINGS: 'quScheduleSettings_v20', 
                            COURSES: 'quScheduleCourses_v20',
                            SCHEDULES: 'quScheduleSchedules_v20', 
                            COLORS: 'quScheduleColors_v20'
                        },
                        EXTRACTOR_URL: 'https://mutlaq001.github.io/schedule/extractor.js'
                    },
                    dom: {},

                    init() {
                        this._populateDOMElements();
                        this._setupEventListeners();
                        this._loadSettings();
                        this._loadCustomColors();
                        this._initializeCalendar();
                        this._loadDataFromStorage();
                        this._listenForDataFromOpener();
                        this._updateBookmarkletCode();
                    },

                    // Other methods will be placed here
                };
                
                // Binding 'this' for all functions to ensure context is correct
                for (const key of Object.getOwnPropertyNames(Object.getPrototypeOf(QU_ScheduleApp))) {
                    if (key !== 'constructor' && typeof QU_ScheduleApp[key] === 'function') {
                       QU_ScheduleApp[key] = QU_ScheduleApp[key].bind(QU_ScheduleApp);
                    }
                }

                // Add methods to the prototype
                Object.assign(QU_ScheduleApp, {
                    _loadDataFromStorage() {
                        const storedCourses = localStorage.getItem(this.constants.STORAGE_KEYS.COURSES);
                        if (storedCourses) {
                            try {
                                const courses = JSON.parse(storedCourses);
                                this._processAndDisplayData(courses);
                                this._loadSchedules();
                                this.updateFullUI();
                            } catch (e) {
                                console.error("Error loading courses:", e);
                                localStorage.removeItem(this.constants.STORAGE_KEYS.COURSES);
                                this.dom.installSection.style.display = 'block';
                            }
                        } else {
                            this.dom.installSection.style.display = 'block';
                        }
                    },

                    _listenForDataFromOpener() {
                        window.addEventListener('message', (event) => {
                            if (event.data && event.data.type === 'universityCoursesData') {
                                const courses = event.data.data;
                                localStorage.setItem(this.constants.STORAGE_KEYS.COURSES, JSON.stringify(courses));
                                this.state.schedules = [];
                                this._addSchedule("جدول 1", true);
                                this.state.activeScheduleIndex = 0;
                                this._saveSchedules();
                                this._processAndDisplayData(courses);
                                this.updateFullUI();
                            }
                        }, false);
                        if (window.opener) {
                            window.opener.postMessage('request_schedule_data', '*');
                        }
                    },

                    _processAndDisplayData(courses) {
                        this.dom.installSection.style.display = 'none';
                        this.state.allCoursesData = courses.map((section, index) => ({
                            ...section,
                            uniqueId: `${section.code}-${section.section}-${index}`,
                            timeSlots: this._parseTimeEntries(section.time)
                        }));
                        
                        const coursesByName = {};
                        this.state.groupedCourses = this.state.allCoursesData.reduce((acc, course) => {
                            if (!acc[course.code]) {
                                acc[course.code] = { name: course.name, code: course.code, sections: [] };
                                if(!coursesByName[course.name]) coursesByName[course.name] = [];
                                coursesByName[course.name].push(course.code);
                            }
                            acc[course.code].sections.push(course);
                            return acc;
                        }, {});

                        this.state.linkedCourseGroups = {};
                        for (const name in coursesByName) {
                            if (coursesByName[name].length > 1) {
                                this.state.linkedCourseGroups[name] = [...new Set(coursesByName[name])];
                            }
                        }

                        let colorIndex = 0;
                        Object.values(this.state.groupedCourses).forEach(group => {
                            group.color = this.state.customColors[group.code] || this.constants.COLOR_PALETTE[colorIndex++ % this.constants.COLOR_PALETTE.length];
                        });

                        document.getElementById('no-data-message').style.display = 'none';
                        this._renderCoursesList();
                        this._buildSettingsModal();
                    },
                    
                    _loadSchedules() {
                        const stored = localStorage.getItem(this.constants.STORAGE_KEYS.SCHEDULES);
                        if (stored) {
                            try {
                                const parsed = JSON.parse(stored);
                                if (parsed && Array.isArray(parsed.schedules)) {
                                    this.state.schedules = parsed.schedules.map(s => ({ 
                                        name: s.name, 
                                        sections: new Set(s.sections),
                                        linkedSections: new Map((s.linkedSections || []).map(([key, value]) => [key, new Set(value)]))
                                    }));
                                    this.state.activeScheduleIndex = parsed.activeScheduleIndex < parsed.schedules.length ? parsed.activeScheduleIndex : 0;
                                }
                            } catch (e) {
                                console.error("Error loading schedules:", e);
                                localStorage.removeItem(this.constants.STORAGE_KEYS.SCHEDULES);
                            }
                        }
                        if (this.state.schedules.length === 0) {
                           this._addSchedule("جدول 1", true);
                        }
                    },
                    
                    _saveSchedules() {
                        const serializableSchedules = {
                           activeScheduleIndex: this.state.activeScheduleIndex,
                           schedules: this.state.schedules.map(s => ({ 
                               name: s.name, 
                               sections: Array.from(s.sections),
                               linkedSections: Array.from(s.linkedSections.entries()).map(([key, value]) => [key, Array.from(value)])
                           }))
                        };
                        localStorage.setItem(this.constants.STORAGE_KEYS.SCHEDULES, JSON.stringify(serializableSchedules));
                    },

                    _loadCustomColors() {
                        const stored = localStorage.getItem(this.constants.STORAGE_KEYS.COLORS);
                        if (stored) {
                            try { this.state.customColors = JSON.parse(stored); } catch (e) { localStorage.removeItem(this.constants.STORAGE_KEYS.COLORS); }
                        }
                    },
                    _saveCustomColors() {
                        localStorage.setItem(this.constants.STORAGE_KEYS.COLORS, JSON.stringify(this.state.customColors));
                    },
                    
                    updateFullUI() {
                        this._renderScheduleTabs();
                        this.updateCalendarAndConflicts();
                        if (isMobile) {
                            this._updateMobileHeader();
                        }
                    },

                    updateCalendarAndConflicts() {
                        if (!this.state.calendar) return;

                        const activeSchedule = this.state.schedules[this.state.activeScheduleIndex];
                        const selectedSections = activeSchedule ? activeSchedule.sections : new Set();
                        
                        this.state.calendar.removeAllEvents();
                        
                        document.querySelectorAll('.section-btn').forEach(btn => {
                            btn.classList.toggle('selected', selectedSections.has(btn.dataset.uniqueId));
                        });

                        const selectedCourseDetails = Array.from(selectedSections).map(id => this.state.allCoursesData.find(c => c.uniqueId === id)).filter(Boolean);
                        const conflictMap = this._calculateConflicts(selectedCourseDetails);
                        
                        selectedCourseDetails.forEach(section => {
                            const group = this.state.groupedCourses[section.code];
                            if (group && !this.state.hiddenCourseCodes.has(section.code)) {
                                const lectureEvents = this._createLectureEventsForSection(section, false, group.color);
                                this.state.calendar.addEventSource(lectureEvents);
                            }
                        });
                        
                        this._renderFinalExams(selectedCourseDetails);
                        this._renderMyScheduleSummary(selectedCourseDetails, conflictMap);
                        this._updateAvailableSectionsUI(selectedCourseDetails);
                        this._saveSchedules();
                    },
                    
                    _renderScheduleTabs() {
                        const containers = [this.dom.scheduleTabsContainer];
                        if(isMobile) containers.push(this.dom.mobileScheduleTabsContainer);

                        containers.forEach(container => {
                            if (!container) return;
                            container.innerHTML = ''; 
                            const fragment = document.createDocumentFragment();

                            if(this.state.schedules.length === 0 && this.state.allCoursesData.length > 0) {
                                const noDataEl = document.createElement('div');
                                noDataEl.className = 'no-data';
                                noDataEl.style.cssText = 'padding: 0.5rem 1rem; height: auto;';
                                noDataEl.innerHTML = '<p>لا توجد جداول. اضغط + لإنشاء جدول جديد.</p>';
                                fragment.appendChild(noDataEl);
                            }
                            
                            this.state.schedules.forEach((schedule, index) => {
                                const tab = document.createElement('button');
                                tab.className = `schedule-tab ${index === this.state.activeScheduleIndex ? 'active' : ''}`;
                                tab.dataset.index = index;
                                tab.innerHTML = `<span class="schedule-tab-name" contenteditable="false">${schedule.name}</span><i class="ri-close-line delete-schedule-btn"></i>`;
                                
                                tab.addEventListener('click', () => this._switchSchedule(index));
                                const nameSpan = tab.querySelector('.schedule-tab-name');
                                tab.addEventListener('dblclick', () => { nameSpan.contentEditable = true; nameSpan.focus(); });
                                nameSpan.addEventListener('blur', () => { nameSpan.contentEditable = false; this._renameSchedule(index, nameSpan.textContent); });
                                nameSpan.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); nameSpan.blur(); } });
                                tab.querySelector('.delete-schedule-btn').addEventListener('click', (e) => { e.stopPropagation(); this._deleteSchedule(index); });
                                fragment.appendChild(tab);
                            });

                            const addButton = document.createElement('button');
                            addButton.id = 'add-schedule-btn';
                            addButton.innerHTML = '<i class="ri-add-line"></i>';
                            addButton.title = 'إضافة جدول جديد';
                            addButton.addEventListener('click', () => this._addSchedule());
                            fragment.appendChild(addButton);
                            container.appendChild(fragment);
                        });
                    },
                    
                    _createCoursesListHTML() {
                        const selectedSections = this.state.schedules[this.state.activeScheduleIndex]?.sections || new Set();
                        const visibleCourses = Object.values(this.state.groupedCourses).filter(g => !this.state.hiddenCourseCodes.has(g.code));

                        if (Object.keys(this.state.groupedCourses).length > 0 && visibleCourses.length === 0) {
                            return `<div class="no-data"><i class="ri-eye-off-line"></i><h4>لا توجد مقررات ظاهرة</h4><p>يمكنك إظهار المقررات من الإعدادات.</p></div>`;
                        }

                        return visibleCourses.sort((a, b) => a.code.localeCompare(b.code)).map((group, i) => {
                            const sectionsToDisplay = this.state.userSettings.hideClosedCourses
                                ? group.sections.filter(section => !section.status.includes('مغلقة'))
                                : group.sections;

                            if (sectionsToDisplay.length === 0) return '';

                            const sectionsHTML = sectionsToDisplay.map(section => {
                                const isNoTime = section.time === 'غير محدد';
                                return `<div class="section-btn ${selectedSections.has(section.uniqueId) ? 'selected' : ''} ${isNoTime ? 'no-time' : ''}" data-unique-id="${section.uniqueId}" style="${isNoTime ? '--item-color:' + group.color : ''}"><div class="section-btn-number">${section.section}</div><div class="section-type">${section.type || ''}</div></div>`;
                            }).join('');
                            
                            return `<div class="course-item" style="animation-delay: ${i * 50}ms"><div class="course-item-header"><span class="color-dot" style="background-color: ${group.color};"></span><div class="course-info"><h3>${group.name} (${group.code})</h3><p>${sectionsToDisplay.length} شعب متاحة</p></div><i class="ri-arrow-down-s-line toggle-icon"></i></div><div class="sections-wrapper"><div class="sections-grid">${sectionsHTML}</div></div></div>`;
                        }).join('');
                    },

                    _renderCoursesList() {
                        const html = this._createCoursesListHTML();
                        if (this.dom.desktopCoursesList) this.dom.desktopCoursesList.innerHTML = html;
                        if (this.dom.mobileCoursesList) this.dom.mobileCoursesList.innerHTML = html;
                    },

                    _createMyScheduleHTML(selectedCourses, conflictMap) {
                        const conflictBannerHTML = conflictMap.size > 0 ? `<div class="conflict-summary-banner" style="display:flex;"><i class="ri-alert-fill"></i><span>يوجد تعارض في جدولك! المواد المتعارضة مظللة باللون الأصفر.</span></div>` : '';
                        
                        let totalCredits = 0;
                        const uniqueCourseCodes = new Set();
                        
                        const tableRowsHTML = selectedCourses.sort((a, b) => a.code.localeCompare(b.code)).map(course => {
                            if (!uniqueCourseCodes.has(course.code)) {
                                totalCredits += parseInt(course.hours, 10) || 0;
                                uniqueCourseCodes.add(course.code);
                            }
                            const examText = course.examPeriodId || "لا يوجد";
                            const statusClass = course.status.includes('مفتوحة') ? 'open' : 'closed';
                            const conflictMessages = conflictMap.get(course.uniqueId);
                            const isConflicted = !!conflictMessages;
                            const conflictIconHTML = isConflicted ? `<i class="ri-alert-fill conflict-icon" title="${conflictMessages.join('\n')}"></i>` : '';
                            
                            return `<tr class="${isConflicted ? 'has-conflict' : ''}">
                                <td class="course-cell"><div class="course-code">${conflictIconHTML} ${course.code}</div><div class="course-name">${course.name}</div></td>
                                <td class="section-cell"><div class="section-number">${course.section}</div><div class="section-type">${course.type}</div></td>
                                <td>${course.instructor}</td>
                                <td>${course.time.replace(/<br>/g, ' ')}</td>
                                <td><span class="status-badge status-${statusClass}">${course.status}</span></td>
                                <td>${examText}</td>
                                <td>${course.location}</td>
                                <td><div class="hours-value">${course.hours}</div></td>
                            </tr>`;
                        }).join('');

                        return `<div class="card">
                            ${conflictBannerHTML}
                            <div class="my-schedule-section">
                                <h3><i class="ri-calendar-check-line"></i> جدولـي</h3>
                                <div class="my-schedule-table-wrapper">
                                    <table class="my-schedule-table">
                                        <thead><tr><th>المقرر</th><th>الشعبة</th><th>المحاضر</th><th>المواعيد</th><th>الحالة</th><th>فترة الاختبار</th><th>المكان</th><th>الساعات</th></tr></thead>
                                        <tbody>${tableRowsHTML}</tbody>
                                    </table>
                                </div>
                                <div class="my-schedule-footer">
                                    <div class="total-credits-summary">إجمالي الساعات: <span>${totalCredits}</span></div>
                                </div>
                            </div>
                        </div>`;
                    },

                    _renderMyScheduleSummary(selectedCourses, conflictMap) {
                        const containers = [this.dom.myScheduleContainer];
                        if (isMobile) containers.push(this.dom.mobileMyScheduleContainer);

                        containers.forEach(container => {
                            if (!container) return;
                            container.style.display = 'flex';
                            if (selectedCourses.length === 0) {
                                container.innerHTML = `<div class="no-data"><i class="ri-calendar-check-line"></i><h4>جدولك فارغ</h4><p>اختر بعض المقررات لإنشاء جدولك.</p></div>`;
                            } else {
                                container.innerHTML = this._createMyScheduleHTML(selectedCourses, conflictMap);
                            }
                        });
                    },

                    _createFinalExamsHTML(selectedCourses) {
                        const uniqueExams = [...new Map(selectedCourses.map(e => e.examPeriodId ? [e.examPeriodId, e] : [e.uniqueId, e])).values()];
                        const validExams = uniqueExams.filter(e => e.examPeriodId);
                        
                        if (validExams.length === 0) {
                            return `<div class="no-data"><i class="ri-file-text-line"></i><h4>لا توجد اختبارات</h4><p>لم يتم تحديد اختبارات نهائية للمقررات المختارة.</p></div>`;
                        }
                        
                        return validExams.sort((a, b) => parseInt(a.examPeriodId, 10) - parseInt(b.examPeriodId, 10)).map(exam => 
                            `<div class="course-item">
                                <div class="course-item-header" style="cursor:default;">
                                    <div class="course-info">
                                        <h3>${exam.name} (${exam.code})</h3>
                                        <p><strong>فترة الاختبار: ${exam.examPeriodId}</strong></p>
                                    </div>
                                </div>
                            </div>`
                        ).join('');
                    },

                    _renderFinalExams(selectedCourses) {
                        const html = this._createFinalExamsHTML(selectedCourses);
                        if (this.dom.desktopExamsList) this.dom.desktopExamsList.innerHTML = html;
                        if (this.dom.mobileExamsList) this.dom.mobileExamsList.innerHTML = html;
                    },

                    _updateAvailableSectionsUI(selectedCourses) {
                         const activeSections = this.state.schedules[this.state.activeScheduleIndex]?.sections || new Set();
                        this.state.allCoursesData.forEach(section => {
                            const btns = document.querySelectorAll(`.section-btn[data-unique-id='${section.uniqueId}']`);
                            btns.forEach(btn => {
                                if (btn) {
                                    btn.classList.remove('conflicted');
                                    if (!activeSections.has(section.uniqueId)) {
                                        btn.classList.toggle('conflicted', this._isSectionConflicted(section, selectedCourses));
                                    }
                                }
                            });
                        });
                    },
                    _populateDOMElements() {
                        const ids = [
                            'my-schedule-container', 'calendar', 'clear-calendar-btn', 'settings-btn', 
                            'settings-modal', 'modal-overlay', 'install-section', 'no-data-message', 
                            'schedule-tabs-container', 'desktop-courses-list', 'desktop-exams-list',
                            // Mobile specific
                            'mobile-schedule-tabs-container', 'mobile-my-schedule-container', 'mobile-header-title', 
                            'mobile-settings-btn', 'mobile-courses-list', 'mobile-exams-list', 'mobile-calendar'
                        ];
                        ids.forEach(id => {
                            this.dom[id.replace(/-(\w)/g, (_, c) => c.toUpperCase())] = document.getElementById(id);
                        });
                        
                        if (isMobile) {
                            this.dom.tabButtons = document.querySelectorAll('#mobile-courses-view .tab-btn');
                            this.dom.tabContents = document.querySelectorAll('#mobile-courses-view .tab-content');
                            this.dom.mobileNavButtons = document.querySelectorAll('.mobile-nav-btn');
                            this.dom.mobileViewContents = document.querySelectorAll('.mobile-view-content');
                        } else {
                            this.dom.tabButtons = document.querySelectorAll('.page-wrapper .sidebar .tab-btn');
                            this.dom.tabContents = document.querySelectorAll('.page-wrapper .sidebar .tab-content');
                        }
                    },
                    _calculateConflicts(selectedCourses) {
                        const conflictMap = new Map();
                        for (let i = 0; i < selectedCourses.length; i++) {
                            for (let j = i + 1; j < selectedCourses.length; j++) {
                                const cA = selectedCourses[i], cB = selectedCourses[j];
                                if (cA.code === cB.code) continue;
                                const msgA = conflictMap.get(cA.uniqueId) || [], msgB = conflictMap.get(cB.uniqueId) || [];
                                if (cA.timeSlots.some(sA => cB.timeSlots.some(sB => sA.day === sB.day && sA.start < sB.end && sA.end > sB.start))) {
                                    msgA.push(`تعارض وقت محاضرة مع ${cB.name} (${cB.code})`);
                                    msgB.push(`تعارض وقت محاضرة مع ${cA.name} (${cA.code})`);
                                }
                                if (cA.examPeriodId && cB.examPeriodId && cA.examPeriodId === cB.examPeriodId) {
                                    msgA.push(`تعارض اختبار نهائي مع ${cB.name} (${cB.code})`);
                                    msgB.push(`تعارض اختبار نهائي مع ${cA.name} (${cA.code})`);
                                }
                                if (msgA.length > 0) conflictMap.set(cA.uniqueId, msgA);
                                if (msgB.length > 0) conflictMap.set(cB.uniqueId, msgB);
                            }
                        }
                        return conflictMap;
                    },
                    _isSectionConflicted(section, selectedCourses) {
                        return selectedCourses.some(sel => {
                            if (section.code === sel.code) return false;
                            const lectureConflict = section.timeSlots.some(sA => sel.timeSlots.some(sB => sA.day === sB.day && sA.start < sB.end && sA.end > sB.start));
                            const examConflict = section.examPeriodId && sel.examPeriodId && section.examPeriodId === sel.examPeriodId;
                            return lectureConflict || examConflict;
                        });
                    },
                    _createLectureEventsForSection(section, isPreview, color) {
                        const sourceId = isPreview ? 'preview-source' : undefined;
                        return {
                            id: sourceId,
                            events: section.timeSlots.map(slot => ({
                                title: `${section.name}`,
                                daysOfWeek: [slot.day],
                                startTime: slot.start,
                                endTime: slot.end,
                                backgroundColor: isPreview ? 'transparent' : color,
                                borderColor: isPreview ? color : this._adjustColorBrightness(color, -20),
                                classNames: isPreview ? ['preview-event'] : [],
                                extendedProps: { ...section },
                                display: 'block'
                            }))
                        };
                    },
                    _parseTimeEntries(timeString) {
                        if (!timeString || typeof timeString !== 'string' || timeString === 'غير محدد') return [];
                        return timeString.split('<br>').map(entry => {
                            const parts = entry.match(/([\u0621-\u064A\s]+):\s*(\d{1,2}:\d{2})\s*(ص|م)\s*-\s*(\d{1,2}:\d{2})\s*(ص|م)/);
                            if (!parts) return null;
                            const days = parts[1].trim().split(/\s+/);
                            const start = this._convertTo24Hour(parts[2], parts[3]);
                            const end = this._convertTo24Hour(parts[4], parts[5]);
                            return days.map(day => this.constants.DAY_MAPPING[day] !== undefined ? { day: this.constants.DAY_MAPPING[day], start, end } : null);
                        }).flat().filter(Boolean);
                    },
                    _convertTo24Hour(time, period) {
                        let[h,m] = time.split(':');
                        h = parseInt(h, 10);
                        if (period.includes('م') && h !== 12) h += 12;
                        if (period.includes('ص') && h === 12) h = 0;
                        return `${String(h).padStart(2, '0')}:${m}:00`;
                    },
                    _setupEventListeners() {
                        this.dom.clearCalendarBtn?.addEventListener('click', () => this._handleClearCalendar());
                        this.dom.settingsBtn?.addEventListener('click', () => this._toggleSettingsModal(true));
                        this.dom.mobileSettingsBtn?.addEventListener('click', () => this._toggleSettingsModal(true));
                        this.dom.modalOverlay.addEventListener('click', () => this._toggleSettingsModal(false));
                        
                        this.dom.tabButtons.forEach(button => button.addEventListener('click', () => this._handleTabClick(button)));
                        
                        const courseLists = [this.dom.desktopCoursesList, this.dom.mobileCoursesList];
                        courseLists.forEach(list => {
                            if(list) {
                                list.addEventListener('click', e => this._handleCourseListClick(e));
                                list.addEventListener('mouseover', e => this._handleSectionHover(e, true));
                                list.addEventListener('mouseout', e => this._handleSectionHover(e, false));
                            }
                        });

                        if(isMobile) {
                            this.dom.mobileNavButtons.forEach(btn => btn.addEventListener('click', () => this._handleMobileNav(btn)));
                        }
                    },
                    _handleSectionHover(event, isHovering) {
                        if (isMobile) return; // Disable hover on mobile
                        const sectionBtn = event.target.closest('.section-btn');
                        if (!sectionBtn) return;
                        if (isHovering) {
                            const uniqueId = sectionBtn.dataset.uniqueId;
                            const section = this.state.allCoursesData.find(c => c.uniqueId === uniqueId);
                            if (section) this._showPreviewEvent(section);
                        } else {
                            this._removePreviewEvent();
                        }
                    },
                    _showPreviewEvent(section) {
                        this._removePreviewEvent();
                        const group = this.state.groupedCourses[section.code];
                        if (!group) return;
                        const previewEventSource = this._createLectureEventsForSection(section, true, group.color);
                        this.state.calendar.addEventSource(previewEventSource);
                    },
                    _removePreviewEvent() {
                        const existingSource = this.state.calendar.getEventSourceById('preview-source');
                        if (existingSource) existingSource.remove();
                    },

                    _handleCourseListClick(e) {
                        const sectionBtn = e.target.closest('.section-btn');
                        const header = e.target.closest('.course-item-header');
                        
                        if (sectionBtn) {
                            const uniqueId = sectionBtn.dataset.uniqueId;
                            const activeSchedule = this.state.schedules[this.state.activeScheduleIndex];
                            if (!activeSchedule) return;

                            if (activeSchedule.sections.has(uniqueId)) {
                                this._removeSectionAndUnlink(uniqueId, activeSchedule);
                            } else {
                                this._addSectionAndLink(uniqueId, activeSchedule);
                            }
                            this.updateCalendarAndConflicts();
                        } else if (header) {
                            header.parentElement.classList.toggle('open');
                        }
                    },
                    
                    _addSectionAndLink(sectionId, schedule) {
                        const section = this.state.allCoursesData.find(s => s.uniqueId === sectionId);
                        if (!section) return;
                        
                        schedule.sections.add(sectionId);
                        
                        const linkedGroup = this.state.linkedCourseGroups[section.name];
                        if (!linkedGroup) return;

                        const otherCourseCodes = linkedGroup.filter(code => code !== section.code);
                        if (otherCourseCodes.length === 0) return;

                        const linkedSectionIds = new Set();
                        
                        for (const otherCode of otherCourseCodes) {
                            const correspondingSection = this.state.groupedCourses[otherCode]?.sections.find(s => s.section === section.section);
                            if (!correspondingSection) continue;
                            
                            if (schedule.sections.has(correspondingSection.uniqueId)) continue;

                            if (this.state.userSettings.hideClosedCourses && correspondingSection.status.includes('مغلقة')) {
                                this._showToast('info', `الشعبة المرتبطة ${correspondingSection.code}-${correspondingSection.section} مغلقة.`);
                                continue;
                            }
                            
                            const tempSelectedDetails = Array.from(schedule.sections).map(id => this.state.allCoursesData.find(c => c.uniqueId === id)).filter(Boolean);

                            if (this._isSectionConflicted(correspondingSection, tempSelectedDetails)) {
                                this._showToast('warning', `الشعبة المرتبطة ${correspondingSection.code}-${correspondingSection.section} متعارضة.`);
                                continue;
                            }

                            schedule.sections.add(correspondingSection.uniqueId);
                            linkedSectionIds.add(correspondingSection.uniqueId);
                            this._showToast('success', `تمت إضافة شعبة مرتبطة: ${correspondingSection.code}-${correspondingSection.section}`);
                        }
                        if (linkedSectionIds.size > 0) {
                           schedule.linkedSections.set(sectionId, linkedSectionIds);
                        }
                    },
                    
                    _removeSectionAndUnlink(sectionId, schedule) {
                        schedule.sections.delete(sectionId);

                        if (schedule.linkedSections.has(sectionId)) {
                            const linkedIds = schedule.linkedSections.get(sectionId);
                            linkedIds.forEach(id => schedule.sections.delete(id));
                            schedule.linkedSections.delete(sectionId);
                            if(linkedIds.size > 0) this._showToast('info', 'تمت إزالة الشعب المرتبطة.');
                        }

                        for (const [triggerId, linkedIds] of schedule.linkedSections.entries()) {
                            if (linkedIds.has(sectionId)) {
                                schedule.sections.delete(triggerId);
                                linkedIds.forEach(id => schedule.sections.delete(id));
                                schedule.linkedSections.delete(triggerId);
                                if(linkedIds.size > 0) this._showToast('info', 'تمت إزالة المجموعة المرتبطة.');
                                break;
                            }
                        }
                    },

                    _handleClearCalendar() {
                        const activeSchedule = this.state.schedules[this.state.activeScheduleIndex];
                        if (!activeSchedule || activeSchedule.sections.size === 0) {
                            this._showToast('info', 'الجدول الحالي فارغ بالفعل');
                            return;
                        }

                        Swal.fire({
                            title: 'هل أنت متأكد؟', text: `سيتم مسح جميع المواد المختارة من "${activeSchedule.name}".`, icon: 'warning',
                            showCancelButton: true, confirmButtonText: 'نعم، امسح الجدول!', cancelButtonText: 'إلغاء',
                        }).then((result) => {
                            if (result.isConfirmed) {
                                activeSchedule.sections.clear();
                                activeSchedule.linkedSections.clear();
                                this.updateCalendarAndConflicts();
                                this._showToast('success', 'تم مسح الجدول بنجاح');
                            }
                        });
                    },

                    _showToast(icon, title) {
                         Swal.fire({ toast: true, position: 'bottom', icon: icon, title: title, showConfirmButton: false, timer: 3000, timerProgressBar: true });
                    },
                    
                    _handleTabClick(button) {
                        const parentSidebar = button.closest('.sidebar');
                        parentSidebar.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        parentSidebar.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                        document.getElementById(button.dataset.tab).classList.add('active');
                    },
                    _handleMobileNav(button) {
                        const view = button.dataset.view;
                        
                        this.dom.mobileNavButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');

                        this.dom.mobileViewContents.forEach(content => {
                           content.style.display = 'none'; // Use display none for instant switch
                           content.classList.remove('active');
                        });
                        const targetView = document.getElementById(view);
                        if(targetView) {
                            targetView.style.display = 'flex'; // Set display flex
                            targetView.classList.add('active');
                        }

                        if (view === 'mobile-calendar-view' || view === 'mobile-my-schedule-view') {
                            this.dom.mobileHeaderTitle.textContent = this.state.schedules[this.state.activeScheduleIndex]?.name || 'الجدول';
                        } else if (view === 'mobile-courses-view') {
                            this.dom.mobileHeaderTitle.textContent = 'المقررات';
                        }
                        
                        setTimeout(() => this.state.calendar.updateSize(), 50); // Ensure calendar resizes
                    },
                    _updateBookmarkletCode() {
                        document.getElementById('install-section').innerHTML = `<h3>طريقة التثبيت</h3><p>اسحب هذا الزر إلى شريط الإشارات المرجعية:</p><a class="bookmarklet-button" href="javascript:!function(){var e=document.createElement('script');e.src='${this.constants.EXTRACTOR_URL}?v='+Date.now(),document.head.appendChild(e)}();" onclick="Swal.fire({title:'خطأ!', text:'لا تضغط على الزر، بل قم بسحبه إلى شريط الإشارات المرجعية في متصفحك.', icon:'error'}); return false;">QU Schedule</a>`;
                    },
                    _initializeCalendar() {
                        if (this.state.calendar) this.state.calendar.destroy();
                        const calendarEl = document.getElementById(isMobile ? 'mobile-calendar' : 'calendar');
                        const calendarOptions = {
                            initialView: 'timeGridWeek', 
                            locale: 'ar', 
                            headerToolbar: false, // This removes the date title
                            allDaySlot: false, 
                            events: [], 
                            dir: 'rtl',
                            dayHeaderFormat: { weekday: isMobile ? 'short' : 'long' }, 
                            slotMinTime: this.state.userSettings.minTime, 
                            slotMaxTime: this.state.userSettings.maxTime,
                            hiddenDays: this.state.userSettings.showWeekends ? [] : [5, 6], 
                            nowIndicator: false,
                            dayCellDidMount: (arg) => { if (arg.isToday) arg.el.style.backgroundColor = 'transparent'; },
                            eventContent: (arg) => {
                                const props = arg.event.extendedProps;
                                const wrapper = document.createElement('div');
                                wrapper.style.cssText = 'display: flex; flex-direction: column; height: 100%; overflow: hidden; font-size: 0.8rem; line-height: 1.4;';
                                wrapper.innerHTML = `<b style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: var(--font-title); font-weight: 400;">${arg.event.title.split('(')[0].trim()}</b><small>${props.section} - ${props.instructor}</small><small style="margin-top: auto;"><i class="ri-map-pin-line"></i> ${props.location}</small>`;
                                return { domNodes: [wrapper] };
                            },
                            windowResize: () => { this.state.calendar.updateSize(); }
                        };
                        this.state.calendar = new FullCalendar.Calendar(calendarEl, calendarOptions);
                        this.state.calendar.render();
                    },

                    _addSchedule(name, isDefault = false) {
                        const scheduleName = name || `جدول ${this.state.schedules.length + 1}`;
                        this.state.schedules.push({ name: scheduleName, sections: new Set(), linkedSections: new Map() });
                        if(!isDefault){
                            this.state.activeScheduleIndex = this.state.schedules.length - 1;
                            this.updateFullUI();
                        }
                    },

                    _switchSchedule(index) {
                        if (index !== this.state.activeScheduleIndex) {
                            this.state.activeScheduleIndex = index;
                            this.updateFullUI();
                        }
                    },
                    _deleteSchedule(index) {
                        const scheduleName = this.state.schedules[index].name;
                        Swal.fire({
                            title: `حذف "${scheduleName}"؟`, text: "لا يمكن التراجع عن هذا الإجراء.", icon: 'warning',
                            showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'نعم، احذفه!', cancelButtonText: 'إلغاء'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                this.state.schedules.splice(index, 1);
                                if (this.state.activeScheduleIndex >= index) {
                                    this.state.activeScheduleIndex = Math.max(0, this.state.activeScheduleIndex - 1);
                                }
                                if(this.state.schedules.length === 0){ this._addSchedule("جدول 1", true); }
                                this.updateFullUI();
                                this._showToast('success', 'تم حذف الجدول');
                            }
                        });
                    },
                    _renameSchedule(index, newName) {
                        const trimmedName = newName.trim();
                        if (trimmedName) {
                            this.state.schedules[index].name = trimmedName;
                            this._saveSchedules();
                            if (isMobile) this._updateMobileHeader();
                        } else {
                            // Revert to old name if new name is empty
                            const tabNameSpan = document.querySelector(`.schedule-tab[data-index='${index}'] .schedule-tab-name`);
                            if(tabNameSpan) tabNameSpan.textContent = this.state.schedules[index].name;
                        }
                    },
                    _updateMobileHeader() {
                        const activeNavBtn = document.querySelector('.mobile-nav-btn.active');
                        if (!activeNavBtn) return;
                        
                        const currentView = activeNavBtn.dataset.view;
                        if (currentView === 'mobile-calendar-view' || currentView === 'mobile-my-schedule-view') {
                            this.dom.mobileHeaderTitle.textContent = this.state.schedules[this.state.activeScheduleIndex]?.name || 'الجدول';
                        } else if (currentView === 'mobile-courses-view') {
                             this.dom.mobileHeaderTitle.textContent = 'المقررات';
                        }
                    },
                    _adjustColorBrightness(hex, p) {
                        let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                        p /= 100;
                        r = Math.round(Math.min(255, Math.max(0, r * (1 + p))));
                        g = Math.round(Math.min(255, Math.max(0, g * (1 + p))));
                        b = Math.round(Math.min(255, Math.max(0, b * (1 + p))));
                        return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
                    },
                    _hexToRgb(hex) {
                        let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                        return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '139, 92, 246';
                    },
                    _hexToHue(H) {
                        if (!H) return 257;
                        let r = 0, g = 0, b = 0;
                        if (H.length == 7) { r = parseInt("0x" + H.substring(1,3)); g = parseInt("0x" + H.substring(3,5)); b = parseInt("0x" + H.substring(5,7)); }
                        r /= 255; g /= 255; b /= 255;
                        let cmin = Math.min(r, g, b), cmax = Math.max(r, g, b), delta = cmax - cmin, h = 0;
                        if (delta == 0) h = 0;
                        else if (cmax == r) h = ((g - b) / delta) % 6;
                        else if (cmax == g) h = (b - r) / delta + 2;
                        else h = (r - g) / delta + 4;
                        h = Math.round(h * 60);
                        if (h < 0) h += 360;
                        return h;
                    },
                    _loadSettings() {
                        const saved = localStorage.getItem(this.constants.STORAGE_KEYS.SETTINGS);
                        if (saved) {
                            try {
                                this.state.userSettings = { ...this.state.userSettings, ...JSON.parse(saved) };
                                this.state.hiddenCourseCodes = new Set(this.state.userSettings.hiddenCourseCodes || []);
                            } catch (e) {}
                        }
                        this._applySettings();
                    },
                    _saveSettings() {
                        this.state.userSettings.hiddenCourseCodes = Array.from(this.state.hiddenCourseCodes);
                        localStorage.setItem(this.constants.STORAGE_KEYS.SETTINGS, JSON.stringify(this.state.userSettings));
                    },
                    _buildSettingsModal() {
                        const modal = this.dom.settingsModal;
                        let courseColorsHTML = Object.values(this.state.groupedCourses).sort( (a, b) => a.code.localeCompare(b.code)).map(group => `<div class="settings-item"><div class="settings-item-label"><span style="color: ${group.color}; font-weight: 600;">${group.name} (${group.code})</span></div><label class="color-picker-label" style="background-color: ${group.color};"><input type="color" class="color-picker-input" data-course-code="${group.code}" value="${group.color}"></label></div>`).join('');
                        if (!courseColorsHTML) courseColorsHTML = '<p style="color: var(--color-text-muted); font-size: 0.9rem;">لم يتم تحميل بيانات المقررات بعد.</p>';
                        let courseVisibilityHTML = Object.values(this.state.groupedCourses).sort( (a, b) => a.code.localeCompare(b.code)).map(group => {
                            const isHidden = this.state.hiddenCourseCodes.has(group.code);
                            const rgb = this._hexToRgb(group.color);
                            return `<button class="course-visibility-btn ${isHidden ? 'hidden' : 'visible'}" data-course-code="${group.code}" style="--item-color: ${group.color}; --item-color-rgb: ${rgb};"><span class="color-dot"></span>${group.code}</button>`;
                        }).join('');
                        if (!courseVisibilityHTML) courseVisibilityHTML = '<p style="color: var(--color-text-muted); font-size: 0.9rem;">لم يتم تحميل بيانات المقررات بعد.</p>';
                        
                        modal.innerHTML = `
                            <div class="modal-header"><h3><i class="ri-settings-3-line"></i> الإعدادات</h3><i class="ri-close-line modal-close-btn" id="close-modal-btn"></i></div>
                            <div class="modal-content custom-scrollbar">
                                <div class="settings-group"><h4 class="settings-group-title"><i class="ri-palette-line"></i>المظهر</h4><div class="settings-item"><div class="settings-item-label"><span>الوضع</span></div><div class="mode-toggle"></div></div><div class="settings-item"><div class="settings-item-label"><span>اللون الأساسي</span></div><div class="theme-picker" id="accent-color-picker"></div></div></div>
                                <div class="settings-group"><h4 class="settings-group-title"><i class="ri-filter-3-line"></i>ترشيح المقررات</h4><div class="settings-item"><div class="settings-item-label"><span>إخفاء الشعب المغلقة</span><small>لإزالة الشعب غير المتاحة من القائمة</small></div><label class="toggle-switch"><input type="checkbox" id="hide-closed-toggle"><span class="slider"></span></label></div><h4 class="settings-group-title" style="margin-top: 2rem;"><i class="ri-eye-off-line"></i>التحكم في ظهور المقررات</h4><div id="course-visibility-list" class="course-visibility-grid">${courseVisibilityHTML}</div></div>
                                <div class="settings-group"><h4 class="settings-group-title"><i class="ri-paint-brush-line"></i>ألوان المقررات</h4><div id="course-colors-list">${courseColorsHTML}</div></div>
                                <div class="settings-group"><h4 class="settings-group-title"><i class="ri-calendar-2-line"></i>عرض التقويم</h4><div class="settings-item"><div class="settings-item-label"><span>إظهار عطلة نهاية الأسبوع</span><small>لعرض يومي الجمعة والسبت</small></div><label class="toggle-switch"><input type="checkbox" id="show-weekend-toggle"><span class="slider"></span></label></div><div class="settings-item"><div class="settings-item-label"><span>نطاق الساعات</span></div><div class="time-range-selects"><div id="min-time-select-container"></div><div id="max-time-select-container"></div></div></div></div>
                                <div class="settings-group"><h4 class="settings-group-title"><i class="ri-database-2-line"></i>إدارة البيانات</h4><div class="data-management-zone"><button class="data-btn" id="export-btn"><i class="ri-download-cloud-2-line"></i>تصدير الجدول الحالي</button><button class="data-btn" id="import-btn"><i class="ri-upload-cloud-2-line"></i>استيراد جدول</button><input type="file" id="import-file-input" accept=".json" style="display: none;"><button class="data-btn danger" id="reset-app-btn"><i class="ri-restart-line"></i>إعادة تعيين التطبيق</button></div></div>
                            </div>`;
                        this._attachModalEventListeners();
                        this._populateTimeSelects();
                        this._applySettings();
                    },
                    _attachModalEventListeners() {
                        this.dom.settingsModal.querySelector('#close-modal-btn').addEventListener('click', () => this._toggleSettingsModal(false));
                        this.dom.settingsModal.querySelector('#course-colors-list').addEventListener('change', e => this._handleCourseColorChange(e));
                        this.dom.settingsModal.querySelector('#course-visibility-list').addEventListener('click', e => this._handleVisibilityToggle(e));
                        this.dom.settingsModal.querySelector('#export-btn').addEventListener('click', () => this._handleExport());
                        this.dom.settingsModal.querySelector('#import-btn').addEventListener('click', () => this.dom.settingsModal.querySelector('#import-file-input').click());
                        this.dom.settingsModal.querySelector('#import-file-input').addEventListener('change', e => this._handleImport(e));
                        this.dom.settingsModal.querySelector('#reset-app-btn').addEventListener('click', () => this._handleReset());
                    },
                    _handleCourseColorChange(event) {
                        if (event.target.matches('.color-picker-input')) {
                            const code = event.target.dataset.courseCode;
                            const newColor = event.target.value;
                            this.state.customColors[code] = newColor;
                            if (this.state.groupedCourses[code]) this.state.groupedCourses[code].color = newColor;
                            this._saveCustomColors();
                            this.updateFullUI();
                            this._buildSettingsModal();
                        }
                    },
                    _handleVisibilityToggle(event) {
                        const btn = event.target.closest('.course-visibility-btn');
                        if (!btn) return;
                        const code = btn.dataset.courseCode;
                        if (this.state.hiddenCourseCodes.has(code)) {
                            this.state.hiddenCourseCodes.delete(code);
                            btn.classList.remove('hidden'); btn.classList.add('visible');
                        } else {
                            this.state.hiddenCourseCodes.add(code);
                            btn.classList.add('hidden'); btn.classList.remove('visible');
                        }
                        this._saveSettings();
                        this._renderCoursesList();
                    },
                    _handleExport() {
                        const activeSchedule = this.state.schedules[this.state.activeScheduleIndex];
                        if (!activeSchedule || activeSchedule.sections.size === 0) {
                            Swal.fire('الجدول الحالي فارغ!', 'الرجاء اختيار بعض الشعب أولاً.', 'warning');
                            return;
                        }
                        const dataStr = JSON.stringify({ 
                            version: 20, 
                            schedule: Array.from(activeSchedule.sections), 
                            linked: Array.from(activeSchedule.linkedSections.entries()).map(([key, value]) => [key, Array.from(value)]) 
                        });
                        const dataBlob = new Blob([dataStr],{ type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const a = document.createElement('a');
                        a.href = url;
                        const safeName = activeSchedule.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                        a.download = `qu_schedule_${safeName}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                    },
                    _handleImport(e) {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            try {
                                const data = JSON.parse(event.target.result);
                                if (data && data.schedule && Array.isArray(data.schedule)) {
                                    const newName = `مستورد ${new Date().toLocaleTimeString('ar-SA')}`;
                                    this._addSchedule(newName, false);
                                    const newSchedule = this.state.schedules[this.state.activeScheduleIndex];
                                    data.schedule.forEach(id => {
                                        if (this.state.allCoursesData.some(c => c.uniqueId === id)) {
                                            newSchedule.sections.add(id);
                                        }
                                    });
                                    if(data.linked && Array.isArray(data.linked)) {
                                        newSchedule.linkedSections = new Map(data.linked.map(([key, val]) => [key, new Set(val)]));
                                    }
                                    this.updateFullUI();
                                    this._toggleSettingsModal(false);
                                    this._showToast('success', 'تم استيراد الجدول بنجاح!');
                                } else { throw new Error('Invalid file format'); }
                            } catch (error) { Swal.fire('خطأ!', 'ملف غير صالح. تأكد من أنه ملف جدول تم تصديره من هذه الأداة.', 'error'); }
                        };
                        reader.readAsText(file);
                        e.target.value = '';
                    },
                    _handleReset() {
                        Swal.fire({
                            title: 'هل أنت متأكد؟', text: "سيؤدي هذا إلى مسح جميع بيانات التطبيق المحفوظة.", icon: 'warning',
                            showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'نعم، إعادة تعيين!', cancelButtonText: 'إلغاء'
                        }).then((result) => { if (result.isConfirmed) { localStorage.clear(); location.reload(); } });
                    },
                    _toggleSettingsModal(show) {
                        this.dom.modalOverlay.classList.toggle('open', show);
                        this.dom.settingsModal.classList.toggle('open', show);
                    },
                    _applySettings() {
                        document.body.className = this.state.userSettings.theme === 'light' ? 'light' : '';
                        if(isMobile) document.body.classList.add('mobile-view');
                        
                        const primaryColor = this.state.userSettings.accentColor;
                        document.documentElement.style.setProperty('--color-primary', primaryColor);
                        document.documentElement.style.setProperty('--color-primary-dark', this._adjustColorBrightness(primaryColor, -10));
                        document.documentElement.style.setProperty('--rgb-primary', this._hexToRgb(primaryColor));
                        const primaryHue = this._hexToHue(primaryColor);
                        document.documentElement.style.setProperty('--primary-hue', String(primaryHue));
                        document.documentElement.style.setProperty('--secondary-hue', String((primaryHue + 40) % 360));

                        const modeToggle = this.dom.settingsModal.querySelector('.mode-toggle');
                        if (modeToggle) {
                            modeToggle.innerHTML = `<button class="mode-btn ${this.state.userSettings.theme === 'dark' ? 'active' : ''}" data-theme="dark">ظلام</button><button class="mode-btn ${this.state.userSettings.theme === 'light' ? 'active' : ''}" data-theme="light">نهار</button>`;
                            modeToggle.onclick = e => { if (e.target.matches('.mode-btn')) { this.state.userSettings.theme = e.target.dataset.theme; this._saveSettings(); this._applySettings(); } };
                        }
                        this._populateAccentColorPicker();
                        const showWeekendToggle = this.dom.settingsModal.querySelector('#show-weekend-toggle');
                        if (showWeekendToggle) {
                            showWeekendToggle.checked = this.state.userSettings.showWeekends;
                            showWeekendToggle.onchange = (e) => { this.state.userSettings.showWeekends = e.target.checked; this._saveSettings(); this._initializeCalendar(); this.updateCalendarAndConflicts(); };
                        }
                        const hideClosedToggle = this.dom.settingsModal.querySelector('#hide-closed-toggle');
                        if (hideClosedToggle) {
                            hideClosedToggle.checked = this.state.userSettings.hideClosedCourses;
                            hideClosedToggle.onchange = (e) => { this.state.userSettings.hideClosedCourses = e.target.checked; this._saveSettings(); this._renderCoursesList(); };
                        }
                    },
                    _populateAccentColorPicker() {
                        const picker = this.dom.settingsModal.querySelector('#accent-color-picker');
                        if (!picker) return;
                        picker.innerHTML = '';
                        Object.values(this.constants.PRESET_COLORS).forEach(color => {
                            const dot = document.createElement('div');
                            dot.className = `theme-dot ${this.state.userSettings.accentColor === color ? 'active' : ''}`;
                            dot.style.backgroundColor = color;
                            dot.onclick = () => { this.state.userSettings.accentColor = color; this._saveSettings(); this._applySettings(); };
                            picker.appendChild(dot);
                        });
                        const isCustom = !Object.values(this.constants.PRESET_COLORS).includes(this.state.userSettings.accentColor);
                        const customLabel = document.createElement('label');
                        customLabel.className = `color-picker-label ${isCustom ? 'active' : ''}`;
                        customLabel.style.backgroundColor = isCustom ? this.state.userSettings.accentColor : 'transparent';
                        customLabel.innerHTML = `<input type="color" class="color-picker-input" value="${this.state.userSettings.accentColor}">`;
                        customLabel.querySelector('input').onchange = (e) => { this.state.userSettings.accentColor = e.target.value; this._saveSettings(); this._applySettings(); };
                        picker.appendChild(customLabel);
                    },
                    _populateTimeSelects() {
                        const minContainer = this.dom.settingsModal.querySelector('#min-time-select-container');
                        const maxContainer = this.dom.settingsModal.querySelector('#max-time-select-container');
                        if (!minContainer || !maxContainer) return;
                        const timeOptions = Array.from({ length: 24 }, (_, i) => ({ value: `${String(i).padStart(2, '0')}:00:00`, label: `${String(i).padStart(2, '0')}:00` }));
                        this._createActionPicker(minContainer, timeOptions, this.state.userSettings.minTime, (newVal) => { this.state.userSettings.minTime = newVal; this._saveSettings(); this._initializeCalendar(); this.updateCalendarAndConflicts(); });
                        this._createActionPicker(maxContainer, timeOptions, this.state.userSettings.maxTime, (newVal) => { this.state.userSettings.maxTime = newVal; this._saveSettings(); this._initializeCalendar(); this.updateCalendarAndConflicts(); });
                    },
                    _createActionPicker(container, options, initialValue, onChange) {
                        container.innerHTML = '';
                        let isOpen = false;
                        const wrapper = document.createElement('div');
                        wrapper.className = 'action-picker-wrapper';
                        const selectedOption = options.find(opt => opt.value === initialValue) || options[0];
                        const display = document.createElement('button');
                        display.type = 'button'; display.className = 'action-picker-display'; display.textContent = selectedOption.label;
                        const panel = document.createElement('div');
                        panel.className = 'action-picker-panel'; panel.style.display = 'none';
                        options.forEach(option => {
                            const btn = document.createElement('button');
                            btn.type = 'button'; btn.className = `action-picker-option ${initialValue === option.value ? 'selected' : ''}`; btn.textContent = option.label;
                            btn.onclick = () => { onChange(option.value); display.textContent = option.label; panel.querySelectorAll('.selected').forEach(el => el.classList.remove('selected')); btn.classList.add('selected'); closePanel(); };
                            panel.appendChild(btn);
                        });
                        const openPanel = () => { isOpen = true; panel.style.display = 'block'; };
                        const closePanel = () => { isOpen = false; panel.style.display = 'none'; };
                        display.onclick = () => isOpen ? closePanel() : openPanel();
                        wrapper.appendChild(display); wrapper.appendChild(panel); container.appendChild(wrapper);
                        document.addEventListener('click', (e) => { if (!wrapper.contains(e.target)) closePanel(); });
                    }
                });

                QU_ScheduleApp.init();
            });
        </script>
    </body>
</html>
